<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>tango.net.util.PKI</title>
  <style type="text/css">
  .linescolumn > a { display: block; }
  td { vertical-align: top; }
  </style>
  <link href="html.css" rel="stylesheet" type="text/css">
</head>
<body>
<table><tr><td class="linescolumn"><a id="L1" href="#L1">1</a><a id="L2" href="#L2">2</a><a id="L3" href="#L3">3</a><a id="L4" href="#L4">4</a><a id="L5" href="#L5">5</a><a id="L6" href="#L6">6</a><a id="L7" href="#L7">7</a><a id="L8" href="#L8">8</a><a id="L9" href="#L9">9</a><a id="L10" href="#L10">10</a><a id="L11" href="#L11">11</a><a id="L12" href="#L12">12</a><a id="L13" href="#L13">13</a><a id="L14" href="#L14">14</a><a id="L15" href="#L15">15</a><a id="L16" href="#L16">16</a><a id="L17" href="#L17">17</a><a id="L18" href="#L18">18</a><a id="L19" href="#L19">19</a><a id="L20" href="#L20">20</a><a id="L21" href="#L21">21</a><a id="L22" href="#L22">22</a><a id="L23" href="#L23">23</a><a id="L24" href="#L24">24</a><a id="L25" href="#L25">25</a><a id="L26" href="#L26">26</a><a id="L27" href="#L27">27</a><a id="L28" href="#L28">28</a><a id="L29" href="#L29">29</a><a id="L30" href="#L30">30</a><a id="L31" href="#L31">31</a><a id="L32" href="#L32">32</a><a id="L33" href="#L33">33</a><a id="L34" href="#L34">34</a><a id="L35" href="#L35">35</a><a id="L36" href="#L36">36</a><a id="L37" href="#L37">37</a><a id="L38" href="#L38">38</a><a id="L39" href="#L39">39</a><a id="L40" href="#L40">40</a><a id="L41" href="#L41">41</a><a id="L42" href="#L42">42</a><a id="L43" href="#L43">43</a><a id="L44" href="#L44">44</a><a id="L45" href="#L45">45</a><a id="L46" href="#L46">46</a><a id="L47" href="#L47">47</a><a id="L48" href="#L48">48</a><a id="L49" href="#L49">49</a><a id="L50" href="#L50">50</a><a id="L51" href="#L51">51</a><a id="L52" href="#L52">52</a><a id="L53" href="#L53">53</a><a id="L54" href="#L54">54</a><a id="L55" href="#L55">55</a><a id="L56" href="#L56">56</a><a id="L57" href="#L57">57</a><a id="L58" href="#L58">58</a><a id="L59" href="#L59">59</a><a id="L60" href="#L60">60</a><a id="L61" href="#L61">61</a><a id="L62" href="#L62">62</a><a id="L63" href="#L63">63</a><a id="L64" href="#L64">64</a><a id="L65" href="#L65">65</a><a id="L66" href="#L66">66</a><a id="L67" href="#L67">67</a><a id="L68" href="#L68">68</a><a id="L69" href="#L69">69</a><a id="L70" href="#L70">70</a><a id="L71" href="#L71">71</a><a id="L72" href="#L72">72</a><a id="L73" href="#L73">73</a><a id="L74" href="#L74">74</a><a id="L75" href="#L75">75</a><a id="L76" href="#L76">76</a><a id="L77" href="#L77">77</a><a id="L78" href="#L78">78</a><a id="L79" href="#L79">79</a><a id="L80" href="#L80">80</a><a id="L81" href="#L81">81</a><a id="L82" href="#L82">82</a><a id="L83" href="#L83">83</a><a id="L84" href="#L84">84</a><a id="L85" href="#L85">85</a><a id="L86" href="#L86">86</a><a id="L87" href="#L87">87</a><a id="L88" href="#L88">88</a><a id="L89" href="#L89">89</a><a id="L90" href="#L90">90</a><a id="L91" href="#L91">91</a><a id="L92" href="#L92">92</a><a id="L93" href="#L93">93</a><a id="L94" href="#L94">94</a><a id="L95" href="#L95">95</a><a id="L96" href="#L96">96</a><a id="L97" href="#L97">97</a><a id="L98" href="#L98">98</a><a id="L99" href="#L99">99</a><a id="L100" href="#L100">100</a><a id="L101" href="#L101">101</a><a id="L102" href="#L102">102</a><a id="L103" href="#L103">103</a><a id="L104" href="#L104">104</a><a id="L105" href="#L105">105</a><a id="L106" href="#L106">106</a><a id="L107" href="#L107">107</a><a id="L108" href="#L108">108</a><a id="L109" href="#L109">109</a><a id="L110" href="#L110">110</a><a id="L111" href="#L111">111</a><a id="L112" href="#L112">112</a><a id="L113" href="#L113">113</a><a id="L114" href="#L114">114</a><a id="L115" href="#L115">115</a><a id="L116" href="#L116">116</a><a id="L117" href="#L117">117</a><a id="L118" href="#L118">118</a><a id="L119" href="#L119">119</a><a id="L120" href="#L120">120</a><a id="L121" href="#L121">121</a><a id="L122" href="#L122">122</a><a id="L123" href="#L123">123</a><a id="L124" href="#L124">124</a><a id="L125" href="#L125">125</a><a id="L126" href="#L126">126</a><a id="L127" href="#L127">127</a><a id="L128" href="#L128">128</a><a id="L129" href="#L129">129</a><a id="L130" href="#L130">130</a><a id="L131" href="#L131">131</a><a id="L132" href="#L132">132</a><a id="L133" href="#L133">133</a><a id="L134" href="#L134">134</a><a id="L135" href="#L135">135</a><a id="L136" href="#L136">136</a><a id="L137" href="#L137">137</a><a id="L138" href="#L138">138</a><a id="L139" href="#L139">139</a><a id="L140" href="#L140">140</a><a id="L141" href="#L141">141</a><a id="L142" href="#L142">142</a><a id="L143" href="#L143">143</a><a id="L144" href="#L144">144</a><a id="L145" href="#L145">145</a><a id="L146" href="#L146">146</a><a id="L147" href="#L147">147</a><a id="L148" href="#L148">148</a><a id="L149" href="#L149">149</a><a id="L150" href="#L150">150</a><a id="L151" href="#L151">151</a><a id="L152" href="#L152">152</a><a id="L153" href="#L153">153</a><a id="L154" href="#L154">154</a><a id="L155" href="#L155">155</a><a id="L156" href="#L156">156</a><a id="L157" href="#L157">157</a><a id="L158" href="#L158">158</a><a id="L159" href="#L159">159</a><a id="L160" href="#L160">160</a><a id="L161" href="#L161">161</a><a id="L162" href="#L162">162</a><a id="L163" href="#L163">163</a><a id="L164" href="#L164">164</a><a id="L165" href="#L165">165</a><a id="L166" href="#L166">166</a><a id="L167" href="#L167">167</a><a id="L168" href="#L168">168</a><a id="L169" href="#L169">169</a><a id="L170" href="#L170">170</a><a id="L171" href="#L171">171</a><a id="L172" href="#L172">172</a><a id="L173" href="#L173">173</a><a id="L174" href="#L174">174</a><a id="L175" href="#L175">175</a><a id="L176" href="#L176">176</a><a id="L177" href="#L177">177</a><a id="L178" href="#L178">178</a><a id="L179" href="#L179">179</a><a id="L180" href="#L180">180</a><a id="L181" href="#L181">181</a><a id="L182" href="#L182">182</a><a id="L183" href="#L183">183</a><a id="L184" href="#L184">184</a><a id="L185" href="#L185">185</a><a id="L186" href="#L186">186</a><a id="L187" href="#L187">187</a><a id="L188" href="#L188">188</a><a id="L189" href="#L189">189</a><a id="L190" href="#L190">190</a><a id="L191" href="#L191">191</a><a id="L192" href="#L192">192</a><a id="L193" href="#L193">193</a><a id="L194" href="#L194">194</a><a id="L195" href="#L195">195</a><a id="L196" href="#L196">196</a><a id="L197" href="#L197">197</a><a id="L198" href="#L198">198</a><a id="L199" href="#L199">199</a><a id="L200" href="#L200">200</a><a id="L201" href="#L201">201</a><a id="L202" href="#L202">202</a><a id="L203" href="#L203">203</a><a id="L204" href="#L204">204</a><a id="L205" href="#L205">205</a><a id="L206" href="#L206">206</a><a id="L207" href="#L207">207</a><a id="L208" href="#L208">208</a><a id="L209" href="#L209">209</a><a id="L210" href="#L210">210</a><a id="L211" href="#L211">211</a><a id="L212" href="#L212">212</a><a id="L213" href="#L213">213</a><a id="L214" href="#L214">214</a><a id="L215" href="#L215">215</a><a id="L216" href="#L216">216</a><a id="L217" href="#L217">217</a><a id="L218" href="#L218">218</a><a id="L219" href="#L219">219</a><a id="L220" href="#L220">220</a><a id="L221" href="#L221">221</a><a id="L222" href="#L222">222</a><a id="L223" href="#L223">223</a><a id="L224" href="#L224">224</a><a id="L225" href="#L225">225</a><a id="L226" href="#L226">226</a><a id="L227" href="#L227">227</a><a id="L228" href="#L228">228</a><a id="L229" href="#L229">229</a><a id="L230" href="#L230">230</a><a id="L231" href="#L231">231</a><a id="L232" href="#L232">232</a><a id="L233" href="#L233">233</a><a id="L234" href="#L234">234</a><a id="L235" href="#L235">235</a><a id="L236" href="#L236">236</a><a id="L237" href="#L237">237</a><a id="L238" href="#L238">238</a><a id="L239" href="#L239">239</a><a id="L240" href="#L240">240</a><a id="L241" href="#L241">241</a><a id="L242" href="#L242">242</a><a id="L243" href="#L243">243</a><a id="L244" href="#L244">244</a><a id="L245" href="#L245">245</a><a id="L246" href="#L246">246</a><a id="L247" href="#L247">247</a><a id="L248" href="#L248">248</a><a id="L249" href="#L249">249</a><a id="L250" href="#L250">250</a><a id="L251" href="#L251">251</a><a id="L252" href="#L252">252</a><a id="L253" href="#L253">253</a><a id="L254" href="#L254">254</a><a id="L255" href="#L255">255</a><a id="L256" href="#L256">256</a><a id="L257" href="#L257">257</a><a id="L258" href="#L258">258</a><a id="L259" href="#L259">259</a><a id="L260" href="#L260">260</a><a id="L261" href="#L261">261</a><a id="L262" href="#L262">262</a><a id="L263" href="#L263">263</a><a id="L264" href="#L264">264</a><a id="L265" href="#L265">265</a><a id="L266" href="#L266">266</a><a id="L267" href="#L267">267</a><a id="L268" href="#L268">268</a><a id="L269" href="#L269">269</a><a id="L270" href="#L270">270</a><a id="L271" href="#L271">271</a><a id="L272" href="#L272">272</a><a id="L273" href="#L273">273</a><a id="L274" href="#L274">274</a><a id="L275" href="#L275">275</a><a id="L276" href="#L276">276</a><a id="L277" href="#L277">277</a><a id="L278" href="#L278">278</a><a id="L279" href="#L279">279</a><a id="L280" href="#L280">280</a><a id="L281" href="#L281">281</a><a id="L282" href="#L282">282</a><a id="L283" href="#L283">283</a><a id="L284" href="#L284">284</a><a id="L285" href="#L285">285</a><a id="L286" href="#L286">286</a><a id="L287" href="#L287">287</a><a id="L288" href="#L288">288</a><a id="L289" href="#L289">289</a><a id="L290" href="#L290">290</a><a id="L291" href="#L291">291</a><a id="L292" href="#L292">292</a><a id="L293" href="#L293">293</a><a id="L294" href="#L294">294</a><a id="L295" href="#L295">295</a><a id="L296" href="#L296">296</a><a id="L297" href="#L297">297</a><a id="L298" href="#L298">298</a><a id="L299" href="#L299">299</a><a id="L300" href="#L300">300</a><a id="L301" href="#L301">301</a><a id="L302" href="#L302">302</a><a id="L303" href="#L303">303</a><a id="L304" href="#L304">304</a><a id="L305" href="#L305">305</a><a id="L306" href="#L306">306</a><a id="L307" href="#L307">307</a><a id="L308" href="#L308">308</a><a id="L309" href="#L309">309</a><a id="L310" href="#L310">310</a><a id="L311" href="#L311">311</a><a id="L312" href="#L312">312</a><a id="L313" href="#L313">313</a><a id="L314" href="#L314">314</a><a id="L315" href="#L315">315</a><a id="L316" href="#L316">316</a><a id="L317" href="#L317">317</a><a id="L318" href="#L318">318</a><a id="L319" href="#L319">319</a><a id="L320" href="#L320">320</a><a id="L321" href="#L321">321</a><a id="L322" href="#L322">322</a><a id="L323" href="#L323">323</a><a id="L324" href="#L324">324</a><a id="L325" href="#L325">325</a><a id="L326" href="#L326">326</a><a id="L327" href="#L327">327</a><a id="L328" href="#L328">328</a><a id="L329" href="#L329">329</a><a id="L330" href="#L330">330</a><a id="L331" href="#L331">331</a><a id="L332" href="#L332">332</a><a id="L333" href="#L333">333</a><a id="L334" href="#L334">334</a><a id="L335" href="#L335">335</a><a id="L336" href="#L336">336</a><a id="L337" href="#L337">337</a><a id="L338" href="#L338">338</a><a id="L339" href="#L339">339</a><a id="L340" href="#L340">340</a><a id="L341" href="#L341">341</a><a id="L342" href="#L342">342</a><a id="L343" href="#L343">343</a><a id="L344" href="#L344">344</a><a id="L345" href="#L345">345</a><a id="L346" href="#L346">346</a><a id="L347" href="#L347">347</a><a id="L348" href="#L348">348</a><a id="L349" href="#L349">349</a><a id="L350" href="#L350">350</a><a id="L351" href="#L351">351</a><a id="L352" href="#L352">352</a><a id="L353" href="#L353">353</a><a id="L354" href="#L354">354</a><a id="L355" href="#L355">355</a><a id="L356" href="#L356">356</a><a id="L357" href="#L357">357</a><a id="L358" href="#L358">358</a><a id="L359" href="#L359">359</a><a id="L360" href="#L360">360</a><a id="L361" href="#L361">361</a><a id="L362" href="#L362">362</a><a id="L363" href="#L363">363</a><a id="L364" href="#L364">364</a><a id="L365" href="#L365">365</a><a id="L366" href="#L366">366</a><a id="L367" href="#L367">367</a><a id="L368" href="#L368">368</a><a id="L369" href="#L369">369</a><a id="L370" href="#L370">370</a><a id="L371" href="#L371">371</a><a id="L372" href="#L372">372</a><a id="L373" href="#L373">373</a><a id="L374" href="#L374">374</a><a id="L375" href="#L375">375</a><a id="L376" href="#L376">376</a><a id="L377" href="#L377">377</a><a id="L378" href="#L378">378</a><a id="L379" href="#L379">379</a><a id="L380" href="#L380">380</a><a id="L381" href="#L381">381</a><a id="L382" href="#L382">382</a><a id="L383" href="#L383">383</a><a id="L384" href="#L384">384</a><a id="L385" href="#L385">385</a><a id="L386" href="#L386">386</a><a id="L387" href="#L387">387</a><a id="L388" href="#L388">388</a><a id="L389" href="#L389">389</a><a id="L390" href="#L390">390</a><a id="L391" href="#L391">391</a><a id="L392" href="#L392">392</a><a id="L393" href="#L393">393</a><a id="L394" href="#L394">394</a><a id="L395" href="#L395">395</a><a id="L396" href="#L396">396</a><a id="L397" href="#L397">397</a><a id="L398" href="#L398">398</a><a id="L399" href="#L399">399</a><a id="L400" href="#L400">400</a><a id="L401" href="#L401">401</a><a id="L402" href="#L402">402</a><a id="L403" href="#L403">403</a><a id="L404" href="#L404">404</a><a id="L405" href="#L405">405</a><a id="L406" href="#L406">406</a><a id="L407" href="#L407">407</a><a id="L408" href="#L408">408</a><a id="L409" href="#L409">409</a><a id="L410" href="#L410">410</a><a id="L411" href="#L411">411</a><a id="L412" href="#L412">412</a><a id="L413" href="#L413">413</a><a id="L414" href="#L414">414</a><a id="L415" href="#L415">415</a><a id="L416" href="#L416">416</a><a id="L417" href="#L417">417</a><a id="L418" href="#L418">418</a><a id="L419" href="#L419">419</a><a id="L420" href="#L420">420</a><a id="L421" href="#L421">421</a><a id="L422" href="#L422">422</a><a id="L423" href="#L423">423</a><a id="L424" href="#L424">424</a><a id="L425" href="#L425">425</a><a id="L426" href="#L426">426</a><a id="L427" href="#L427">427</a><a id="L428" href="#L428">428</a><a id="L429" href="#L429">429</a><a id="L430" href="#L430">430</a><a id="L431" href="#L431">431</a><a id="L432" href="#L432">432</a><a id="L433" href="#L433">433</a><a id="L434" href="#L434">434</a><a id="L435" href="#L435">435</a><a id="L436" href="#L436">436</a><a id="L437" href="#L437">437</a><a id="L438" href="#L438">438</a><a id="L439" href="#L439">439</a><a id="L440" href="#L440">440</a><a id="L441" href="#L441">441</a><a id="L442" href="#L442">442</a><a id="L443" href="#L443">443</a><a id="L444" href="#L444">444</a><a id="L445" href="#L445">445</a><a id="L446" href="#L446">446</a><a id="L447" href="#L447">447</a><a id="L448" href="#L448">448</a><a id="L449" href="#L449">449</a><a id="L450" href="#L450">450</a><a id="L451" href="#L451">451</a><a id="L452" href="#L452">452</a><a id="L453" href="#L453">453</a><a id="L454" href="#L454">454</a><a id="L455" href="#L455">455</a><a id="L456" href="#L456">456</a><a id="L457" href="#L457">457</a><a id="L458" href="#L458">458</a><a id="L459" href="#L459">459</a><a id="L460" href="#L460">460</a><a id="L461" href="#L461">461</a><a id="L462" href="#L462">462</a><a id="L463" href="#L463">463</a><a id="L464" href="#L464">464</a><a id="L465" href="#L465">465</a><a id="L466" href="#L466">466</a><a id="L467" href="#L467">467</a><a id="L468" href="#L468">468</a><a id="L469" href="#L469">469</a><a id="L470" href="#L470">470</a><a id="L471" href="#L471">471</a><a id="L472" href="#L472">472</a><a id="L473" href="#L473">473</a><a id="L474" href="#L474">474</a><a id="L475" href="#L475">475</a><a id="L476" href="#L476">476</a><a id="L477" href="#L477">477</a><a id="L478" href="#L478">478</a><a id="L479" href="#L479">479</a><a id="L480" href="#L480">480</a><a id="L481" href="#L481">481</a><a id="L482" href="#L482">482</a><a id="L483" href="#L483">483</a><a id="L484" href="#L484">484</a><a id="L485" href="#L485">485</a><a id="L486" href="#L486">486</a><a id="L487" href="#L487">487</a><a id="L488" href="#L488">488</a><a id="L489" href="#L489">489</a><a id="L490" href="#L490">490</a><a id="L491" href="#L491">491</a><a id="L492" href="#L492">492</a><a id="L493" href="#L493">493</a><a id="L494" href="#L494">494</a><a id="L495" href="#L495">495</a><a id="L496" href="#L496">496</a><a id="L497" href="#L497">497</a><a id="L498" href="#L498">498</a><a id="L499" href="#L499">499</a><a id="L500" href="#L500">500</a><a id="L501" href="#L501">501</a><a id="L502" href="#L502">502</a><a id="L503" href="#L503">503</a><a id="L504" href="#L504">504</a><a id="L505" href="#L505">505</a><a id="L506" href="#L506">506</a><a id="L507" href="#L507">507</a><a id="L508" href="#L508">508</a><a id="L509" href="#L509">509</a><a id="L510" href="#L510">510</a><a id="L511" href="#L511">511</a><a id="L512" href="#L512">512</a><a id="L513" href="#L513">513</a><a id="L514" href="#L514">514</a><a id="L515" href="#L515">515</a><a id="L516" href="#L516">516</a><a id="L517" href="#L517">517</a><a id="L518" href="#L518">518</a><a id="L519" href="#L519">519</a><a id="L520" href="#L520">520</a><a id="L521" href="#L521">521</a><a id="L522" href="#L522">522</a><a id="L523" href="#L523">523</a><a id="L524" href="#L524">524</a><a id="L525" href="#L525">525</a><a id="L526" href="#L526">526</a><a id="L527" href="#L527">527</a><a id="L528" href="#L528">528</a><a id="L529" href="#L529">529</a><a id="L530" href="#L530">530</a><a id="L531" href="#L531">531</a><a id="L532" href="#L532">532</a><a id="L533" href="#L533">533</a><a id="L534" href="#L534">534</a><a id="L535" href="#L535">535</a><a id="L536" href="#L536">536</a><a id="L537" href="#L537">537</a><a id="L538" href="#L538">538</a><a id="L539" href="#L539">539</a><a id="L540" href="#L540">540</a><a id="L541" href="#L541">541</a><a id="L542" href="#L542">542</a><a id="L543" href="#L543">543</a><a id="L544" href="#L544">544</a><a id="L545" href="#L545">545</a><a id="L546" href="#L546">546</a><a id="L547" href="#L547">547</a><a id="L548" href="#L548">548</a><a id="L549" href="#L549">549</a><a id="L550" href="#L550">550</a><a id="L551" href="#L551">551</a><a id="L552" href="#L552">552</a><a id="L553" href="#L553">553</a><a id="L554" href="#L554">554</a><a id="L555" href="#L555">555</a><a id="L556" href="#L556">556</a><a id="L557" href="#L557">557</a><a id="L558" href="#L558">558</a><a id="L559" href="#L559">559</a><a id="L560" href="#L560">560</a><a id="L561" href="#L561">561</a><a id="L562" href="#L562">562</a><a id="L563" href="#L563">563</a><a id="L564" href="#L564">564</a><a id="L565" href="#L565">565</a><a id="L566" href="#L566">566</a><a id="L567" href="#L567">567</a><a id="L568" href="#L568">568</a><a id="L569" href="#L569">569</a><a id="L570" href="#L570">570</a><a id="L571" href="#L571">571</a><a id="L572" href="#L572">572</a><a id="L573" href="#L573">573</a><a id="L574" href="#L574">574</a><a id="L575" href="#L575">575</a><a id="L576" href="#L576">576</a><a id="L577" href="#L577">577</a><a id="L578" href="#L578">578</a><a id="L579" href="#L579">579</a><a id="L580" href="#L580">580</a><a id="L581" href="#L581">581</a><a id="L582" href="#L582">582</a><a id="L583" href="#L583">583</a><a id="L584" href="#L584">584</a><a id="L585" href="#L585">585</a><a id="L586" href="#L586">586</a><a id="L587" href="#L587">587</a><a id="L588" href="#L588">588</a><a id="L589" href="#L589">589</a><a id="L590" href="#L590">590</a><a id="L591" href="#L591">591</a><a id="L592" href="#L592">592</a><a id="L593" href="#L593">593</a><a id="L594" href="#L594">594</a><a id="L595" href="#L595">595</a><a id="L596" href="#L596">596</a><a id="L597" href="#L597">597</a><a id="L598" href="#L598">598</a><a id="L599" href="#L599">599</a><a id="L600" href="#L600">600</a><a id="L601" href="#L601">601</a><a id="L602" href="#L602">602</a><a id="L603" href="#L603">603</a><a id="L604" href="#L604">604</a><a id="L605" href="#L605">605</a><a id="L606" href="#L606">606</a><a id="L607" href="#L607">607</a><a id="L608" href="#L608">608</a><a id="L609" href="#L609">609</a><a id="L610" href="#L610">610</a><a id="L611" href="#L611">611</a><a id="L612" href="#L612">612</a><a id="L613" href="#L613">613</a><a id="L614" href="#L614">614</a><a id="L615" href="#L615">615</a><a id="L616" href="#L616">616</a><a id="L617" href="#L617">617</a><a id="L618" href="#L618">618</a><a id="L619" href="#L619">619</a><a id="L620" href="#L620">620</a><a id="L621" href="#L621">621</a><a id="L622" href="#L622">622</a><a id="L623" href="#L623">623</a><a id="L624" href="#L624">624</a><a id="L625" href="#L625">625</a><a id="L626" href="#L626">626</a><a id="L627" href="#L627">627</a><a id="L628" href="#L628">628</a><a id="L629" href="#L629">629</a><a id="L630" href="#L630">630</a><a id="L631" href="#L631">631</a><a id="L632" href="#L632">632</a><a id="L633" href="#L633">633</a><a id="L634" href="#L634">634</a><a id="L635" href="#L635">635</a><a id="L636" href="#L636">636</a><a id="L637" href="#L637">637</a><a id="L638" href="#L638">638</a><a id="L639" href="#L639">639</a><a id="L640" href="#L640">640</a><a id="L641" href="#L641">641</a><a id="L642" href="#L642">642</a><a id="L643" href="#L643">643</a><a id="L644" href="#L644">644</a><a id="L645" href="#L645">645</a><a id="L646" href="#L646">646</a><a id="L647" href="#L647">647</a><a id="L648" href="#L648">648</a><a id="L649" href="#L649">649</a><a id="L650" href="#L650">650</a><a id="L651" href="#L651">651</a><a id="L652" href="#L652">652</a><a id="L653" href="#L653">653</a><a id="L654" href="#L654">654</a><a id="L655" href="#L655">655</a><a id="L656" href="#L656">656</a><a id="L657" href="#L657">657</a><a id="L658" href="#L658">658</a><a id="L659" href="#L659">659</a><a id="L660" href="#L660">660</a><a id="L661" href="#L661">661</a><a id="L662" href="#L662">662</a><a id="L663" href="#L663">663</a><a id="L664" href="#L664">664</a><a id="L665" href="#L665">665</a><a id="L666" href="#L666">666</a><a id="L667" href="#L667">667</a><a id="L668" href="#L668">668</a><a id="L669" href="#L669">669</a><a id="L670" href="#L670">670</a><a id="L671" href="#L671">671</a><a id="L672" href="#L672">672</a><a id="L673" href="#L673">673</a><a id="L674" href="#L674">674</a><a id="L675" href="#L675">675</a><a id="L676" href="#L676">676</a><a id="L677" href="#L677">677</a><a id="L678" href="#L678">678</a><a id="L679" href="#L679">679</a><a id="L680" href="#L680">680</a><a id="L681" href="#L681">681</a><a id="L682" href="#L682">682</a><a id="L683" href="#L683">683</a><a id="L684" href="#L684">684</a><a id="L685" href="#L685">685</a><a id="L686" href="#L686">686</a><a id="L687" href="#L687">687</a><a id="L688" href="#L688">688</a><a id="L689" href="#L689">689</a><a id="L690" href="#L690">690</a><a id="L691" href="#L691">691</a><a id="L692" href="#L692">692</a><a id="L693" href="#L693">693</a><a id="L694" href="#L694">694</a><a id="L695" href="#L695">695</a><a id="L696" href="#L696">696</a><a id="L697" href="#L697">697</a><a id="L698" href="#L698">698</a><a id="L699" href="#L699">699</a><a id="L700" href="#L700">700</a><a id="L701" href="#L701">701</a><a id="L702" href="#L702">702</a><a id="L703" href="#L703">703</a><a id="L704" href="#L704">704</a><a id="L705" href="#L705">705</a><a id="L706" href="#L706">706</a><a id="L707" href="#L707">707</a><a id="L708" href="#L708">708</a><a id="L709" href="#L709">709</a><a id="L710" href="#L710">710</a><a id="L711" href="#L711">711</a><a id="L712" href="#L712">712</a><a id="L713" href="#L713">713</a><a id="L714" href="#L714">714</a><a id="L715" href="#L715">715</a><a id="L716" href="#L716">716</a><a id="L717" href="#L717">717</a><a id="L718" href="#L718">718</a><a id="L719" href="#L719">719</a><a id="L720" href="#L720">720</a><a id="L721" href="#L721">721</a><a id="L722" href="#L722">722</a><a id="L723" href="#L723">723</a><a id="L724" href="#L724">724</a><a id="L725" href="#L725">725</a><a id="L726" href="#L726">726</a><a id="L727" href="#L727">727</a><a id="L728" href="#L728">728</a><a id="L729" href="#L729">729</a><a id="L730" href="#L730">730</a><a id="L731" href="#L731">731</a><a id="L732" href="#L732">732</a><a id="L733" href="#L733">733</a><a id="L734" href="#L734">734</a><a id="L735" href="#L735">735</a><a id="L736" href="#L736">736</a><a id="L737" href="#L737">737</a><a id="L738" href="#L738">738</a><a id="L739" href="#L739">739</a><a id="L740" href="#L740">740</a><a id="L741" href="#L741">741</a><a id="L742" href="#L742">742</a><a id="L743" href="#L743">743</a><a id="L744" href="#L744">744</a><a id="L745" href="#L745">745</a><a id="L746" href="#L746">746</a><a id="L747" href="#L747">747</a><a id="L748" href="#L748">748</a><a id="L749" href="#L749">749</a><a id="L750" href="#L750">750</a><a id="L751" href="#L751">751</a><a id="L752" href="#L752">752</a><a id="L753" href="#L753">753</a><a id="L754" href="#L754">754</a><a id="L755" href="#L755">755</a><a id="L756" href="#L756">756</a><a id="L757" href="#L757">757</a><a id="L758" href="#L758">758</a><a id="L759" href="#L759">759</a><a id="L760" href="#L760">760</a><a id="L761" href="#L761">761</a><a id="L762" href="#L762">762</a><a id="L763" href="#L763">763</a><a id="L764" href="#L764">764</a><a id="L765" href="#L765">765</a><a id="L766" href="#L766">766</a><a id="L767" href="#L767">767</a><a id="L768" href="#L768">768</a><a id="L769" href="#L769">769</a><a id="L770" href="#L770">770</a><a id="L771" href="#L771">771</a><a id="L772" href="#L772">772</a><a id="L773" href="#L773">773</a><a id="L774" href="#L774">774</a><a id="L775" href="#L775">775</a><a id="L776" href="#L776">776</a><a id="L777" href="#L777">777</a><a id="L778" href="#L778">778</a><a id="L779" href="#L779">779</a><a id="L780" href="#L780">780</a><a id="L781" href="#L781">781</a><a id="L782" href="#L782">782</a><a id="L783" href="#L783">783</a><a id="L784" href="#L784">784</a><a id="L785" href="#L785">785</a><a id="L786" href="#L786">786</a><a id="L787" href="#L787">787</a><a id="L788" href="#L788">788</a><a id="L789" href="#L789">789</a><a id="L790" href="#L790">790</a><a id="L791" href="#L791">791</a><a id="L792" href="#L792">792</a><a id="L793" href="#L793">793</a><a id="L794" href="#L794">794</a><a id="L795" href="#L795">795</a><a id="L796" href="#L796">796</a><a id="L797" href="#L797">797</a><a id="L798" href="#L798">798</a><a id="L799" href="#L799">799</a><a id="L800" href="#L800">800</a><a id="L801" href="#L801">801</a><a id="L802" href="#L802">802</a><a id="L803" href="#L803">803</a><a id="L804" href="#L804">804</a><a id="L805" href="#L805">805</a><a id="L806" href="#L806">806</a><a id="L807" href="#L807">807</a><a id="L808" href="#L808">808</a><a id="L809" href="#L809">809</a><a id="L810" href="#L810">810</a><a id="L811" href="#L811">811</a><a id="L812" href="#L812">812</a><a id="L813" href="#L813">813</a><a id="L814" href="#L814">814</a><a id="L815" href="#L815">815</a><a id="L816" href="#L816">816</a><a id="L817" href="#L817">817</a><a id="L818" href="#L818">818</a><a id="L819" href="#L819">819</a><a id="L820" href="#L820">820</a><a id="L821" href="#L821">821</a><a id="L822" href="#L822">822</a><a id="L823" href="#L823">823</a><a id="L824" href="#L824">824</a><a id="L825" href="#L825">825</a><a id="L826" href="#L826">826</a><a id="L827" href="#L827">827</a><a id="L828" href="#L828">828</a><a id="L829" href="#L829">829</a><a id="L830" href="#L830">830</a><a id="L831" href="#L831">831</a><a id="L832" href="#L832">832</a><a id="L833" href="#L833">833</a><a id="L834" href="#L834">834</a><a id="L835" href="#L835">835</a><a id="L836" href="#L836">836</a><a id="L837" href="#L837">837</a><a id="L838" href="#L838">838</a><a id="L839" href="#L839">839</a><a id="L840" href="#L840">840</a><a id="L841" href="#L841">841</a><a id="L842" href="#L842">842</a><a id="L843" href="#L843">843</a><a id="L844" href="#L844">844</a><a id="L845" href="#L845">845</a><a id="L846" href="#L846">846</a><a id="L847" href="#L847">847</a><a id="L848" href="#L848">848</a><a id="L849" href="#L849">849</a><a id="L850" href="#L850">850</a><a id="L851" href="#L851">851</a><a id="L852" href="#L852">852</a><a id="L853" href="#L853">853</a><a id="L854" href="#L854">854</a><a id="L855" href="#L855">855</a><a id="L856" href="#L856">856</a><a id="L857" href="#L857">857</a><a id="L858" href="#L858">858</a><a id="L859" href="#L859">859</a><a id="L860" href="#L860">860</a><a id="L861" href="#L861">861</a><a id="L862" href="#L862">862</a><a id="L863" href="#L863">863</a><a id="L864" href="#L864">864</a><a id="L865" href="#L865">865</a><a id="L866" href="#L866">866</a><a id="L867" href="#L867">867</a><a id="L868" href="#L868">868</a><a id="L869" href="#L869">869</a><a id="L870" href="#L870">870</a><a id="L871" href="#L871">871</a><a id="L872" href="#L872">872</a><a id="L873" href="#L873">873</a><a id="L874" href="#L874">874</a><a id="L875" href="#L875">875</a><a id="L876" href="#L876">876</a><a id="L877" href="#L877">877</a><a id="L878" href="#L878">878</a><a id="L879" href="#L879">879</a><a id="L880" href="#L880">880</a><a id="L881" href="#L881">881</a><a id="L882" href="#L882">882</a><a id="L883" href="#L883">883</a><a id="L884" href="#L884">884</a><a id="L885" href="#L885">885</a><a id="L886" href="#L886">886</a><a id="L887" href="#L887">887</a><a id="L888" href="#L888">888</a><a id="L889" href="#L889">889</a><a id="L890" href="#L890">890</a><a id="L891" href="#L891">891</a><a id="L892" href="#L892">892</a><a id="L893" href="#L893">893</a><a id="L894" href="#L894">894</a><a id="L895" href="#L895">895</a><a id="L896" href="#L896">896</a><a id="L897" href="#L897">897</a><a id="L898" href="#L898">898</a><a id="L899" href="#L899">899</a><a id="L900" href="#L900">900</a><a id="L901" href="#L901">901</a><a id="L902" href="#L902">902</a><a id="L903" href="#L903">903</a><a id="L904" href="#L904">904</a><a id="L905" href="#L905">905</a><a id="L906" href="#L906">906</a><a id="L907" href="#L907">907</a><a id="L908" href="#L908">908</a><a id="L909" href="#L909">909</a><a id="L910" href="#L910">910</a><a id="L911" href="#L911">911</a><a id="L912" href="#L912">912</a><a id="L913" href="#L913">913</a><a id="L914" href="#L914">914</a><a id="L915" href="#L915">915</a><a id="L916" href="#L916">916</a><a id="L917" href="#L917">917</a><a id="L918" href="#L918">918</a><a id="L919" href="#L919">919</a><a id="L920" href="#L920">920</a><a id="L921" href="#L921">921</a><a id="L922" href="#L922">922</a><a id="L923" href="#L923">923</a><a id="L924" href="#L924">924</a><a id="L925" href="#L925">925</a><a id="L926" href="#L926">926</a><a id="L927" href="#L927">927</a><a id="L928" href="#L928">928</a><a id="L929" href="#L929">929</a><a id="L930" href="#L930">930</a><a id="L931" href="#L931">931</a><a id="L932" href="#L932">932</a><a id="L933" href="#L933">933</a><a id="L934" href="#L934">934</a><a id="L935" href="#L935">935</a><a id="L936" href="#L936">936</a><a id="L937" href="#L937">937</a><a id="L938" href="#L938">938</a><a id="L939" href="#L939">939</a><a id="L940" href="#L940">940</a><a id="L941" href="#L941">941</a><a id="L942" href="#L942">942</a><a id="L943" href="#L943">943</a><a id="L944" href="#L944">944</a><a id="L945" href="#L945">945</a><a id="L946" href="#L946">946</a><a id="L947" href="#L947">947</a><a id="L948" href="#L948">948</a><a id="L949" href="#L949">949</a><a id="L950" href="#L950">950</a><a id="L951" href="#L951">951</a><a id="L952" href="#L952">952</a><a id="L953" href="#L953">953</a><a id="L954" href="#L954">954</a><a id="L955" href="#L955">955</a><a id="L956" href="#L956">956</a><a id="L957" href="#L957">957</a><a id="L958" href="#L958">958</a><a id="L959" href="#L959">959</a><a id="L960" href="#L960">960</a><a id="L961" href="#L961">961</a><a id="L962" href="#L962">962</a><a id="L963" href="#L963">963</a><a id="L964" href="#L964">964</a><a id="L965" href="#L965">965</a><a id="L966" href="#L966">966</a><a id="L967" href="#L967">967</a><a id="L968" href="#L968">968</a><a id="L969" href="#L969">969</a><a id="L970" href="#L970">970</a><a id="L971" href="#L971">971</a><a id="L972" href="#L972">972</a><a id="L973" href="#L973">973</a><a id="L974" href="#L974">974</a><a id="L975" href="#L975">975</a><a id="L976" href="#L976">976</a><a id="L977" href="#L977">977</a><a id="L978" href="#L978">978</a><a id="L979" href="#L979">979</a><a id="L980" href="#L980">980</a><a id="L981" href="#L981">981</a><a id="L982" href="#L982">982</a><a id="L983" href="#L983">983</a><a id="L984" href="#L984">984</a><a id="L985" href="#L985">985</a><a id="L986" href="#L986">986</a><a id="L987" href="#L987">987</a><a id="L988" href="#L988">988</a><a id="L989" href="#L989">989</a><a id="L990" href="#L990">990</a><a id="L991" href="#L991">991</a><a id="L992" href="#L992">992</a><a id="L993" href="#L993">993</a><a id="L994" href="#L994">994</a><a id="L995" href="#L995">995</a><a id="L996" href="#L996">996</a><a id="L997" href="#L997">997</a><a id="L998" href="#L998">998</a><a id="L999" href="#L999">999</a><a id="L1000" href="#L1000">1000</a><a id="L1001" href="#L1001">1001</a><a id="L1002" href="#L1002">1002</a><a id="L1003" href="#L1003">1003</a><a id="L1004" href="#L1004">1004</a><a id="L1005" href="#L1005">1005</a><a id="L1006" href="#L1006">1006</a><a id="L1007" href="#L1007">1007</a><a id="L1008" href="#L1008">1008</a><a id="L1009" href="#L1009">1009</a><a id="L1010" href="#L1010">1010</a><a id="L1011" href="#L1011">1011</a><a id="L1012" href="#L1012">1012</a><a id="L1013" href="#L1013">1013</a><a id="L1014" href="#L1014">1014</a><a id="L1015" href="#L1015">1015</a><a id="L1016" href="#L1016">1016</a><a id="L1017" href="#L1017">1017</a><a id="L1018" href="#L1018">1018</a><a id="L1019" href="#L1019">1019</a><a id="L1020" href="#L1020">1020</a><a id="L1021" href="#L1021">1021</a><a id="L1022" href="#L1022">1022</a><a id="L1023" href="#L1023">1023</a><a id="L1024" href="#L1024">1024</a><a id="L1025" href="#L1025">1025</a><a id="L1026" href="#L1026">1026</a><a id="L1027" href="#L1027">1027</a><a id="L1028" href="#L1028">1028</a><a id="L1029" href="#L1029">1029</a><a id="L1030" href="#L1030">1030</a><a id="L1031" href="#L1031">1031</a><a id="L1032" href="#L1032">1032</a><a id="L1033" href="#L1033">1033</a><a id="L1034" href="#L1034">1034</a><a id="L1035" href="#L1035">1035</a><a id="L1036" href="#L1036">1036</a><a id="L1037" href="#L1037">1037</a><a id="L1038" href="#L1038">1038</a><a id="L1039" href="#L1039">1039</a><a id="L1040" href="#L1040">1040</a><a id="L1041" href="#L1041">1041</a><a id="L1042" href="#L1042">1042</a><a id="L1043" href="#L1043">1043</a><a id="L1044" href="#L1044">1044</a><a id="L1045" href="#L1045">1045</a><a id="L1046" href="#L1046">1046</a><a id="L1047" href="#L1047">1047</a><a id="L1048" href="#L1048">1048</a><a id="L1049" href="#L1049">1049</a><a id="L1050" href="#L1050">1050</a><a id="L1051" href="#L1051">1051</a><a id="L1052" href="#L1052">1052</a><a id="L1053" href="#L1053">1053</a><a id="L1054" href="#L1054">1054</a><a id="L1055" href="#L1055">1055</a><a id="L1056" href="#L1056">1056</a><a id="L1057" href="#L1057">1057</a><a id="L1058" href="#L1058">1058</a><a id="L1059" href="#L1059">1059</a><a id="L1060" href="#L1060">1060</a><a id="L1061" href="#L1061">1061</a><a id="L1062" href="#L1062">1062</a><a id="L1063" href="#L1063">1063</a><a id="L1064" href="#L1064">1064</a><a id="L1065" href="#L1065">1065</a><a id="L1066" href="#L1066">1066</a><a id="L1067" href="#L1067">1067</a><a id="L1068" href="#L1068">1068</a><a id="L1069" href="#L1069">1069</a><a id="L1070" href="#L1070">1070</a><a id="L1071" href="#L1071">1071</a><a id="L1072" href="#L1072">1072</a><a id="L1073" href="#L1073">1073</a><a id="L1074" href="#L1074">1074</a><a id="L1075" href="#L1075">1075</a><a id="L1076" href="#L1076">1076</a><a id="L1077" href="#L1077">1077</a><a id="L1078" href="#L1078">1078</a><a id="L1079" href="#L1079">1079</a><a id="L1080" href="#L1080">1080</a><a id="L1081" href="#L1081">1081</a><a id="L1082" href="#L1082">1082</a><a id="L1083" href="#L1083">1083</a><a id="L1084" href="#L1084">1084</a><a id="L1085" href="#L1085">1085</a><a id="L1086" href="#L1086">1086</a><a id="L1087" href="#L1087">1087</a><a id="L1088" href="#L1088">1088</a><a id="L1089" href="#L1089">1089</a><a id="L1090" href="#L1090">1090</a><a id="L1091" href="#L1091">1091</a><a id="L1092" href="#L1092">1092</a><a id="L1093" href="#L1093">1093</a><a id="L1094" href="#L1094">1094</a><a id="L1095" href="#L1095">1095</a><a id="L1096" href="#L1096">1096</a><a id="L1097" href="#L1097">1097</a><a id="L1098" href="#L1098">1098</a><a id="L1099" href="#L1099">1099</a><a id="L1100" href="#L1100">1100</a><a id="L1101" href="#L1101">1101</a><a id="L1102" href="#L1102">1102</a><a id="L1103" href="#L1103">1103</a><a id="L1104" href="#L1104">1104</a><a id="L1105" href="#L1105">1105</a><a id="L1106" href="#L1106">1106</a><a id="L1107" href="#L1107">1107</a><a id="L1108" href="#L1108">1108</a><a id="L1109" href="#L1109">1109</a><a id="L1110" href="#L1110">1110</a><a id="L1111" href="#L1111">1111</a><a id="L1112" href="#L1112">1112</a><a id="L1113" href="#L1113">1113</a><a id="L1114" href="#L1114">1114</a><a id="L1115" href="#L1115">1115</a><a id="L1116" href="#L1116">1116</a><a id="L1117" href="#L1117">1117</a><a id="L1118" href="#L1118">1118</a><a id="L1119" href="#L1119">1119</a><a id="L1120" href="#L1120">1120</a><a id="L1121" href="#L1121">1121</a><a id="L1122" href="#L1122">1122</a><a id="L1123" href="#L1123">1123</a><a id="L1124" href="#L1124">1124</a><a id="L1125" href="#L1125">1125</a><a id="L1126" href="#L1126">1126</a><a id="L1127" href="#L1127">1127</a><a id="L1128" href="#L1128">1128</a><a id="L1129" href="#L1129">1129</a><a id="L1130" href="#L1130">1130</a><a id="L1131" href="#L1131">1131</a><a id="L1132" href="#L1132">1132</a><a id="L1133" href="#L1133">1133</a><a id="L1134" href="#L1134">1134</a><a id="L1135" href="#L1135">1135</a><a id="L1136" href="#L1136">1136</a><a id="L1137" href="#L1137">1137</a><a id="L1138" href="#L1138">1138</a><a id="L1139" href="#L1139">1139</a><a id="L1140" href="#L1140">1140</a><a id="L1141" href="#L1141">1141</a><a id="L1142" href="#L1142">1142</a><a id="L1143" href="#L1143">1143</a><a id="L1144" href="#L1144">1144</a><a id="L1145" href="#L1145">1145</a><a id="L1146" href="#L1146">1146</a><a id="L1147" href="#L1147">1147</a><a id="L1148" href="#L1148">1148</a><a id="L1149" href="#L1149">1149</a><a id="L1150" href="#L1150">1150</a><a id="L1151" href="#L1151">1151</a><a id="L1152" href="#L1152">1152</a><a id="L1153" href="#L1153">1153</a><a id="L1154" href="#L1154">1154</a><a id="L1155" href="#L1155">1155</a><a id="L1156" href="#L1156">1156</a><a id="L1157" href="#L1157">1157</a><a id="L1158" href="#L1158">1158</a><a id="L1159" href="#L1159">1159</a><a id="L1160" href="#L1160">1160</a><a id="L1161" href="#L1161">1161</a><a id="L1162" href="#L1162">1162</a><a id="L1163" href="#L1163">1163</a><a id="L1164" href="#L1164">1164</a><a id="L1165" href="#L1165">1165</a><a id="L1166" href="#L1166">1166</a><a id="L1167" href="#L1167">1167</a><a id="L1168" href="#L1168">1168</a><a id="L1169" href="#L1169">1169</a><a id="L1170" href="#L1170">1170</a><a id="L1171" href="#L1171">1171</a><a id="L1172" href="#L1172">1172</a><a id="L1173" href="#L1173">1173</a><a id="L1174" href="#L1174">1174</a><a id="L1175" href="#L1175">1175</a><a id="L1176" href="#L1176">1176</a><a id="L1177" href="#L1177">1177</a><a id="L1178" href="#L1178">1178</a><a id="L1179" href="#L1179">1179</a><a id="L1180" href="#L1180">1180</a><a id="L1181" href="#L1181">1181</a><a id="L1182" href="#L1182">1182</a><a id="L1183" href="#L1183">1183</a><a id="L1184" href="#L1184">1184</a><a id="L1185" href="#L1185">1185</a><a id="L1186" href="#L1186">1186</a><a id="L1187" href="#L1187">1187</a><a id="L1188" href="#L1188">1188</a><a id="L1189" href="#L1189">1189</a><a id="L1190" href="#L1190">1190</a><a id="L1191" href="#L1191">1191</a><a id="L1192" href="#L1192">1192</a><a id="L1193" href="#L1193">1193</a><a id="L1194" href="#L1194">1194</a><a id="L1195" href="#L1195">1195</a><a id="L1196" href="#L1196">1196</a><a id="L1197" href="#L1197">1197</a><a id="L1198" href="#L1198">1198</a><a id="L1199" href="#L1199">1199</a><a id="L1200" href="#L1200">1200</a><a id="L1201" href="#L1201">1201</a><a id="L1202" href="#L1202">1202</a><a id="L1203" href="#L1203">1203</a><a id="L1204" href="#L1204">1204</a><a id="L1205" href="#L1205">1205</a><a id="L1206" href="#L1206">1206</a><a id="L1207" href="#L1207">1207</a><a id="L1208" href="#L1208">1208</a><a id="L1209" href="#L1209">1209</a><a id="L1210" href="#L1210">1210</a><a id="L1211" href="#L1211">1211</a><a id="L1212" href="#L1212">1212</a><a id="L1213" href="#L1213">1213</a><a id="L1214" href="#L1214">1214</a><a id="L1215" href="#L1215">1215</a><a id="L1216" href="#L1216">1216</a><a id="L1217" href="#L1217">1217</a><a id="L1218" href="#L1218">1218</a><a id="L1219" href="#L1219">1219</a><a id="L1220" href="#L1220">1220</a><a id="L1221" href="#L1221">1221</a><a id="L1222" href="#L1222">1222</a><a id="L1223" href="#L1223">1223</a><a id="L1224" href="#L1224">1224</a><a id="L1225" href="#L1225">1225</a><a id="L1226" href="#L1226">1226</a><a id="L1227" href="#L1227">1227</a><a id="L1228" href="#L1228">1228</a><a id="L1229" href="#L1229">1229</a><a id="L1230" href="#L1230">1230</a><a id="L1231" href="#L1231">1231</a><a id="L1232" href="#L1232">1232</a><a id="L1233" href="#L1233">1233</a><a id="L1234" href="#L1234">1234</a><a id="L1235" href="#L1235">1235</a><a id="L1236" href="#L1236">1236</a><a id="L1237" href="#L1237">1237</a><a id="L1238" href="#L1238">1238</a><a id="L1239" href="#L1239">1239</a><a id="L1240" href="#L1240">1240</a><a id="L1241" href="#L1241">1241</a><a id="L1242" href="#L1242">1242</a><a id="L1243" href="#L1243">1243</a><a id="L1244" href="#L1244">1244</a><a id="L1245" href="#L1245">1245</a><a id="L1246" href="#L1246">1246</a><a id="L1247" href="#L1247">1247</a><a id="L1248" href="#L1248">1248</a><a id="L1249" href="#L1249">1249</a><a id="L1250" href="#L1250">1250</a><a id="L1251" href="#L1251">1251</a><a id="L1252" href="#L1252">1252</a><a id="L1253" href="#L1253">1253</a><a id="L1254" href="#L1254">1254</a><a id="L1255" href="#L1255">1255</a><a id="L1256" href="#L1256">1256</a><a id="L1257" href="#L1257">1257</a><a id="L1258" href="#L1258">1258</a><a id="L1259" href="#L1259">1259</a><a id="L1260" href="#L1260">1260</a><a id="L1261" href="#L1261">1261</a><a id="L1262" href="#L1262">1262</a><a id="L1263" href="#L1263">1263</a><a id="L1264" href="#L1264">1264</a><a id="L1265" href="#L1265">1265</a><a id="L1266" href="#L1266">1266</a><a id="L1267" href="#L1267">1267</a><a id="L1268" href="#L1268">1268</a><a id="L1269" href="#L1269">1269</a><a id="L1270" href="#L1270">1270</a><a id="L1271" href="#L1271">1271</a><a id="L1272" href="#L1272">1272</a><a id="L1273" href="#L1273">1273</a><a id="L1274" href="#L1274">1274</a><a id="L1275" href="#L1275">1275</a><a id="L1276" href="#L1276">1276</a><a id="L1277" href="#L1277">1277</a><a id="L1278" href="#L1278">1278</a><a id="L1279" href="#L1279">1279</a><a id="L1280" href="#L1280">1280</a><a id="L1281" href="#L1281">1281</a><a id="L1282" href="#L1282">1282</a><a id="L1283" href="#L1283">1283</a><a id="L1284" href="#L1284">1284</a><a id="L1285" href="#L1285">1285</a><a id="L1286" href="#L1286">1286</a><a id="L1287" href="#L1287">1287</a><a id="L1288" href="#L1288">1288</a><a id="L1289" href="#L1289">1289</a><a id="L1290" href="#L1290">1290</a><a id="L1291" href="#L1291">1291</a><a id="L1292" href="#L1292">1292</a><a id="L1293" href="#L1293">1293</a><a id="L1294" href="#L1294">1294</a><a id="L1295" href="#L1295">1295</a><a id="L1296" href="#L1296">1296</a><a id="L1297" href="#L1297">1297</a><a id="L1298" href="#L1298">1298</a><a id="L1299" href="#L1299">1299</a><a id="L1300" href="#L1300">1300</a><a id="L1301" href="#L1301">1301</a><a id="L1302" href="#L1302">1302</a><a id="L1303" href="#L1303">1303</a><a id="L1304" href="#L1304">1304</a><a id="L1305" href="#L1305">1305</a><a id="L1306" href="#L1306">1306</a><a id="L1307" href="#L1307">1307</a><a id="L1308" href="#L1308">1308</a><a id="L1309" href="#L1309">1309</a><a id="L1310" href="#L1310">1310</a><a id="L1311" href="#L1311">1311</a><a id="L1312" href="#L1312">1312</a><a id="L1313" href="#L1313">1313</a><a id="L1314" href="#L1314">1314</a><a id="L1315" href="#L1315">1315</a><a id="L1316" href="#L1316">1316</a><a id="L1317" href="#L1317">1317</a><a id="L1318" href="#L1318">1318</a><a id="L1319" href="#L1319">1319</a><a id="L1320" href="#L1320">1320</a><a id="L1321" href="#L1321">1321</a><a id="L1322" href="#L1322">1322</a><a id="L1323" href="#L1323">1323</a></td>
<td><td><pre class="sourcecode">
<span class="bc">/*******************************************************************************

        copyright:      Copyright (c) 2008 Jeff Davey. All rights reserved

        license:        BSD style: $(LICENSE)

        author:         Jeff Davey &lt;j@submersion.com&gt;

*******************************************************************************/</span>

<span class="d Compound"><span class="d Module"><span class="k">module</span> <span class="i">tango</span>.<span class="i">net</span>.<span class="i">util</span>.<span class="i">PKI</span>;</span>

<span class="d Protection"><span class="k">private</span></span> <span class="d Import"><span class="k">import</span> <span class="i">tango</span>.<span class="i">time</span>.<span class="i">Time</span>;</span>

<span class="d Protection"><span class="k">private</span></span> <span class="d Import"><span class="k">import</span> <span class="i">tango</span>.<span class="i">stdc</span>.<span class="i">stringz</span>;</span>

<span class="d Protection"><span class="k">private</span></span> <span class="d Import"><span class="k">import</span> <span class="i">tango</span>.<span class="i">net</span>.<span class="i">util</span>.<span class="i">c</span>.<span class="i">OpenSSL</span>;</span>

<span class="bc">/*******************************************************************************

  PKI provides Public Key Infrastructure. 

  Specifically, it provides the ability to:

  - Make a X509 Certificate (SSL Certificate)

  - Make a Public and Private key pair

  - Validate a X509 Certificate against a Certificate Authority

  - Generate a SSLCtx for SSLSocket and SSLServerSocket

  - Wrap a SSLVerifyCallback so that retrieving the peer cert is easier

  PKI requires the OpenSSL library, and uses a dynamic binding to the library.
  You can find the library at http://www.openssl.org and a Win32 specific port 
  at http://www.slproweb.com/products/Win32OpenSSL.html.

*******************************************************************************/</span>


<span class="bc">/*******************************************************************************

  Do not verify the peer certificate. Nor fail if it's not provided (server 
  only).

*******************************************************************************/</span>

<span class="d StorageClass"><span class="k">const</span></span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">SSL_VERIFY_NONE</span> = <span class="e Int"><span class="n">0x00</span></span>;</span>

<span class="bc">/*******************************************************************************

  Ask for a peer certificate, but do not fail if it is not provided.

*******************************************************************************/</span>

<span class="d StorageClass"><span class="k">const</span></span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">SSL_VERIFY_PEER</span> = <span class="e Int"><span class="n">0x01</span></span>;</span>

<span class="bc">/*******************************************************************************

  Ask for a peer certificate, however, fail if it is not provided

*******************************************************************************/</span>

<span class="d StorageClass"><span class="k">const</span></span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">SSL_VERIFY_FAIL_IF_NO_PEER_CERT</span> = <span class="e Int"><span class="n">0x02</span></span>;</span>

<span class="bc">/*******************************************************************************

  Only validate once, do not re-validate during handshake renegotiation.

*******************************************************************************/</span>

<span class="d StorageClass"><span class="k">const</span></span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">SSL_VERIFY_CLIENT_ONCE</span> = <span class="e Int"><span class="n">0x04</span></span>;</span>

<span class="d StorageClass"><span class="k">const</span></span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">SSL_SESS_CACHE_SERVER</span> = <span class="e Int"><span class="n">0x0002</span></span>;</span>

<span class="bc">/*******************************************************************************

  SSLVerifyCallback is passed into SSLCtx and is called during handshake
  when OpenSSL is doing certificate validation.

  Wrapping the X509_STORE_CTX in the CertificateStoreCtx utility class
  gives the ability to access the peer certificate, and reason for error.

*******************************************************************************/</span>

<span class="d Linkage"><span class="k">extern</span> (<span class="i">C</span>)</span> <span class="d Alias"><span class="k">alias</span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="t Function"><span class="k">function</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">int</span></span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">X509_STORE_CTX</span></span> <span class="t Pointer">*</span><span class="i">ctx</span></span>)</span></span> <span class="i">SSLVerifyCallback</span>;</span></span>


<span class="bc">/*******************************************************************************

    SSLCtx is provided to SSLSocket and SSLServerSocket.

    It contains the public/private keypair, and some additional options that
    control how the SSL streams work.

    Example
    ---
    auto cert = new Certificate(cast(char[])File("public.pem").read);
    auto pkey = new PrivateKey(cast(char[])File("private.pem").read);;
    auto ctx = new SSLCtx();
    ctx.certificate = cert;
    ctx.pkey = pkey;
    ctx.checkKey();
    ---

*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">SSLCtx</span>
<span class="d Compound">{
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">SSL_CTX</span></span> <span class="t Pointer">*</span><span class="i">_ctx</span> = <span class="e Null"><span class="k">null</span></span>;</span>
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">_cert</span> = <span class="e Null"><span class="k">null</span></span>;</span>
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">PrivateKey</span></span> <span class="i">_key</span> = <span class="e Null"><span class="k">null</span></span>;</span>
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">CertificateStore</span></span> <span class="i">_store</span> = <span class="e Null"><span class="k">null</span></span>;</span>

    <span class="bc">/*******************************************************************************

        Creates a new SSLCtx supporting SSLv3 and TLSv1 methods.

    *******************************************************************************/</span>

    <span class="d Constructor"><span class="k">this</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Paren">(<span class="e Assign"><span class="e Identifier"><span class="i">_ctx</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">SSL_CTX_new</span></span>(<span class="i">SSLv23_method</span>())</span></span>)</span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>

    <span class="d Destructor">~<span class="k">this</span>()
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">_ctx</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">SSL_CTX_free</span></span>(<span class="i">_ctx</span>);</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_ctx</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        }</span></span></span>
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_key</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_store</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Return the native context from OpenSSL
                
    *******************************************************************************/</span>

    <span class="d StorageClass">@<span class="i">property</span></span> <span class="d Function"><span class="t Identifier"><span class="i">SSL_CTX</span></span><span class="t Pointer">*</span> <span class="i">native</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{   
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">_ctx</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Assigns a X509 Certificate to the SSLCtx.

        This is required for SSL
        
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">SSLCtx</span></span> <span class="i">certificate</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">cert</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">SSL_CTX_use_certificate</span></span>(<span class="i">_ctx</span>, <span class="i">cert</span>.<span class="i">_cert</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Identifier"><span class="i">cert</span></span></span>;</span></span>
        <span class="k">else</span>
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Assigns a PrivateKey (public/private keypair to the SSLCtx.

        This is required for SSL.
                
    *******************************************************************************/</span>


    <span class="d Function"><span class="t Identifier"><span class="i">SSLCtx</span></span> <span class="i">privateKey</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">PrivateKey</span></span> <span class="i">key</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">SSL_CTX_use_PrivateKey</span></span>(<span class="i">_ctx</span>, <span class="i">key</span>.<span class="i">_evpKey</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_key</span></span> = <span class="e Identifier"><span class="i">key</span></span></span>;</span></span>
        <span class="k">else</span>
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Validates that the X509 certificate was signed with the provided
        public/private keypair. Throws an exception if this is not the case.
                
    *******************************************************************************/</span>

    <span class="d StorageClass">@<span class="i">property</span></span> <span class="d Function"><span class="t Identifier"><span class="i">SSLCtx</span></span> <span class="i">checkKey</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">SSL_CTX_check_private_key</span></span></span>(<span class="i">_ctx</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Sets a SSLVerifyCallback function using the SSL_VERIFY_(NONE|PEER|etc) flags
        to control how verification is handled.
                
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">SSLCtx</span></span> <span class="i">setVerification</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">int</span></span> <span class="i">flags</span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">SSLVerifyCallback</span></span> <span class="i">cb</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">SSL_CTX_set_verify</span></span>(<span class="i">_ctx</span>, <span class="i">flags</span>, <span class="i">cb</span>)</span>;</span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Sets a CertificateStore of certs that are valid and trust Certificate
        Authorities during verification.
                
    *******************************************************************************/</span>


    <span class="d Function"><span class="t Identifier"><span class="i">SSLCtx</span></span> <span class="i">store</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">CertificateStore</span></span> <span class="i">store</span></span>)</span> <span class="lc">// warning this will free the existing one.. not sure if it frees on close yet ( so don't set it twice! ?!)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">SSL_CTX_set_cert_store</span></span>(<span class="i">_ctx</span>, <span class="i">store</span>.<span class="i">_store</span>)</span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_store</span></span> = <span class="e Identifier"><span class="i">store</span></span></span>;</span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Loads valid Certificate Authorities from the specified path.

        From the SSL_CTX_load_verify_locations manpage:

        Each file must contain only one CA certificate. Also, the files are
        looked up by the CA subject name hash value, which must be available. If
        more than one CA certificate with the same name hash value exists, the
        extension must be different. (ie: 9d66eef0.0, 9d66eef0.1, etc). The search 
        is performed in the ordering of the extension, regardless of other properties
        of the certificates. Use the c_rehash utility to create the necessary symlinks
                
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">SSLCtx</span></span> <span class="i">caCertsPath</span><span class="o Parameters">(<span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">path</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">SSL_CTX_load_verify_locations</span></span></span>(<span class="i">_ctx</span>, <span class="k">null</span>, <span class="i">toStringz</span>(<span class="i">path</span>))</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="lc">// TODO need to finish adding Session handling functionality</span>
<span class="bc">/*    void sessionCacheMode(int mode)
    {
        if (!SSL_CTX_set_session_cache_mode(_ctx, mode))
            throwOpenSSLError();
    }

    void sessionId(ubyte[] id)
    {
        if (!SSL_CTX_set_session_id_context(_ctx, id.ptr, id.length))
            throwOpenSSLError();
    } */</span>
}</span></span>

<span class="bc">/*******************************************************************************

    The CertificateStoreCtx is a wrapper to the SSLVerifyCallback X509_STORE_CTX
    parameter.

    It allows retrieving the peer certificate, and examining any errors during
    validation.


    The following example will probably change sometime soon.

    Example
    ---
    extern (C)
    {
        int myCallback(int code, X509_STORE_CTX *ctx)
        {
            auto myCtx = new CertificateStoreCtx(ctx);
            Certificate cert = myCtx.cert;
            Stdout(cert.subject).newline;
            return 0; // BAD CERT! (1 is good)
        }
    }
    ---

*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">CertificateStoreCtx</span>
<span class="d Compound">{
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">X509_STORE_CTX</span></span> <span class="t Pointer">*</span><span class="i">_ctx</span> = <span class="e Null"><span class="k">null</span></span>;</span>

    <span class="bc">/*******************************************************************************

        This constructor takes a X509_STORE_CTX as provided by the SSLVerifyCallback
        function.
                
    *******************************************************************************/</span>

    <span class="d Constructor"><span class="k">this</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">X509_STORE_CTX</span></span> <span class="t Pointer">*</span><span class="i">ctx</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_ctx</span></span> = <span class="e Identifier"><span class="i">ctx</span></span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Returns the peer certificate.
                
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">cert</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509</span></span> <span class="t Pointer">*</span><span class="i">cert</span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_CTX_get_current_cert</span></span>(<span class="i">_ctx</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">cert</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Certificate</span></span>(<span class="e Identifier"><span class="i">cert</span></span>)</span>;</span>
    }</span></span></span>

    <span class="lc">// TODO need more research on what used for</span>
    <span class="d Function"><span class="t Integral"><span class="k">int</span></span> <span class="i">error</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_CTX_get_error</span></span>(<span class="i">_ctx</span>)</span>;</span>
    }</span></span></span>

    <span class="lc">// TODO need more research on what used for</span>
    <span class="d Function"><span class="t Integral"><span class="k">int</span></span> <span class="i">errorDepth</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_CTX_get_error_depth</span></span>(<span class="i">_ctx</span>)</span>;</span>
    }</span></span></span>

}</span></span>

<span class="bc">/*******************************************************************************

    CertificateStore stores numerous X509 Certificates for use in CRL lists,
    CA lists, etc.

    Example
    ---
    auto store = new CertificateStore();
    auto caCert = new Certificate(cast(char[])File("cacert.pem").read);
    store.add(caCert);
    auto untrustedCert = new Certificate(cast(char[])File("cert.pem").read);
    if (untrustedCert.verify(store))
        Stdout("The untrusted cert was signed by our caCert and is valid.").newline;
    else
        Stdout("The untrusted cert was expired, or not signed by the caCert").newline;
    ---
            
*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">CertificateStore</span>
<span class="d Compound">{
    <span class="d Protection"><span class="k">package</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">X509_STORE</span></span> <span class="t Pointer">*</span><span class="i">_store</span> = <span class="e Null"><span class="k">null</span></span>;</span>
    <span class="d Variables"><span class="t Identifier"><span class="i">Certificate</span></span><span class="t Array">[]</span> <span class="i">_certs</span>;</span>


    <span class="d Constructor"><span class="k">this</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Paren">(<span class="e Assign"><span class="e Identifier"><span class="i">_store</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_new</span></span>()</span></span>)</span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>

    <span class="d Destructor">~<span class="k">this</span>()
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">_store</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_STORE_free</span></span>(<span class="i">_store</span>);</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_store</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        }</span></span></span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Add a Certificate to the store.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">CertificateStore</span></span> <span class="i">add</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">cert</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_add_cert</span></span>(<span class="i">_store</span>, <span class="i">cert</span>.<span class="i">_cert</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e CatAssign"><span class="e Identifier"><span class="i">_certs</span></span> ~= <span class="e Identifier"><span class="i">cert</span></span></span>;</span></span> <span class="lc">// just in case it gets GC'd?</span>
        <span class="k">else</span>
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>
}</span></span>

<span class="bc">/*******************************************************************************

    PublicKey contains the RSA public key from a private/public keypair.

    It also allows extraction of the public key from a keypair.

    This is useful for encryption, you can encrypt data with someone's public key
    and they can decrypt it with their private key.

    Example
    ---
    auto public = new PublicKey(cast(char[])File("public.pem").read);
    auto encrypted = public.encrypt(cast(ubyte[])"Hello, how are you today?");
    auto pemData = public.pemFormat;
    ---

*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">PublicKey</span>
<span class="d Compound">{
    <span class="d Protection"><span class="k">package</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">RSA</span></span> <span class="t Pointer">*</span><span class="i">_evpKey</span> = <span class="e Null"><span class="k">null</span></span>;</span>
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">PrivateKey</span></span> <span class="i">_existingKey</span> = <span class="e Null"><span class="k">null</span></span>;</span>

    <span class="bc">/*******************************************************************************

        Generate a PublicKey object from the passed PEM formatted data

        Params:
            publicPemData = pem encoded data containing the public key 
            
    *******************************************************************************/</span>
    <span class="d Constructor"><span class="k">this</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">publicPemData</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">bp</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new_mem_buf</span></span>(<span class="i">publicPemData</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="k">int</span>) <span class="i">publicPemData</span>.<span class="i">length</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">bp</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">PEM_read_bio_RSAPublicKey</span></span>(<span class="i">bp</span>, <span class="k">null</span>, <span class="k">null</span>, <span class="k">null</span>)</span></span>;</span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">bp</span>);</span></span>
        }</span></span></span>

        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_evpKey</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>
    <span class="d Protection"><span class="k">package</span></span> <span class="d Constructor"><span class="k">this</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">PrivateKey</span></span> <span class="i">key</span></span>)</span> 
    <span class="s FuncBody"><span class="s Compound">{        
        <span class="s Expression"><span class="e Assign"><span class="e This"><span class="k">this</span></span>.<span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Cast"><span class="k">cast</span>(<span class="t Identifier"><span class="i">RSA</span></span> <span class="t Pointer">*</span>)<span class="e Identifier"><span class="i">key</span></span></span>.<span class="e Identifier"><span class="i">_evpKey</span></span>.<span class="e Identifier"><span class="i">pkey</span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e This"><span class="k">this</span></span>.<span class="e Identifier"><span class="i">_existingKey</span></span> = <span class="e Identifier"><span class="i">key</span></span></span>;</span>
    }</span></span></span>

    <span class="d Destructor">~<span class="k">this</span>()
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_existingKey</span></span> !<span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_existingKey</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        }</span></span>
        <span class="k">else</span> <span class="s Scope"><span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">_evpKey</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">RSA_free</span></span>(<span class="i">_evpKey</span>);</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        }</span></span></span></span></span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Return a PublicKey in the PEM format.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pemFormat</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">rtn</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">bp</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new</span></span>(<span class="i">BIO_s_mem</span>())</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">bp</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">PEM_write_bio_RSAPublicKey</span></span>(<span class="i">bp</span>, <span class="i">_evpKey</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span> <span class="t Pointer">*</span><span class="i">pemData</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">pemSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_get_mem_data</span></span>(<span class="i">bp</span>, &amp;<span class="i">pemData</span>)</span>;</span></span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">pemData</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">pemSize</span></span>]</span>.<span class="e Identifier"><span class="i">dup</span></span></span>;</span>
            }</span></span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">bp</span>);</span></span>
        }</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Verify the data passed was signed with the public key.

        Params:
        data = the data to verify
        signature = the digital signature
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">bool</span></span> <span class="i">verify</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">data</span></span>, <span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">signature</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="t Identifier"><span class="i">MD5_DIGEST_LENGTH</span></span>]</span> <span class="i">digest</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">MD5_CTX</span></span> <span class="i">c</span>;</span></span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">MD5_Init</span></span>(&amp;<span class="i">c</span>)</span>;</span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">MD5_Update</span></span>(&amp;<span class="i">c</span>, <span class="i">data</span>.<span class="i">ptr</span>, <span class="i">data</span>.<span class="i">length</span>)</span>;</span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">MD5_Final</span></span>(<span class="i">digest</span>.<span class="i">ptr</span>, &amp;<span class="i">c</span>)</span>;</span>
        
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">RSA_verify</span></span>(<span class="i">NID_md5</span>, <span class="i">digest</span>.<span class="i">ptr</span>, <span class="i">MD5_DIGEST_LENGTH</span>, <span class="i">signature</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="k">uint</span>) <span class="i">signature</span>.<span class="i">length</span>, <span class="i">_evpKey</span>)</span>)
            <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Bool"><span class="k">true</span></span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Bool"><span class="k">false</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Encrypt the passed data using the PublicKey 
        
        Notes:
        This is size limited based off the key
        Not recommended for general encryption, use RSA for encrypting a 
        random key instead and switch to a block cipher.

        Params:
        data = the data to encrypt
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">encrypt</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">data</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">rtn</span>;</span></span>

        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">uint</span></span> <span class="i">maxSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_size</span></span>(<span class="i">_evpKey</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">data</span></span>.<span class="e Identifier"><span class="i">length</span></span> &gt; <span class="e Identifier"><span class="i">maxSize</span></span></span>)
            <span class="s Scope"><span class="s Throw"><span class="k">throw</span> <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Exception</span></span>(<span class="e String"><span class="sl">"The specified data is larger than the size that can be encrypted by this public key."</span></span>)</span>;</span></span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">tmpRtn</span> = <span class="e New"><span class="k">new</span> <span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="e Identifier"><span class="i">maxSize</span></span></span>]</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">numBytes</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_public_encrypt</span></span>(<span class="k">cast</span>(<span class="k">int</span>) <span class="i">data</span>.<span class="i">length</span>, <span class="i">data</span>.<span class="i">ptr</span>, <span class="i">tmpRtn</span>.<span class="i">ptr</span>, <span class="i">_evpKey</span>, <span class="i">RSA_PKCS1_OAEP_PADDING</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">numBytes</span></span> &gt;= <span class="e Int"><span class="n">0</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">tmpRtn</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">numBytes</span></span>]</span></span>;</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

     <span class="bc">/*******************************************************************************

        Decrypts data previously encrypted with the matching PrivateKey

        Please see the encrypt notes.

        Params:
            data = the data to encrypt

    *******************************************************************************/</span>
       
    <span class="d Function"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">decrypt</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">data</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">rtn</span>;</span></span>

        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">uint</span></span> <span class="i">maxSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_size</span></span>(<span class="i">_evpKey</span>)</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">tmpRtn</span> = <span class="e New"><span class="k">new</span> <span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="e Identifier"><span class="i">maxSize</span></span></span>]</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">numBytes</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_public_decrypt</span></span>(<span class="k">cast</span>(<span class="k">int</span>) <span class="i">data</span>.<span class="i">length</span>, <span class="i">data</span>.<span class="i">ptr</span>, <span class="i">tmpRtn</span>.<span class="i">ptr</span>, <span class="i">_evpKey</span>, <span class="i">RSA_PKCS1_PADDING</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">numBytes</span></span> &gt;= <span class="e Int"><span class="n">0</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">tmpRtn</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">numBytes</span></span>]</span></span>;</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

}</span></span>

<span class="bc">/*******************************************************************************

    Generates a RSA public/private key pair for use with X509 Certificates
    and other applications search as S/MIME, DomainKeys, etc.

    Example
    ---
    auto newPkey = new PrivateKey(2048); // create new keypair
    Stdout(newPkey.pemFormat("password")); // dumps in pemFormat with encryption
    Stdout(newPkey.pemFormat()); // dumps in pemFormat without encryption
    Stdout(newPkey.publicKey.pemFormat); // dump out just the public key portion
    auto data = newPkey.decrypt(someData); // decrypt data encrypted with public Key
    ---

*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">PrivateKey</span>
<span class="d Compound">{
    <span class="d Protection"><span class="k">package</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">EVP_PKEY</span></span> <span class="t Pointer">*</span><span class="i">_evpKey</span> = <span class="e Null"><span class="k">null</span></span>;</span>

    <span class="bc">/*******************************************************************************

        Reads in the provided PEM data, with an optional password to decrypt
        the private key.

        Params:
            privatePemData = the PEM encoded data of the private key
            certPass = an optional password to decrypt the key.
        
    *******************************************************************************/</span>

    <span class="d Constructor"><span class="k">this</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">privatePemData</span></span>, <span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">certPass</span> = <span class="e Null"><span class="k">null</span></span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">bp</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new_mem_buf</span></span>(<span class="i">privatePemData</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="k">int</span>) <span class="i">privatePemData</span>.<span class="i">length</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">bp</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">PEM_read_bio_PrivateKey</span></span>(<span class="i">bp</span>, <span class="k">null</span>, <span class="k">null</span>, <span class="i">certPass</span> ? <span class="i">toStringz</span>(<span class="i">certPass</span>) : <span class="k">null</span>)</span></span>;</span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">bp</span>);</span></span>
        }</span></span></span>

        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_evpKey</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Generates a new private/public key at the specified bit leve.

        Params:
            bits = Number of bits to use, 2048 is a good number for this.
        
    *******************************************************************************/</span>


    <span class="d Constructor"><span class="k">this</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">int</span></span> <span class="i">bits</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">RSA</span></span> <span class="t Pointer">*</span><span class="i">rsa</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_generate_key</span></span>(<span class="i">bits</span>, <span class="i">RSA_F4</span>, <span class="k">null</span>, <span class="k">null</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">rsa</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Paren">(<span class="e Assign"><span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">EVP_PKEY_new</span></span>()</span></span>)</span> !<span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
                <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">EVP_PKEY_assign_RSA</span></span>(<span class="i">_evpKey</span>, <span class="i">rsa</span>)</span>;</span></span></span>
            <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_evpKey</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
                <span class="s Scope"><span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">RSA_free</span></span>(<span class="i">rsa</span>);</span></span></span></span>
        }</span></span></span>

        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_evpKey</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>
    
    <span class="d Destructor">~<span class="k">this</span>()
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">_evpKey</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">EVP_PKEY_free</span></span>(<span class="i">_evpKey</span>);</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_evpKey</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        }</span></span></span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Compares two PrivateKey classes to see if the internal structures are 
        the same.
        
    *******************************************************************************/</span>
    <span class="d StorageClass"><span class="k">override</span></span> <span class="d Function"><span class="t Integral"><span class="k">bool</span></span> <span class="i">opEquals</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">Object</span></span> <span class="i">obj</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pk</span> = <span class="e Cast"><span class="k">cast</span>(<span class="t Identifier"><span class="i">PrivateKey</span></span>)<span class="e Identifier"><span class="i">obj</span></span></span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">pk</span></span> !<span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Cast"><span class="k">cast</span>(<span class="t Integral"><span class="k">bool</span></span>)<span class="e Identifier"><span class="i">EVP_PKEY_cmp_parameters</span></span></span>(<span class="i">pk</span>.<span class="i">_evpKey</span>, <span class="k">this</span>.<span class="i">_evpKey</span>)</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Bool"><span class="k">false</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Returns the underlying public/private key pair in PEM format.

        Params:
            pass = If this is provided, the private key will be encrypted using
            AES 256bit encryption, with this as the key.
        
    *******************************************************************************/</span>
    <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pemFormat</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pass</span> = <span class="e Null"><span class="k">null</span></span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">rtn</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">bp</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new</span></span>(<span class="i">BIO_s_mem</span>())</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">bp</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">PEM_write_bio_PKCS8PrivateKey</span></span>(<span class="i">bp</span>, <span class="i">_evpKey</span>, <span class="i">pass</span> ? <span class="i">EVP_aes_256_cbc</span>() : <span class="k">null</span>, <span class="k">null</span>, <span class="n">0</span>, <span class="k">null</span>, <span class="i">pass</span> ? <span class="i">toStringz</span>(<span class="i">pass</span>) : <span class="k">null</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span> <span class="t Pointer">*</span><span class="i">pemData</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">pemSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_get_mem_data</span></span>(<span class="i">bp</span>, &amp;<span class="i">pemData</span>)</span>;</span></span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">pemData</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">pemSize</span></span>]</span>.<span class="e Identifier"><span class="i">dup</span></span></span>;</span>
            }</span></span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">bp</span>);</span></span>
        }</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Returns the underlying PublicKey

    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">PublicKey</span></span> <span class="i">publicKey</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">rtn</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PublicKey</span></span>(<span class="e This"><span class="k">this</span></span>)</span>;</span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************
        Sign the given data with the private key

        Params:
        data = the data to sign
        sigbuf = the buffer to store the signature in
        
        Returns a slice of the signature or null

    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">sign</span><span class="o Parameters">(<span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">ubyte</span></span>)</span><span class="t Array">[]</span> <span class="i">data</span></span>, <span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">sigbuf</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">uint</span></span> <span class="i">maxSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_size</span></span>(<span class="k">cast</span>(<span class="i">RSA</span> *)<span class="i">_evpKey</span>.<span class="i">pkey</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">sigbuf</span></span>.<span class="e Identifier"><span class="i">length</span></span> &lt; <span class="e Identifier"><span class="i">maxSize</span></span></span>)
            <span class="s Scope"><span class="s Throw"><span class="k">throw</span> <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Exception</span></span>(<span class="e String"><span class="sl">"The signature buffer is too small to fit the signature for this key."</span></span>)</span>;</span></span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="t Identifier"><span class="i">MD5_DIGEST_LENGTH</span></span>]</span> <span class="i">digest</span>;</span></span>

        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">MD5_CTX</span></span> <span class="i">c</span>;</span></span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">MD5_Init</span></span>(&amp;<span class="i">c</span>)</span>;</span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">MD5_Update</span></span>(&amp;<span class="i">c</span>, <span class="i">data</span>.<span class="i">ptr</span>, <span class="i">data</span>.<span class="i">length</span>)</span>;</span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">MD5_Final</span></span>(<span class="i">digest</span>.<span class="i">ptr</span>, &amp;<span class="i">c</span>)</span>;</span>

        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">uint</span></span> <span class="i">len</span> = <span class="e Cast"><span class="k">cast</span>(<span class="t Integral"><span class="k">uint</span></span>) <span class="e Identifier"><span class="i">sigbuf</span></span></span>.<span class="e Identifier"><span class="i">length</span></span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">RSA_sign</span></span>(<span class="i">NID_md5</span>, <span class="i">digest</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="k">uint</span>) <span class="i">digest</span>.<span class="i">length</span>, <span class="i">sigbuf</span>.<span class="i">ptr</span>, &amp;<span class="i">len</span>, <span class="k">cast</span>(<span class="i">RSA</span> *)<span class="i">_evpKey</span>.<span class="i">pkey</span>)</span>)
            <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Slice"><span class="e Identifier"><span class="i">sigbuf</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">len</span></span>]</span>;</span></span>
        <span class="k">else</span>
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Null"><span class="k">null</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Encrypt the passed data using the PrivateKey
        
        Notes:
        This is size limited based off the key
        Not recommended for general encryption, use RSA for encrypting a 
        random key instead and switch to a block cipher.

        Params:
        data = the data to encrypt
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">encrypt</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">data</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">rtn</span>;</span></span>

        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">uint</span></span> <span class="i">maxSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_size</span></span>(<span class="k">cast</span>(<span class="i">RSA</span> *)<span class="i">_evpKey</span>.<span class="i">pkey</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">data</span></span>.<span class="e Identifier"><span class="i">length</span></span> &gt; <span class="e Identifier"><span class="i">maxSize</span></span></span>)
            <span class="s Scope"><span class="s Throw"><span class="k">throw</span> <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Exception</span></span>(<span class="e String"><span class="sl">"The specified data is larger than the size that can be encrypted by this public key."</span></span>)</span>;</span></span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">tmpRtn</span> = <span class="e New"><span class="k">new</span> <span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="e Identifier"><span class="i">maxSize</span></span></span>]</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">numBytes</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_private_encrypt</span></span>(<span class="k">cast</span>(<span class="k">int</span>) <span class="i">data</span>.<span class="i">length</span>, <span class="i">data</span>.<span class="i">ptr</span>, <span class="i">tmpRtn</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="i">RSA</span> *)<span class="i">_evpKey</span>.<span class="i">pkey</span>, <span class="i">RSA_PKCS1_PADDING</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">numBytes</span></span> &gt;= <span class="e Int"><span class="n">0</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">tmpRtn</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">numBytes</span></span>]</span></span>;</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

     <span class="bc">/*******************************************************************************

        Decrypts data previously encrypted with the matching PublicKey

        Please see the encrypt notes.

        Parmas:
            data = the data to encrypt

    *******************************************************************************/</span>
       
    <span class="d Function"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">decrypt</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">data</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">rtn</span>;</span></span>

        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">uint</span></span> <span class="i">maxSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_size</span></span>(<span class="k">cast</span>(<span class="i">RSA</span> *)<span class="i">_evpKey</span>.<span class="i">pkey</span>)</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">tmpRtn</span> = <span class="e New"><span class="k">new</span> <span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="e Identifier"><span class="i">maxSize</span></span></span>]</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">numBytes</span> = <span class="e Call"><span class="e Identifier"><span class="i">RSA_private_decrypt</span></span>(<span class="k">cast</span>(<span class="k">int</span>) <span class="i">data</span>.<span class="i">length</span>, <span class="i">data</span>.<span class="i">ptr</span>, <span class="i">tmpRtn</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="i">RSA</span> *)<span class="i">_evpKey</span>.<span class="i">pkey</span>, <span class="i">RSA_PKCS1_OAEP_PADDING</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Rel"><span class="e Identifier"><span class="i">numBytes</span></span> &gt;= <span class="e Int"><span class="n">0</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">tmpRtn</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">numBytes</span></span>]</span></span>;</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

}</span></span>

<span class="bc">/*******************************************************************************

    Certificate provides necessary functionality to create and read X509 
    Certificates.

    Note, once a Certificate has been signed, it is immutable, and cannot
    be modified.

    X509 Certificates are sometimes called SSL Certificates.

    Example
    ---
    auto newPkey = new PrivateKey(2048); // create new keypair
    auto cert = new Certificate();
    cert.privateKey = newPkey;
    cert.serialNumber = 1;
    cert.dateBeforeOffset = TimeSpan.zero;
    cert.dateAfterOffset = TimeSpan.days(365); // cert is valid for one year
    cert.setSubject("US", "State", "City", "Organization", "CN", "Organizational Unit", "Email");
    cert.sign(cert, newPkey); // self signed cert
    Stdout(newPkey.pemFormat).newline;
    Stdout(cert.pemFormat).newline;
    ---

*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">Certificate</span>
<span class="d Compound">{
    <span class="d Protection"><span class="k">package</span></span> <span class="d Variables"><span class="t Identifier"><span class="i">X509</span></span> <span class="t Pointer">*</span><span class="i">_cert</span> = <span class="e Null"><span class="k">null</span></span>;</span>
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Integral"><span class="k">bool</span></span> <span class="i">readOnly</span> = <span class="e Bool"><span class="k">true</span></span>;</span>
    <span class="d Protection"><span class="k">private</span></span> <span class="d Variables"><span class="t Integral"><span class="k">bool</span></span> <span class="i">freeIt</span> = <span class="e Bool"><span class="k">true</span></span>;</span>

    <span class="lc">// used with X509_STORE_CTX</span>
    <span class="d Protection"><span class="k">package</span></span> <span class="d Constructor"><span class="k">this</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">X509</span></span> <span class="t Pointer">*</span><span class="i">cert</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Identifier"><span class="i">cert</span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">freeIt</span></span> = <span class="e Bool"><span class="k">false</span></span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Parses a X509 Certificate from the provided PEM encoded data.
            
    *******************************************************************************/</span>
    <span class="d Constructor"><span class="k">this</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">publicPemData</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">data</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new_mem_buf</span></span>(<span class="i">publicPemData</span>.<span class="i">ptr</span>, <span class="k">cast</span>(<span class="k">int</span>) <span class="i">publicPemData</span>.<span class="i">length</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">data</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">PEM_read_bio_X509</span></span>(<span class="i">data</span>, <span class="k">null</span>, <span class="k">null</span>, <span class="k">null</span>)</span></span>;</span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">data</span>);</span></span>
        }</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_cert</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Creates a new and un-signed (empty) X509 certificate. Useful for generating
        X509 certificates programatically.
            
    *******************************************************************************/</span>
    <span class="d Constructor"><span class="k">this</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Paren">(<span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_new</span></span>()</span></span>)</span> !<span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_set_version</span></span></span>(<span class="i">_cert</span>, <span class="n">2</span>)</span>) <span class="lc">// 2 == Version 3</span>
            <span class="s Scope"><span class="s Compound">{
                <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_free</span></span>(<span class="i">_cert</span>);</span></span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
            }</span></span>
            <span class="k">else</span>
                <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">readOnly</span></span> = <span class="e Bool"><span class="k">false</span></span></span>;</span></span></span>
        }</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">_cert</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>

    <span class="d Destructor">~<span class="k">this</span>()
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e AndAnd"><span class="e Identifier"><span class="i">_cert</span></span> &amp;&amp; <span class="e Identifier"><span class="i">freeIt</span></span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_free</span></span>(<span class="i">_cert</span>);</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">_cert</span></span> = <span class="e Null"><span class="k">null</span></span></span>;</span>
        }</span></span></span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Sets the serial number of the new unsigned certificate.

        Note, this serial number should be unique for all certificates signed
        by the provided certificate authority. Having two Certificates with the
        same serial number can cause problems with web browsers and other apps
        because they will be different certificates.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">serialNumber</span><span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">uint</span></span> <span class="i">serial</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">checkFlag</span></span>()</span>;</span>
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">ASN1_INTEGER_set</span></span></span>(<span class="i">X509_get_serialNumber</span>(<span class="i">_cert</span>), <span class="i">serial</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>
    <span class="bc">/*******************************************************************************

        Returns the serial number of the Certificate
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">uint</span></span> <span class="i">serialNumber</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_get_serialNumber</span></span></span>(<span class="i">_cert</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Identifier"><span class="i">ASN1_INTEGER_get</span></span>(<span class="i">X509_get_serialNumber</span>(<span class="i">_cert</span>))</span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        If the current date is "before" the date set here, the certificate will be
        invalid.

        Params:
            t = A TimeSpan representing the earliest time the Certificate will be valid

        Example:
            cert.dateBeforeOffset = TimeSpan.seconds(-86400); // Certificate is invalid before yesterday
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">dateBeforeOffset</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">TimeSpan</span></span> <span class="i">t</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">checkFlag</span></span>()</span>;</span>
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_gmtime_adj</span></span></span>(<span class="i">X509_get_notBefore</span>(<span class="i">_cert</span>), <span class="k">cast</span>(<span class="k">int</span>)<span class="i">t</span>.<span class="i">seconds</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        If the current date is "after" the date set here, the certificate will be
        invalid.

        Params:
            t = A TimeSpan representing the amount of time from now that the
            Certificate will be valid. This must be larger than dateBefore

        Example:
            cert.dateAfterOffset = TimeSpan.seconds(86400 * 365); // Certificate is valid up to one year from now
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">dateAfterOffset</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">TimeSpan</span></span> <span class="i">t</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">checkFlag</span></span>()</span>;</span>
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_gmtime_adj</span></span></span>(<span class="i">X509_get_notAfter</span>(<span class="i">_cert</span>), <span class="k">cast</span>(<span class="k">int</span>)<span class="i">t</span>.<span class="i">seconds</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    
    <span class="bc">/*******************************************************************************

        Returns the dateAfter field of the certificate in ASN1_GENERALIZEDTIME.

        Note, this will eventually befome a DateTime struct.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">dateAfter</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">rtn</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">ASN1_GENERALIZEDTIME</span></span> <span class="t Pointer">*</span><span class="i">genTime</span> = <span class="e Call"><span class="e Identifier"><span class="i">ASN1_TIME_to_generalizedtime</span></span>(<span class="i">X509_get_notAfter</span>(<span class="i">_cert</span>), <span class="k">null</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">genTime</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">genTime</span></span>.<span class="e Identifier"><span class="i">data</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">genTime</span></span>.<span class="e Identifier"><span class="i">length</span></span>]</span>.<span class="e Identifier"><span class="i">dup</span></span></span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">ASN1_STRING_free</span></span>(<span class="k">cast</span>(<span class="i">ASN1_STRING</span>*)<span class="i">genTime</span>)</span>;</span>
        }</span></span></span>

        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Returns the dateBefore field of the certificate in ASN1_GENERALIZEDTIME.

        Note, this will eventually befome a DateTime struct.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">dateBefore</span><span class="o Parameters">()</span>    
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">rtn</span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">ASN1_GENERALIZEDTIME</span></span> <span class="t Pointer">*</span><span class="i">genTime</span> = <span class="e Call"><span class="e Identifier"><span class="i">ASN1_TIME_to_generalizedtime</span></span>(<span class="i">X509_get_notBefore</span>(<span class="i">_cert</span>), <span class="k">null</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">genTime</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">genTime</span></span>.<span class="e Identifier"><span class="i">data</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">genTime</span></span>.<span class="e Identifier"><span class="i">length</span></span>]</span>.<span class="e Identifier"><span class="i">dup</span></span></span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">ASN1_STRING_free</span></span>(<span class="k">cast</span>(<span class="i">ASN1_STRING</span>*)<span class="i">genTime</span>)</span>;</span>
        }</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Sets the public/private keypair of an unsigned certificate.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">privateKey</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">PrivateKey</span></span> <span class="i">key</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">checkFlag</span></span>()</span>;</span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">key</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_set_pubkey</span></span></span>(<span class="i">_cert</span>, <span class="i">key</span>.<span class="i">_evpKey</span>)</span>)
                <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        }</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Sets the subject (who this certificate is for) of an unsigned certificate.

        The country code must be a valid two-letter country code (ie: CA, US, etc)

        Params:
        country = the two letter country code of the subject
        stateProvince = the state or province of the subject
        city = the city the subject belong to
        organization = the organization the subject belongs to
        cn = the cn of the subject. For websites, this should be the website url
        or a wildcard version of it (ie: *.dsource.org)
        organizationUnit = the optional orgnizationalUnit of the subject
        email = the optional email address of the subject

    *******************************************************************************/</span>

    <span class="lc">// this kinda sucks.. but it has to be done in a certain order..</span>
    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">setSubject</span><span class="o Parameters">(<span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">country</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">stateProvince</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">city</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">organization</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">cn</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">organizationalUnit</span> = <span class="e Null"><span class="k">null</span></span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">email</span> = <span class="e Null"><span class="k">null</span></span></span>)</span>
    <span class="s FuncBody"><span class="k">in</span>
    <span class="s Compound">{
        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">country</span></span>)</span>;</span>
        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">stateProvince</span></span>)</span>;</span>
        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">organization</span></span>)</span>;</span>
        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">cn</span></span>)</span>;</span>
    }</span>
    <span class="k">body</span>
    <span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">checkFlag</span></span>()</span>;</span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_NAME</span></span> <span class="t Pointer">*</span><span class="i">name</span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_get_subject_name</span></span>(<span class="i">_cert</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">name</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"C"</span>, <span class="i">country</span>)</span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"ST"</span>, <span class="i">stateProvince</span>)</span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"L"</span>, <span class="i">city</span>)</span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"O"</span>, <span class="i">organization</span>)</span>;</span>
            <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">organizationalUnit</span></span> !<span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
                <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"OU"</span>, <span class="i">organizationalUnit</span>)</span>;</span></span></span>
            <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">email</span></span>) <span class="lc">// this might have to go after the CN</span>
                <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"emailAddress"</span>, <span class="i">email</span>)</span>;</span></span></span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">addNameEntry</span></span>(<span class="i">name</span>, <span class="sl">"CN"</span>, <span class="i">cn</span>)</span>;</span>
        }</span></span>
        <span class="k">else</span>
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Returns the Certificate subject in a multi-line string.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">subject</span><span class="o Parameters">()</span> <span class="lc">// currently multi-line, could be single-line..</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">rtn</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_NAME</span></span> <span class="t Pointer">*</span><span class="i">subjectName</span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_get_subject_name</span></span>(<span class="i">_cert</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">subjectName</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">subjectBIO</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new</span></span>(<span class="i">BIO_s_mem</span>())</span>;</span></span>
            <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">subjectBIO</span></span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">X509_NAME_print_ex</span></span>(<span class="i">subjectBIO</span>, <span class="i">subjectName</span>, <span class="n">0</span>, <span class="i">XN_FLAG_MULTILINE</span>)</span>)
                <span class="s Scope"><span class="s Compound">{
                    <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span> <span class="t Pointer">*</span><span class="i">subjectPtr</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
                    <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">length</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_get_mem_data</span></span>(<span class="i">subjectBIO</span>, &amp;<span class="i">subjectPtr</span>)</span>;</span></span>
                    <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Cond"><span class="e Identifier"><span class="i">subjectPtr</span></span> ? <span class="e Slice"><span class="e Identifier"><span class="i">subjectPtr</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">length</span></span>]</span>.<span class="e Identifier"><span class="i">dup</span></span> : <span class="e Null"><span class="k">null</span></span></span></span>;</span>
                }</span></span></span>
                <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">subjectBIO</span>);</span></span>
            }</span></span></span>
        }</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Signs the unsigned Certificate with the specified CA X509 Certificate and
        it's corresponding public/private keypair.

        Once the Certificate is signed, it can no longer be modified.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">sign</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">Certificate</span></span> <span class="i">caCert</span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">PrivateKey</span></span> <span class="i">caKey</span></span>)</span>
    <span class="s FuncBody"><span class="k">in</span>
    <span class="s Compound">{
        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">caCert</span></span>)</span>;</span>
        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">caKey</span></span>)</span>;</span>
    }</span>
    <span class="k">body</span>
    <span class="s Compound">{
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">checkFlag</span></span>()</span>;</span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_NAME</span></span> <span class="t Pointer">*</span><span class="i">issuer</span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_get_subject_name</span></span>(<span class="i">caCert</span>.<span class="i">_cert</span>)</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">issuer</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">X509_set_issuer_name</span></span>(<span class="i">_cert</span>, <span class="i">issuer</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">X509_sign</span></span>(<span class="i">_cert</span>, <span class="i">caKey</span>.<span class="i">_evpKey</span>, <span class="i">EVP_sha1</span>())</span>)
                    <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">readOnly</span></span> = <span class="e Bool"><span class="k">true</span></span></span>;</span></span></span>
            }</span></span></span>
        }</span></span></span>

        <span class="s If"><span class="k">if</span> (<span class="e Not">!<span class="e Identifier"><span class="i">readOnly</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e This"><span class="k">this</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Checks if the underlying data structur of the Certificate is equal
            
    *******************************************************************************/</span>

    <span class="d StorageClass"><span class="k">override</span></span> <span class="d Function"><span class="t Integral"><span class="k">bool</span></span> <span class="i">opEquals</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">Object</span></span> <span class="i">obj</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">c</span> = <span class="e Cast"><span class="k">cast</span>(<span class="t Identifier"><span class="i">Certificate</span></span>)<span class="e Identifier"><span class="i">obj</span></span></span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">c</span></span> !<span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_cmp</span></span></span>(<span class="i">c</span>.<span class="i">_cert</span>, <span class="k">this</span>.<span class="i">_cert</span>)</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Bool"><span class="k">false</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Verifies that the Certificate was signed and issues by a CACert in the 
        passed CertificateStore.

        This will also verify the dateBefore and dateAfter fields to see if the
        current date falls between them.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">bool</span></span> <span class="i">verify</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">CertificateStore</span></span> <span class="i">store</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">bool</span></span> <span class="i">rtn</span> = <span class="e Bool"><span class="k">false</span></span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_STORE_CTX</span></span> <span class="t Pointer">*</span><span class="i">verifyCtx</span> = <span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_CTX_new</span></span>()</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">verifyCtx</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">X509_STORE_CTX_init</span></span>(<span class="i">verifyCtx</span>, <span class="i">store</span>.<span class="i">_store</span>, <span class="i">_cert</span>, <span class="k">null</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">X509_verify_cert</span></span>(<span class="i">verifyCtx</span>)</span>)
                    <span class="s Scope"><span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Bool"><span class="k">true</span></span></span>;</span></span></span>
            }</span></span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">X509_STORE_CTX_free</span></span>(<span class="i">verifyCtx</span>);</span></span>
        }</span></span></span>

        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>
    }</span></span></span>

    <span class="bc">/*******************************************************************************

        Returns the Certificate in a PEM encoded string.
            
    *******************************************************************************/</span>

    <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pemFormat</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">rtn</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO</span></span> <span class="t Pointer">*</span><span class="i">bp</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_new</span></span>(<span class="i">BIO_s_mem</span>())</span>;</span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">bp</span></span>)
        <span class="s Scope"><span class="s Compound">{
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">PEM_write_bio_X509</span></span>(<span class="i">bp</span>, <span class="i">_cert</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span> <span class="t Pointer">*</span><span class="i">pemData</span> = <span class="e Null"><span class="k">null</span></span>;</span></span>
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">int</span></span> <span class="i">pemSize</span> = <span class="e Call"><span class="e Identifier"><span class="i">BIO_get_mem_data</span></span>(<span class="i">bp</span>, &amp;<span class="i">pemData</span>)</span>;</span></span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">rtn</span></span> = <span class="e Slice"><span class="e Identifier"><span class="i">pemData</span></span>[<span class="e Int"><span class="n">0</span></span>..<span class="e Identifier"><span class="i">pemSize</span></span>]</span>.<span class="e Identifier"><span class="i">dup</span></span></span>;</span>
            }</span></span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">BIO_free_all</span></span>(<span class="i">bp</span>);</span></span>
        }</span></span></span>
        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">rtn</span></span> <span class="k">is</span> <span class="e Null"><span class="k">null</span></span></span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">rtn</span></span>;</span>    
    }</span></span></span>

    <span class="d Protection"><span class="k">private</span></span> <span class="d Function"><span class="t Integral"><span class="k">void</span></span> <span class="i">addNameEntry</span><span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">X509_NAME</span></span> <span class="t Pointer">*</span><span class="i">name</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span> <span class="t Pointer">*</span><span class="i">type</span></span>, <span class="o Parameter"><span class="t Const"><span class="k">const</span>(<span class="t Integral"><span class="k">char</span></span>)</span><span class="t Array">[]</span> <span class="i">value</span></span>)</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">X509_NAME_add_entry_by_txt</span></span></span>(<span class="i">name</span>, <span class="i">type</span>, <span class="i">MBSTRING_ASC</span>, <span class="i">toStringz</span>(<span class="i">value</span>), <span class="k">cast</span>(<span class="k">int</span>) <span class="i">value</span>.<span class="i">length</span>, -<span class="n">1</span>, <span class="n">0</span>)</span>)
            <span class="s Scope"><span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">throwOpenSSLError</span></span>()</span>;</span></span></span>
    }</span></span></span>

    <span class="d Protection"><span class="k">private</span></span> <span class="d Function"><span class="t Integral"><span class="k">void</span></span> <span class="i">checkFlag</span><span class="o Parameters">()</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">readOnly</span></span>)
            <span class="s Scope"><span class="s Throw"><span class="k">throw</span> <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Exception</span></span>(<span class="e String"><span class="sl">"The cert is signed already, and cannot be modified."</span></span>)</span>;</span></span></span>
    }</span></span></span>
}</span></span>


<span class="d Version"><span class="k">version</span> (<span class="i">Test</span>)
<span class="d Compound">{
    <span class="d Import"><span class="k">import</span> <span class="i">util</span>.<span class="i">Test</span>;</span>
    <span class="d Import"><span class="k">import</span> <span class="i">tango</span>.<span class="i">io</span>.<span class="i">Stdout</span>;</span>

    <span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">t1</span> = <span class="e Identifier"><span class="i">TimeSpan</span></span>.<span class="e Identifier"><span class="i">zero</span></span>;</span>
    <span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">t2</span> = <span class="e Call"><span class="e Identifier"><span class="i">TimeSpan</span></span>.<span class="e Identifier"><span class="i">fromDays</span></span>(<span class="n">365</span>)</span>;</span> <span class="lc">// can't set this up in delegate ..??</span>
    <span class="d Unittest"><span class="k">unittest</span>
    <span class="s FuncBody"><span class="s Compound">{
        <span class="s Declaration"><span class="d Function"><span class="t Identifier"><span class="i">Test</span></span>.<span class="t Identifier"><span class="i">Status</span></span> <span class="i">_pkeyGenTest</span><span class="o Parameters">(<span class="o Parameter"><span class="k">ref</span> <span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span><span class="t Array">[]</span> <span class="i">messages</span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pkey</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pem</span> = <span class="e Identifier"><span class="i">pkey</span></span>.<span class="e Identifier"><span class="i">pemFormat</span></span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pkey2</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Identifier"><span class="i">pem</span></span>)</span>;</span></span>
            <span class="s If"><span class="k">if</span> (<span class="e Equal"><span class="e Identifier"><span class="i">pkey</span></span> == <span class="e Identifier"><span class="i">pkey2</span></span></span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pkey3</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pem2</span> = <span class="e Call"><span class="e Identifier"><span class="i">pkey3</span></span>.<span class="e Identifier"><span class="i">pemFormat</span></span>(<span class="sl">"hello"</span>)</span>;</span></span>
                <span class="s Try"><span class="k">try</span>
                    <span class="s Scope"><span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pkey4</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Identifier"><span class="i">pem2</span></span>, <span class="e String"><span class="sl">"badpass"</span></span>)</span>;</span></span></span>
                <span class="s Catch"><span class="k">catch</span> (<span class="o Parameter"><span class="t Identifier"><span class="i">Exception</span></span> <span class="i">ex</span></span>)
                <span class="s Compound">{
                    <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pkey4</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Identifier"><span class="i">pem2</span></span>, <span class="e String"><span class="sl">"hello"</span></span>)</span>;</span></span>
                    <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Success</span></span>;</span>
                }</span></span></span>
            }</span></span></span>
                
            <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Failure</span></span>;</span>
        }</span></span></span></span>

        <span class="s Declaration"><span class="d Function"><span class="t Identifier"><span class="i">Test</span></span>.<span class="t Identifier"><span class="i">Status</span></span> <span class="i">_certGenTest</span><span class="o Parameters">(<span class="o Parameter"><span class="k">ref</span> <span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span><span class="t Array">[]</span> <span class="i">messages</span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">cert</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Certificate</span></span>()</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pkey</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
            <span class="s Expression"><span class="e Call"><span class="e Call"><span class="e Call"><span class="e Call"><span class="e Identifier"><span class="i">cert</span></span>.<span class="e Identifier"><span class="i">privateKey</span></span>(<span class="i">pkey</span>)</span>.<span class="e Identifier"><span class="i">serialNumber</span></span>(<span class="n">123</span>)</span>.<span class="e Identifier"><span class="i">dateBeforeOffset</span></span>(<span class="i">t1</span>)</span>.<span class="e Identifier"><span class="i">dateAfterOffset</span></span>(<span class="i">t2</span>)</span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Call"><span class="e Identifier"><span class="i">cert</span></span>.<span class="e Identifier"><span class="i">setSubject</span></span>(<span class="sl">"CA"</span>, <span class="sl">"Alberta"</span>, <span class="sl">"Place"</span>, <span class="sl">"None"</span>, <span class="sl">"First Last"</span>, <span class="sl">"no unit"</span>, <span class="sl">"email@example.com"</span>)</span>.<span class="e Identifier"><span class="i">sign</span></span>(<span class="i">cert</span>, <span class="i">pkey</span>)</span>;</span>
            <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pemData</span> = <span class="e Identifier"><span class="i">cert</span></span>.<span class="e Identifier"><span class="i">pemFormat</span></span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">cert2</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Certificate</span></span>(<span class="e Identifier"><span class="i">pemData</span></span>)</span>;</span></span>
<span class="lc">//            Stdout.formatln("{}\n{}\n{}\n{}", cert2.serialNumber, cert2.subject, cert2.dateBefore, cert2.dateAfter);</span>
            <span class="s If"><span class="k">if</span> (<span class="e Equal"><span class="e Identifier"><span class="i">cert2</span></span> == <span class="e Identifier"><span class="i">cert</span></span></span>)
                <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Success</span></span>;</span></span></span>
            <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Failure</span></span>;</span>
        }</span></span></span></span>

        <span class="s Declaration"><span class="d Function"><span class="t Identifier"><span class="i">Test</span></span>.<span class="t Identifier"><span class="i">Status</span></span> <span class="i">_chainValidation</span><span class="o Parameters">(<span class="o Parameter"><span class="k">ref</span> <span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span><span class="t Array">[]</span> <span class="i">messages</span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">caCert</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Certificate</span></span>()</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">caPkey</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">caCert</span></span>.<span class="e Identifier"><span class="i">serialNumber</span></span> = <span class="e Int"><span class="n">1</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">caCert</span></span>.<span class="e Identifier"><span class="i">privateKey</span></span> = <span class="e Identifier"><span class="i">caPkey</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">caCert</span></span>.<span class="e Identifier"><span class="i">dateBeforeOffset</span></span> = <span class="e Identifier"><span class="i">t1</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">caCert</span></span>.<span class="e Identifier"><span class="i">dateAfterOffset</span></span> = <span class="e Identifier"><span class="i">t2</span></span></span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">caCert</span></span>.<span class="e Identifier"><span class="i">setSubject</span></span>(<span class="sl">"CA"</span>, <span class="sl">"Alberta"</span>, <span class="sl">"CA Place"</span>, <span class="sl">"Super CACerts Anon"</span>, <span class="sl">"CA Manager"</span>)</span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">caCert</span></span>.<span class="e Identifier"><span class="i">sign</span></span>(<span class="i">caCert</span>, <span class="i">caPkey</span>)</span>;</span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">store</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">CertificateStore</span></span>()</span>;</span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">store</span></span>.<span class="t Identifier"><span class="i">add</span></span>(<span class="i">caCert</span>);</span></span>

            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">subCert</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Certificate</span></span>()</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">subPkey</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">serialNumber</span></span> = <span class="e Int"><span class="n">2</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">privateKey</span></span> = <span class="e Identifier"><span class="i">subPkey</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">dateBeforeOffset</span></span> = <span class="e Identifier"><span class="i">t1</span></span></span>;</span>
            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">dateAfterOffset</span></span> = <span class="e Identifier"><span class="i">t2</span></span></span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">setSubject</span></span>(<span class="sl">"US"</span>, <span class="sl">"California"</span>, <span class="sl">"Customer Place"</span>, <span class="sl">"Penny-Pincher"</span>, <span class="sl">"IT Director"</span>)</span>;</span>
            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">sign</span></span>(<span class="i">caCert</span>, <span class="i">caPkey</span>)</span>;</span>

            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">subCert</span></span>.<span class="e Identifier"><span class="i">verify</span></span>(<span class="i">store</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">fakeCert</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Certificate</span></span>()</span>;</span></span>
                <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">fakePkey</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">fakeCert</span></span>.<span class="e Identifier"><span class="i">serialNumber</span></span> = <span class="e Int"><span class="n">1</span></span></span>;</span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">fakeCert</span></span>.<span class="e Identifier"><span class="i">privateKey</span></span> = <span class="e Identifier"><span class="i">fakePkey</span></span></span>;</span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">fakeCert</span></span>.<span class="e Identifier"><span class="i">dateBeforeOffset</span></span> = <span class="e Identifier"><span class="i">t1</span></span></span>;</span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">fakeCert</span></span>.<span class="e Identifier"><span class="i">dateAfterOffset</span></span> = <span class="e Identifier"><span class="i">t2</span></span></span>;</span>
                <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">fakeCert</span></span>.<span class="e Identifier"><span class="i">setSubject</span></span>(<span class="sl">"CA"</span>, <span class="sl">"Alberta"</span>, <span class="sl">"CA Place"</span>, <span class="sl">"Super CACerts Anon"</span>, <span class="sl">"CA Manager"</span>)</span>;</span>
                <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">fakeCert</span></span>.<span class="e Identifier"><span class="i">sign</span></span>(<span class="i">caCert</span>, <span class="i">caPkey</span>)</span>;</span>
                <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">store2</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">CertificateStore</span></span>()</span>;</span></span>
                <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">subCert</span></span></span>.<span class="e Identifier"><span class="i">verify</span></span>(<span class="i">store2</span>)</span>)
                    <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Success</span></span>;</span></span></span>
            }</span></span></span>

            <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Failure</span></span>;</span>
        }</span></span></span></span>   

        <span class="s Declaration"><span class="d Function"><span class="t Identifier"><span class="i">Test</span></span>.<span class="t Identifier"><span class="i">Status</span></span> <span class="i">_rsaCrypto</span><span class="o Parameters">(<span class="o Parameter"><span class="k">ref</span> <span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span><span class="t Array">[]</span> <span class="i">messages</span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">key</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">2048</span></span>)</span>;</span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">pemData</span> = <span class="e Identifier"><span class="i">key</span></span>.<span class="e Identifier"><span class="i">publicKey</span></span>.<span class="e Identifier"><span class="i">pemFormat</span></span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">pub</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PublicKey</span></span>(<span class="e Identifier"><span class="i">pemData</span></span>)</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">encrypted</span> = <span class="e Call"><span class="e Identifier"><span class="i">pub</span></span>.<span class="e Identifier"><span class="i">encrypt</span></span>(<span class="k">cast</span>(<span class="k">ubyte</span>[])<span class="sl">"Hello, how are you today?"</span>)</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">decrypted</span> = <span class="e Call"><span class="e Identifier"><span class="i">key</span></span>.<span class="e Identifier"><span class="i">decrypt</span></span>(<span class="i">encrypted</span>)</span>;</span></span>
            <span class="s If"><span class="k">if</span> (<span class="e Equal"><span class="e Cast"><span class="k">cast</span>(<span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span>)<span class="e Identifier"><span class="i">decrypted</span></span></span> == <span class="e String"><span class="sl">"Hello, how are you today?"</span></span></span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">encrypted</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">key</span></span>.<span class="e Identifier"><span class="i">encrypt</span></span>(<span class="k">cast</span>(<span class="k">ubyte</span>[])<span class="sl">"Hello, how are you today, mister?"</span>)</span></span>;</span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">decrypted</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">pub</span></span>.<span class="e Identifier"><span class="i">decrypt</span></span>(<span class="i">encrypted</span>)</span></span>;</span>
                <span class="s If"><span class="k">if</span> (<span class="e Equal"><span class="e Cast"><span class="k">cast</span>(<span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span>)<span class="e Identifier"><span class="i">decrypted</span></span></span> == <span class="e String"><span class="sl">"Hello, how are you today, mister?"</span></span></span>)
                    <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Success</span></span>;</span></span></span>
            }</span></span></span>
            <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Failure</span></span>;</span>
        }</span></span></span></span>

        <span class="s Declaration"><span class="d Function"><span class="t Identifier"><span class="i">Test</span></span>.<span class="t Identifier"><span class="i">Status</span></span> <span class="i">_rsaSignVerify</span><span class="o Parameters">(<span class="o Parameter"><span class="k">ref</span> <span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span><span class="t Array">[]</span> <span class="i">messages</span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">key</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">1024</span></span>)</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">key2</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">PrivateKey</span></span>(<span class="e Int"><span class="n">1024</span></span>)</span>;</span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span> <span class="i">data</span> = <span class="e Cast"><span class="k">cast</span>(<span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[]</span>)<span class="e String"><span class="sl">"I am some special data, yes I am."</span></span></span>;</span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="e Int"><span class="n">512</span></span>]</span> <span class="i">sigBuf</span>;</span></span>
            <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">ubyte</span></span><span class="t Array">[<span class="e Int"><span class="n">512</span></span>]</span> <span class="i">sigBuf2</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">sig1</span> = <span class="e Call"><span class="e Identifier"><span class="i">key</span></span>.<span class="e Identifier"><span class="i">sign</span></span>(<span class="i">data</span>, <span class="i">sigBuf</span>)</span>;</span></span>
            <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">sig2</span> = <span class="e Call"><span class="e Identifier"><span class="i">key2</span></span>.<span class="e Identifier"><span class="i">sign</span></span>(<span class="i">data</span>, <span class="i">sigBuf2</span>)</span>;</span></span>
            <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">key</span></span>.<span class="e Identifier"><span class="i">publicKey</span></span>.<span class="e Identifier"><span class="i">verify</span></span>(<span class="i">data</span>, <span class="i">sig1</span>)</span>)
            <span class="s Scope"><span class="s Compound">{
                <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">key</span></span></span>.<span class="e Identifier"><span class="i">publicKey</span></span>.<span class="e Identifier"><span class="i">verify</span></span>(<span class="i">data</span>, <span class="i">sig2</span>)</span>)
                <span class="s Scope"><span class="s Compound">{
                    <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Identifier"><span class="i">key2</span></span>.<span class="e Identifier"><span class="i">publicKey</span></span>.<span class="e Identifier"><span class="i">verify</span></span>(<span class="i">data</span>, <span class="i">sig2</span>)</span>)
                    <span class="s Scope"><span class="s Compound">{
                        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">!<span class="e Identifier"><span class="i">key2</span></span></span>.<span class="e Identifier"><span class="i">publicKey</span></span>.<span class="e Identifier"><span class="i">verify</span></span>(<span class="i">data</span>, <span class="i">sig1</span>)</span>)
                            <span class="s Scope"><span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Success</span></span>;</span></span></span>
                    }</span></span></span>
                }</span></span></span>
            }</span></span></span>

            <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">Test</span></span>.<span class="e Identifier"><span class="i">Status</span></span>.<span class="e Identifier"><span class="i">Failure</span></span>;</span>
        }</span></span></span></span>


        <span class="s Declaration"><span class="d StorageClass"><span class="k">auto</span></span> <span class="d Variables"><span class="i">t</span> = <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">Test</span></span>(<span class="e String"><span class="sl">"tetra.net.PKI"</span></span>)</span>;</span></span>
        <span class="s Expression"><span class="e Assign"><span class="e Index"><span class="e Identifier"><span class="i">t</span></span>[<span class="e String"><span class="sl">"Public/Private Keypair"</span></span>]</span> = <span class="e Address">&amp;<span class="e Identifier"><span class="i">_pkeyGenTest</span></span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Index"><span class="e Identifier"><span class="i">t</span></span>[<span class="e String"><span class="sl">"Self-Signed Certificate"</span></span>]</span> = <span class="e Address">&amp;<span class="e Identifier"><span class="i">_certGenTest</span></span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Index"><span class="e Identifier"><span class="i">t</span></span>[<span class="e String"><span class="sl">"Chain Validation"</span></span>]</span> = <span class="e Address">&amp;<span class="e Identifier"><span class="i">_chainValidation</span></span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Index"><span class="e Identifier"><span class="i">t</span></span>[<span class="e String"><span class="sl">"RSA Crypto"</span></span>]</span> = <span class="e Address">&amp;<span class="e Identifier"><span class="i">_rsaCrypto</span></span></span></span>;</span>
        <span class="s Expression"><span class="e Assign"><span class="e Index"><span class="e Identifier"><span class="i">t</span></span>[<span class="e String"><span class="sl">"RSA sign/verify"</span></span>]</span> = <span class="e Address">&amp;<span class="e Identifier"><span class="i">_rsaSignVerify</span></span></span></span>;</span>
        <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">t</span></span>.<span class="e Identifier"><span class="i">run</span></span>()</span>;</span>
    }</span></span></span>
}</span></span></span>

</pre></td>
</tr></table>
</body>
</html>