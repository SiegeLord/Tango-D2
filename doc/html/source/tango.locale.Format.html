<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
	<head>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<title>/Format.d</title>
	</head>
	<body>

<table id='dcode'><tr><td id='lnum'><pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
<span>960</span>
<span>961</span>
<span>962</span>
<span>963</span>
<span>964</span>
<span>965</span>
<span>966</span>
<span>967</span>
<span>968</span>
<span>969</span>
<span>970</span>
<span>971</span>
<span>972</span>
<span>973</span>
<span>974</span>
<span>975</span>
<span>976</span>
<span>977</span>
<span>978</span>
<span>979</span>
<span>980</span>
<span>981</span>
<span>982</span>
<span>983</span>
<span>984</span>
<span>985</span>
<span>986</span>
<span>987</span>
<span>988</span>
<span>989</span>
<span>990</span>
<span>991</span>
<span>992</span>
<span>993</span>
<span>994</span>
<span>995</span>
<span>996</span>
<span>997</span>
<span>998</span>
<span>999</span>
<span>1000</span>
<span>1001</span>
<span>1002</span>
<span>1003</span>
<span>1004</span>
<span>1005</span>
<span>1006</span>
<span>1007</span>
<span>1008</span>
<span>1009</span>
<span>1010</span>
<span>1011</span>
<span>1012</span>
<span>1013</span>
<span>1014</span>
<span>1015</span>
<span>1016</span>
<span>1017</span>
<span>1018</span>
<span>1019</span>
<span>1020</span>
<span>1021</span>
<span>1022</span>
<span>1023</span>
<span>1024</span>
<span>1025</span>
<span>1026</span>
<span>1027</span>
<span>1028</span>
<span>1029</span>
<span>1030</span>
<span>1031</span>
<span>1032</span>
<span>1033</span>
<span>1034</span>
<span>1035</span>
<span>1036</span>
<span>1037</span>
<span>1038</span>
<span>1039</span>
<span>1040</span>
<span>1041</span>
<span>1042</span>
<span>1043</span>
<span>1044</span>
<span>1045</span>
<span>1046</span>
<span>1047</span>
<span>1048</span>
<span>1049</span>
<span>1050</span>
<span>1051</span>
<span>1052</span>
<span>1053</span>
<span>1054</span>
<span>1055</span>
<span>1056</span>
<span>1057</span>
<span>1058</span>
<span>1059</span>
<span>1060</span>
<span>1061</span>
<span>1062</span>
<span>1063</span>
<span>1064</span>
<span>1065</span>
<span>1066</span>
<span>1067</span>
<span>1068</span>
<span>1069</span>
<span>1070</span>
<span>1071</span>
<span>1072</span>
<span>1073</span>
<span>1074</span>
<span>1075</span>
<span>1076</span>
<span>1077</span>
<span>1078</span>
<span>1079</span>
<span>1080</span>
<span>1081</span>
<span>1082</span>
<span>1083</span>
<span>1084</span>
<span>1085</span>
<span>1086</span>
<span>1087</span>
<span>1088</span>
<span>1089</span>
<span>1090</span>
<span>1091</span>
<span>1092</span>
<span>1093</span>
<span>1094</span>
<span>1095</span>
<span>1096</span>
<span>1097</span>
<span>1098</span>
<span>1099</span>
<span>1100</span>
<span>1101</span>
<span>1102</span>
<span>1103</span>
<span>1104</span>
<span>1105</span>
<span>1106</span>
<span>1107</span>
<span>1108</span>
<span>1109</span>
<span>1110</span>
<span>1111</span>
<span>1112</span>
<span>1113</span>
<span>1114</span>
<span>1115</span>
<span>1116</span>
<span>1117</span>
<span>1118</span>
<span>1119</span>
<span>1120</span>
<span>1121</span>
<span>1122</span>
<span>1123</span>
<span>1124</span>
<span>1125</span>
<span>1126</span>
<span>1127</span>
<span>1128</span>
<span>1129</span>
<span>1130</span>
<span>1131</span>
<span>1132</span>
<span>1133</span>
<span>1134</span>
<span>1135</span>
<span>1136</span>
<span>1137</span>
<span>1138</span>
<span>1139</span>
<span>1140</span>
<span>1141</span>
<span>1142</span>
<span>1143</span>
<span>1144</span>
<span>1145</span>
<span>1146</span>
<span>1147</span>
<span>1148</span>
<span>1149</span>
<span>1150</span>
<span>1151</span>
<span>1152</span>
<span>1153</span>
<span>1154</span>
<span>1155</span>
<span>1156</span>
<span>1157</span>
<span>1158</span>
<span>1159</span>
<span>1160</span>
<span>1161</span>
<span>1162</span>
<span>1163</span>
<span>1164</span>
<span>1165</span>
<span>1166</span>
<span>1167</span>
<span>1168</span>
<span>1169</span>
<span>1170</span>
<span>1171</span>
<span>1172</span>
<span>1173</span>
<span>1174</span>
<span>1175</span>
<span>1176</span>
<span>1177</span>
<span>1178</span>
<span>1179</span>
<span>1180</span>
<span>1181</span>
<span>1182</span>
<span>1183</span>
<span>1184</span>
<span>1185</span>
<span>1186</span>
<span>1187</span>
<span>1188</span>
<span>1189</span>
<span>1190</span>
<span>1191</span>
<span>1192</span>
<span>1193</span>
<span>1194</span>
<span>1195</span>
<span>1196</span>
<span>1197</span>
<span>1198</span>
<span>1199</span>
<span>1200</span>
<span>1201</span>
<span>1202</span>
<span>1203</span>
<span>1204</span>
<span>1205</span>
<span>1206</span>
<span>1207</span>
<span>1208</span>
<span>1209</span>
<span>1210</span>
<span>1211</span>
<span>1212</span>
<span>1213</span>
<span>1214</span>
<span>1215</span>
<span>1216</span>
<span>1217</span>
<span>1218</span>
<span>1219</span>
<span>1220</span>
<span>1221</span>
<span>1222</span>
<span>1223</span>
<span>1224</span>
<span>1225</span>
<span>1226</span>
<span>1227</span>
<span>1228</span>
<span>1229</span>
<span>1230</span>
<span>1231</span>
<span>1232</span>
<span>1233</span>
<span>1234</span>
<span>1235</span>
<span>1236</span>
<span>1237</span>
<span>1238</span>
<span>1239</span>
<span>1240</span>
<span>1241</span>
<span>1242</span>
<span>1243</span>
<span>1244</span>
<span>1245</span>
<span>1246</span>
<span>1247</span>
<span>1248</span>
<span>1249</span>
<span>1250</span>
<span>1251</span>
<span>1252</span>
<span>1253</span>
<span>1254</span>
<span>1255</span>
<span>1256</span>
<span>1257</span>
<span>1258</span>
<span>1259</span>
<span>1260</span>
<span>1261</span>
<span>1262</span>
<span>1263</span>
<span>1264</span>
<span>1265</span>
<span>1266</span>
<span>1267</span>
<span>1268</span>
<span>1269</span>
<span>1270</span>
<span>1271</span>
<span>1272</span>
<span>1273</span>
<span>1274</span>
<span>1275</span>
<span>1276</span>
<span>1277</span>
<span>1278</span>
<span>1279</span>
<span>1280</span>
<span>1281</span>
<span>1282</span>
<span>1283</span>
<span>1284</span>
<span>1285</span>
<span>1286</span>
<span>1287</span>
<span>1288</span>
<span>1289</span>
<span>1290</span>
<span>1291</span>
<span>1292</span>
<span>1293</span>
<span>1294</span>
<span>1295</span>
<span>1296</span>
<span>1297</span>
<span>1298</span>
<span>1299</span>
<span>1300</span>
<span>1301</span>
<span>1302</span>
<span>1303</span>
<span>1304</span>
<span>1305</span>
<span>1306</span>
<span>1307</span>
<span>1308</span>
<span>1309</span>
<span>1310</span>
<span>1311</span>
<span>1312</span>
<span>1313</span>
<span>1314</span>
<span>1315</span>
<span>1316</span>
<span>1317</span>
<span>1318</span>
<span>1319</span>
<span>1320</span>
<span>1321</span>
<span>1322</span>
<span>1323</span>
<span>1324</span>
<span>1325</span>
<span>1326</span>
<span>1327</span>
<span>1328</span>
<span>1329</span>
<span>1330</span>
<span>1331</span>
<span>1332</span>
<span>1333</span>
<span>1334</span>
<span>1335</span>
<span>1336</span>
<span>1337</span>
<span>1338</span>
<span>1339</span>
<span>1340</span>
<span>1341</span>
<span>1342</span>
<span>1343</span>
<span>1344</span>
<span>1345</span>
<span>1346</span>
<span>1347</span>
<span>1348</span>
<span>1349</span>
<span>1350</span>
<span>1351</span>
<span>1352</span>
<span>1353</span>
<span>1354</span>
<span>1355</span>
<span>1356</span>
<span>1357</span>
<span>1358</span>
<span>1359</span>
<span>1360</span>
<span>1361</span>
<span>1362</span>
<span>1363</span>
<span>1364</span>
<span>1365</span>
<span>1366</span>
<span>1367</span>
<span>1368</span>
<span>1369</span>
<span>1370</span>
<span>1371</span>
<span>1372</span>
<span>1373</span>
<span>1374</span>
<span>1375</span>
<span>1376</span>
<span>1377</span>
<span>1378</span>
<span>1379</span>
<span>1380</span>
<span>1381</span>
<span>1382</span>
</pre></td><td id='code'><pre><span class='com'>/**
  This module provides a general-purpose formatting system to convert values to strings suitable for display. There is support
  for alignment and justification, common _format specifiers for numbers and date/time data, and culture-specific output.
  Custom formats are also supported.

  The _format notation is influenced by that used in the .NET framework rather than the C-style printf or D-style writef.

  Examples:
  --------
  // Format with the user's current culture (for example, en-GB).
  Formatter.format(&quot;General: {0} Hexadecimal: 0x{0:x4} Numeric: {0:N}&quot;, 1000);
  // -&gt; General: 1000 Hexadecimal: 0x03e8 Numeric: 1,000.00

  // Format using a custom display format, substituting groups with those 
  // appropriate for Germany.
  Formatter.format(Culture.getCulture(&quot;de-DE&quot;), &quot;{0:#,#}&quot;, 12345678);
  // -&gt; 12.345.678

  // Format as a monetary value appropriate for Spain.
  Formatter.format(Culture.getCulture(&quot;es-ES&quot;), &quot;{0:C}&quot;, 59.99);
  // -&gt; 59,99 ¬

  // Format today's date as appropriate for France.
  Formatter.format(Culture.getCulture(&quot;fr-FR&quot;), &quot;{0:D}&quot;, DateTime.today);
  // -&gt; vendredi 3 mars 2006
  --------
**/</span>
<span class='kw2'>module</span> tango.locale.Format;

<span class='kw4'>private</span> <span class='kw2'>import</span>  tango.locale.Core,
                tango.locale.Constants;

<span class='kw4'>version</span> <span class='opr'>(</span>mlfp<span class='opr'>)</span>
<span class='com'>// For Number.opCall(double).</span>
<span class='kw2'>extern</span> <span class='opr'>(</span>C<span class='opr'>)</span>
<span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>*</span> ecvt<span class='opr'>(</span><span class='kw4'>double</span> d, <span class='kw4'>int</span> digits, <span class='kw2'>out</span> <span class='kw4'>int</span> decpt, <span class='kw2'>out</span> <span class='kw4'>bool</span> sign<span class='opr'>)</span>;

<span class='kw4'>package</span> <span class='kw4'>enum</span> TypeCode <span class='opr'>{</span>
  EMPTY <span class='opr'>=</span> <span class='nbr'>0</span>,
  BOOL <span class='opr'>=</span> <span class='str'>'x'</span>,
  UBYTE <span class='opr'>=</span> <span class='str'>'h'</span>,
  BYTE <span class='opr'>=</span> <span class='str'>'g'</span>,
  USHORT <span class='opr'>=</span> <span class='str'>'t'</span>,
  SHORT <span class='opr'>=</span> <span class='str'>'s'</span>,
  UINT <span class='opr'>=</span> <span class='str'>'k'</span>,
  INT <span class='opr'>=</span> <span class='str'>'i'</span>,
  ULONG <span class='opr'>=</span> <span class='str'>'m'</span>,
  LONG <span class='opr'>=</span> <span class='str'>'l'</span>,
  FLOAT <span class='opr'>=</span> <span class='str'>'f'</span>,
  DOUBLE <span class='opr'>=</span> <span class='str'>'d'</span>,
  CHAR <span class='opr'>=</span> <span class='str'>'a'</span>,
  ARRAY <span class='opr'>=</span> <span class='str'>'A'</span>,
  CLASS <span class='opr'>=</span> <span class='str'>'C'</span>,
  STRUCT <span class='opr'>=</span> <span class='str'>'S'</span>,
  ENUM <span class='opr'>=</span> <span class='str'>'E'</span>,
  POINTER <span class='opr'>=</span> <span class='str'>'P'</span>
<span class='opr'>}</span>

<span class='com'>// Wraps a variadic argument.</span>
<span class='kw4'>package</span> <span class='kw4'>struct</span> Argument <span class='opr'>{</span>

  <span class='kw4'>private</span> <span class='kw3'>TypeInfo</span> type_;
  <span class='kw4'>private</span> <span class='kw4'>void</span><span class='opr'>*</span> value_;
  <span class='kw4'>private</span> TypeCode typeCode_;

  <span class='kw4'>public</span> <span class='kw4'>static</span> Argument opCall<span class='opr'>(</span><span class='kw3'>TypeInfo</span> type, <span class='kw4'>void</span><span class='opr'>*</span> value<span class='opr'>)</span> <span class='opr'>{</span>
    Argument arg;
    <span class='kw1'>return</span> arg.type_ <span class='opr'>=</span> type, arg.value_ <span class='opr'>=</span> value, arg.typeCode_ <span class='opr'>=</span> <span class='kw2'>cast</span><span class='opr'>(</span>TypeCode<span class='opr'>)</span>type.classinfo.name<span class='opr'>[</span><span class='nbr'>9</span><span class='opr'>]</span>, arg;
  <span class='opr'>}</span>

  <span class='kw4'>public</span> <span class='kw4'>final</span> <span class='kw3'>TypeInfo</span> getType<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>return</span> type_;
  <span class='opr'>}</span>

  <span class='kw4'>public</span> <span class='kw4'>final</span> TypeCode getTypeCode<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>return</span> typeCode_;
  <span class='opr'>}</span>

  <span class='kw4'>public</span> <span class='kw4'>final</span> <span class='kw4'>void</span><span class='opr'>*</span> getValue<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>return</span> value_;
  <span class='opr'>}</span>

<span class='opr'>}</span>

<span class='com'>// Wraps variadic arguments.</span>
<span class='kw4'>package</span> <span class='kw4'>struct</span> ArgumentIterator <span class='opr'>{</span>

  <span class='kw4'>private</span> Argument<span class='opr'>[</span><span class='opr'>]</span> args_;
  <span class='kw4'>private</span> <span class='kw4'>int</span> size_;

  <span class='kw4'>public</span> <span class='kw4'>static</span> ArgumentIterator opCall<span class='opr'>(</span><span class='kw3'>TypeInfo</span><span class='opr'>[</span><span class='opr'>]</span> types, <span class='kw4'>void</span><span class='opr'>*</span> argptr<span class='opr'>)</span> <span class='opr'>{</span>
    ArgumentIterator it;
    <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw3'>TypeInfo</span> type; types<span class='opr'>)</span> <span class='opr'>{</span>
      it.args_ <span class='opr'>~=</span> Argument<span class='opr'>(</span>type, argptr<span class='opr'>)</span>;
      argptr <span class='opr'>+=</span> <span class='opr'>(</span>type.tsize<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>+</span> <span class='kw4'>int</span>.sizeof <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='opr'>&amp;</span> <span class='opr'>~</span><span class='opr'>(</span><span class='kw4'>int</span>.sizeof <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span>;
      it.size_<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='opr'>}</span>
    <span class='kw1'>return</span> it;
  <span class='opr'>}</span>

  <span class='kw4'>public</span> Argument opIndex<span class='opr'>(</span><span class='kw4'>int</span> index<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>return</span> args_<span class='opr'>[</span>index<span class='opr'>]</span>;
  <span class='opr'>}</span>

  <span class='kw4'>public</span> <span class='kw4'>int</span> count<span class='opr'>(</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>return</span> size_;
  <span class='opr'>}</span>

  <span class='kw4'>public</span> <span class='kw4'>int</span> opApply<span class='opr'>(</span><span class='kw4'>int</span> <span class='kw2'>delegate</span><span class='opr'>(</span><span class='kw2'>inout</span> Argument<span class='opr'>)</span> del<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>int</span> r;
    <span class='kw1'>foreach</span> <span class='opr'>(</span>Argument arg; args_<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>r <span class='opr'>=</span><span class='opr'>=</span> del<span class='opr'>(</span>arg<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
        <span class='kw1'>break</span>;
    <span class='opr'>}</span>
    <span class='kw1'>return</span> r;
  <span class='opr'>}</span>

<span class='opr'>}</span>

<span class='com'>/**
 * Contains methods for replacing format items in a string with string equivalents of each argument.
 * Remarks: This struct is not intended to be instantiated. It is a container for various methods.
**/</span>
<span class='kw4'>public</span> <span class='kw4'>struct</span> Formatter <span class='opr'>{</span>

  <span class='com'>/**
   * Replaces the _format item in a string with the string equivalent of each argument.
   * Params:
   *   formatStr  = A string containing _format items.
   *   args       = A list of arguments.
   * Returns: A copy of formatStr in which the items have been replaced by the string equivalent of the arguments.
   * Remarks: The formatStr parameter is embedded with _format items of the form: $(BR)$(BR)
   *   {index[,alignment][:_format-string]}$(BR)$(BR)
   *   $(UL $(LI index $(BR)
   *     An integer indicating the element in a list to _format.)
   *   $(LI alignment $(BR)
   *     An optional integer indicating the minimum width. The result is padded with spaces if the length of the value is less than alignment.)
   *   $(LI _format-string $(BR)
   *     An optional string of formatting codes.)
   * )$(BR)
   * The leading and trailing braces are required. To include a literal brace character, use two leading or trailing brace characters.$(BR)$(BR)
   * If formatStr is &quot;{0} bottles of beer on the wall&quot; and the argument is an int with the value of 99, the return value will be:$(BR)
   * &quot;99 bottles of beer on the wall&quot;.
  **/</span>
  <span class='kw4'>public</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatStr, <span class='opr'>..</span>.<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>auto</span> it <span class='opr'>=</span> ArgumentIterator<span class='opr'>(</span>_arguments, _argptr<span class='opr'>)</span>;
    <span class='kw1'>return</span> internalFormat<span class='opr'>(</span><span class='kw2'>null</span>, formatStr, it<span class='opr'>)</span>;
  <span class='opr'>}</span>

  <span class='com'>/**
   * Replaces the _format item in a string with the string equivalent of each argument using _culture-specific formatting information.
   * Params:
   *   formatService  = An IFormatService that renders _culture-specific formatting information.
   *   formatStr      = A string containing _format items.
   *   args           = A list of arguments.
   * Returns: A copy of formatStr in which the items have been replaced by the string equivalent of the arguments.
  **/</span>
  <span class='kw4'>public</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format<span class='opr'>(</span>IFormatService formatService, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatStr, <span class='opr'>..</span>.<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>auto</span> it <span class='opr'>=</span> ArgumentIterator<span class='opr'>(</span>_arguments, _argptr<span class='opr'>)</span>;
    <span class='kw1'>return</span> internalFormat<span class='opr'>(</span>formatService, formatStr, it<span class='opr'>)</span>;
  <span class='opr'>}</span>

  <span class='kw4'>private</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> internalFormat<span class='opr'>(</span>IFormatService formatService, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, <span class='kw2'>inout</span> ArgumentIterator it<span class='opr'>)</span> <span class='opr'>{</span>

    <span class='kw4'>const</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>256</span><span class='opr'>]</span> SPACES <span class='opr'>=</span> <span class='str'>' '</span>;

    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatArgument<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, <span class='kw2'>inout</span> Argument arg<span class='opr'>)</span> <span class='opr'>{</span>

      <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> stringOf<span class='opr'>(</span><span class='kw4'>char</span> c, <span class='kw4'>int</span> count <span class='opr'>=</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> s <span class='opr'>=</span> <span class='kw2'>new</span> <span class='kw4'>char</span><span class='opr'>[</span>count<span class='opr'>]</span>;
        s<span class='opr'>[</span><span class='nbr'>0</span> <span class='opr'>..</span> count<span class='opr'>]</span> <span class='opr'>=</span> c;
        <span class='kw1'>return</span> s;
      <span class='opr'>}</span>

      <span class='kw1'>switch</span> <span class='opr'>(</span>arg.getTypeCode<span class='opr'>(</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>case</span> TypeCode.ARRAY:
          <span class='com'>// Currently we only format char[] arrays.</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>arg.getType<span class='opr'>(</span><span class='opr'>)</span> <span class='kw2'>is</span> <span class='kw2'>typeid</span><span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>)</span><span class='opr'>)</span>
            <span class='kw1'>return</span> <span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>;
          <span class='kw1'>return</span> arg.getType<span class='opr'>(</span><span class='opr'>)</span>.toString<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.BOOL:
          <span class='kw1'>return</span> <span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>bool</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span> ? <span class='str'>&quot;True&quot;</span> : <span class='str'>&quot;False&quot;</span>;
        <span class='kw1'>case</span> TypeCode.UBYTE:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ubyte</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.BYTE:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>byte</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.USHORT:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ushort</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.SHORT:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>short</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.UINT:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.INT:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.ULONG:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ulong</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.LONG:
          <span class='kw1'>return</span> formatInteger<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw4'>version</span> <span class='opr'>(</span>mlfp<span class='opr'>)</span>
        <span class='kw1'>case</span> TypeCode.FLOAT:
          <span class='kw1'>return</span> formatDouble<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>double</span><span class='opr'>)</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>float</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw4'>version</span> <span class='opr'>(</span>mlfp<span class='opr'>)</span>
        <span class='kw1'>case</span> TypeCode.DOUBLE:
          <span class='kw1'>return</span> formatDouble<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>double</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span>, format, formatService<span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.CHAR:
          <span class='kw1'>return</span> stringOf<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span><span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.CLASS:
          <span class='kw1'>return</span> <span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw3'>Object</span><span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span><span class='opr'>)</span>.toString<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.STRUCT:
          <span class='com'>// Special case for DateTime.</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>arg.getType<span class='opr'>(</span><span class='opr'>)</span> <span class='kw2'>is</span> <span class='kw2'>typeid</span><span class='opr'>(</span>DateTime<span class='opr'>)</span><span class='opr'>)</span>
            <span class='kw1'>return</span> <span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span>DateTime<span class='opr'>*</span><span class='opr'>)</span>arg.getValue<span class='opr'>(</span><span class='opr'>)</span><span class='opr'>)</span>.toString<span class='opr'>(</span>format, formatService<span class='opr'>)</span>;
          <span class='kw1'>return</span> arg.getType<span class='opr'>(</span><span class='opr'>)</span>.toString<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw1'>case</span> TypeCode.POINTER:
          <span class='kw1'>return</span> arg.getType<span class='opr'>(</span><span class='opr'>)</span>.toString<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw2'>default</span>:
          <span class='kw1'>break</span>;
      <span class='opr'>}</span>
      <span class='com'>// For everything else, return an empty string.</span>
      <span class='kw1'>return</span> <span class='str'>&quot;&quot;</span>;
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> result, chars <span class='opr'>=</span> format;
    <span class='kw4'>int</span> pos;
    <span class='kw4'>char</span> c;

    <span class='kw1'>while</span> <span class='opr'>(</span><span class='kw2'>true</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>int</span> p <span class='opr'>=</span> pos, i <span class='opr'>=</span> pos;
      <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
        c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'{'</span><span class='opr'>)</span> <span class='opr'>{</span>
          <span class='com'>// Handle '{{' indicating a literal brace char.</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length &amp;&amp; chars<span class='opr'>[</span>pos<span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'{'</span><span class='opr'>)</span>
            pos<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>else</span> <span class='opr'>{</span>
            pos<span class='opr'>-</span><span class='opr'>-</span>;
            <span class='kw1'>break</span>;
          <span class='opr'>}</span>
        <span class='opr'>}</span>
        <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'}'</span><span class='opr'>)</span> <span class='opr'>{</span>
          <span class='com'>// Handle '}}' indicating a literal brace char.</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length &amp;&amp; chars<span class='opr'>[</span>pos<span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'}'</span><span class='opr'>)</span>
            pos<span class='opr'>+</span><span class='opr'>+</span>;
        <span class='opr'>}</span>
        chars<span class='opr'>[</span>i<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span> <span class='opr'>=</span> c;
      <span class='opr'>}</span>

      <span class='kw1'>if</span> <span class='opr'>(</span>i <span class='opr'>&gt;</span> p<span class='opr'>)</span>
        result <span class='opr'>~=</span> chars<span class='opr'>[</span>p <span class='opr'>..</span> i<span class='opr'>]</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>=</span><span class='opr'>=</span> format.length<span class='opr'>)</span>
        <span class='kw1'>break</span>;
      pos<span class='opr'>+</span><span class='opr'>+</span>;

      <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>=</span><span class='opr'>=</span> format.length || <span class='opr'>(</span>c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>&lt;</span> <span class='str'>'0'</span> || c <span class='opr'>&gt;</span> <span class='str'>'9'</span><span class='opr'>)</span>
        <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception<span class='opr'>(</span><span class='str'>&quot;Input string was invalid.&quot;</span><span class='opr'>)</span>;
      <span class='kw4'>int</span> index;
      <span class='kw1'>while</span> <span class='opr'>(</span>c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'0'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'9'</span><span class='opr'>)</span> <span class='opr'>{</span>
        index <span class='opr'>=</span> index <span class='opr'>*</span> <span class='nbr'>10</span> <span class='opr'>+</span> c <span class='opr'>-</span> <span class='str'>'0'</span>;
        pos<span class='opr'>+</span><span class='opr'>+</span>;
        c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span>;
      <span class='opr'>}</span>

      <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='str'>' '</span><span class='opr'>)</span>
          <span class='kw1'>break</span>;
        pos<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='opr'>}</span>

      <span class='com'>// Alignment.</span>
      <span class='kw4'>bool</span> leftAlign;
      <span class='kw4'>int</span> width;
      <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>','</span><span class='opr'>)</span> <span class='opr'>{</span>
        pos<span class='opr'>+</span><span class='opr'>+</span>;
        <span class='com'>// Eat spaces.</span>
        <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
          <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='str'>' '</span><span class='opr'>)</span>
            <span class='kw1'>break</span>;
          pos<span class='opr'>+</span><span class='opr'>+</span>;
        <span class='opr'>}</span>
        c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'-'</span><span class='opr'>)</span> <span class='opr'>{</span>
          leftAlign <span class='opr'>=</span> <span class='kw2'>true</span>;
          pos<span class='opr'>+</span><span class='opr'>+</span>;
          c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span>;
        <span class='opr'>}</span>
        <span class='kw1'>while</span> <span class='opr'>(</span>c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'0'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'9'</span><span class='opr'>)</span> <span class='opr'>{</span>
          width <span class='opr'>=</span> width <span class='opr'>*</span> <span class='nbr'>10</span> <span class='opr'>+</span> c <span class='opr'>-</span> <span class='str'>'0'</span>;
          pos<span class='opr'>+</span><span class='opr'>+</span>;
          c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span>;
        <span class='opr'>}</span>
      <span class='opr'>}</span>

      <span class='com'>// Eat spaces.</span>
      <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='str'>' '</span><span class='opr'>)</span>
          <span class='kw1'>break</span>;
        pos<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='opr'>}</span>

      <span class='com'>// Interpolated format.</span>
      <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> f;
      <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>':'</span><span class='opr'>)</span> <span class='opr'>{</span>
        pos<span class='opr'>+</span><span class='opr'>+</span>;
        p <span class='opr'>=</span> pos, i <span class='opr'>=</span> pos;
        <span class='kw1'>while</span> <span class='opr'>(</span><span class='kw2'>true</span><span class='opr'>)</span> <span class='opr'>{</span>
          c <span class='opr'>=</span> chars<span class='opr'>[</span>pos<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'{'</span><span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length &amp;&amp; chars<span class='opr'>[</span>pos<span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'{'</span><span class='opr'>)</span>
              pos<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='opr'>}</span>
          <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'}'</span><span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length &amp;&amp; chars<span class='opr'>[</span>pos<span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'}'</span><span class='opr'>)</span>
              pos<span class='opr'>+</span><span class='opr'>+</span>;
            <span class='kw1'>else</span> <span class='opr'>{</span>
              pos<span class='opr'>-</span><span class='opr'>-</span>;
              <span class='kw1'>break</span>;
            <span class='opr'>}</span>
          <span class='opr'>}</span>
          chars<span class='opr'>[</span>i<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span> <span class='opr'>=</span> c;
        <span class='opr'>}</span>

        <span class='kw1'>if</span> <span class='opr'>(</span>i <span class='opr'>&gt;</span> p<span class='opr'>)</span>
          f <span class='opr'>=</span> chars<span class='opr'>[</span>p <span class='opr'>..</span> i<span class='opr'>]</span>;
      <span class='opr'>}</span>

      pos<span class='opr'>+</span><span class='opr'>+</span>;

      <span class='com'>// Convert argument to a string using interpolated format.</span>
      Argument arg <span class='opr'>=</span> it<span class='opr'>[</span>index<span class='opr'>]</span>;
      <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> str <span class='opr'>=</span> formatArgument<span class='opr'>(</span>f, arg<span class='opr'>)</span>;
      <span class='kw4'>int</span> padding <span class='opr'>=</span> width <span class='opr'>-</span> str.length;

      <span class='com'>// If not left aligned, pad out with spaces.</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>!leftAlign &amp;&amp; padding <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
        result <span class='opr'>~=</span> SPACES<span class='opr'>[</span><span class='nbr'>0</span> <span class='opr'>..</span> padding<span class='opr'>]</span>;
      result <span class='opr'>~=</span> str;
      <span class='com'>// Finally, pad out on right.</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>leftAlign &amp;&amp; padding <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
        result <span class='opr'>~=</span> SPACES<span class='opr'>[</span><span class='nbr'>0</span> <span class='opr'>..</span> padding<span class='opr'>]</span>;
    <span class='opr'>}</span>
    <span class='kw1'>return</span> result;
  <span class='opr'>}</span>

<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>struct</span> Number <span class='opr'>{</span>

  <span class='kw4'>int</span> precision;
  <span class='kw4'>int</span> scale;
  <span class='kw4'>bool</span> sign;
  <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>32</span><span class='opr'>]</span> digits <span class='opr'>=</span> <span class='kw4'>void</span>;

  <span class='kw4'>static</span> Number opCall<span class='opr'>(</span><span class='kw4'>long</span> value<span class='opr'>)</span> <span class='opr'>{</span>
    Number number;
    number.precision <span class='opr'>=</span> <span class='nbr'>20</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span>value <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      number.sign <span class='opr'>=</span> <span class='kw2'>true</span>;
      value <span class='opr'>=</span> <span class='opr'>-</span>value;
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>20</span><span class='opr'>]</span> buffer;
    <span class='kw4'>int</span> n <span class='opr'>=</span> buffer.length;
    <span class='kw1'>while</span> <span class='opr'>(</span>value <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      buffer<span class='opr'>[</span><span class='opr'>-</span><span class='opr'>-</span>n<span class='opr'>]</span> <span class='opr'>=</span> value <span class='opr'>%</span> <span class='nbr'>10</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
      value <span class='opr'>/=</span> <span class='nbr'>10</span>;
    <span class='opr'>}</span>

    <span class='kw4'>int</span> end <span class='opr'>=</span> number.scale <span class='opr'>=</span> <span class='opr'>-</span><span class='opr'>(</span>n <span class='opr'>-</span> buffer.length<span class='opr'>)</span>;
    number.digits<span class='opr'>[</span><span class='nbr'>0</span> <span class='opr'>..</span> end<span class='opr'>]</span> <span class='opr'>=</span> buffer<span class='opr'>[</span>n <span class='opr'>..</span> n <span class='opr'>+</span> end<span class='opr'>]</span>;
    number.digits<span class='opr'>[</span>end<span class='opr'>]</span> <span class='opr'>=</span> <span class='str'>'\0'</span>;

    <span class='kw1'>return</span> number;
  <span class='opr'>}</span>

  <span class='com'>// Only if floating-point support is enabled.</span>
  <span class='kw4'>version</span> <span class='opr'>(</span>mlfp<span class='opr'>)</span>
  <span class='kw4'>static</span> Number opCall<span class='opr'>(</span><span class='kw4'>double</span> value, <span class='kw4'>int</span> precision<span class='opr'>)</span> <span class='opr'>{</span>
    Number number;
    number.precision <span class='opr'>=</span> precision;

    <span class='kw4'>char</span><span class='opr'>*</span> p <span class='opr'>=</span> number.digits;
    <span class='kw4'>long</span> bits <span class='opr'>=</span> <span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>*</span><span class='opr'>)</span><span class='opr'>&amp;</span>value;
    <span class='kw4'>long</span> mant <span class='opr'>=</span> bits <span class='opr'>&amp;</span> <span class='nbr'>0</span>x000FFFFFFFFFFFFFL;
    <span class='kw4'>int</span> exp <span class='opr'>=</span> <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>int</span><span class='opr'>)</span><span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>52</span><span class='opr'>)</span> <span class='opr'>&amp;</span> EXP<span class='opr'>)</span>;

    <span class='kw1'>if</span> <span class='opr'>(</span>exp <span class='opr'>=</span><span class='opr'>=</span> EXP<span class='opr'>)</span> <span class='opr'>{</span>
      number.scale <span class='opr'>=</span> <span class='opr'>(</span>mant <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> ? NAN_FLAG : INFINITY_FLAG;
      <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>63</span><span class='opr'>)</span> <span class='opr'>&amp;</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
        number.sign <span class='opr'>=</span> <span class='kw2'>true</span>;
    <span class='opr'>}</span>
    <span class='kw1'>else</span> <span class='opr'>{</span>
      <span class='com'>// Get the digits, decimal point and sign.</span>
      <span class='kw4'>char</span><span class='opr'>*</span> chars <span class='opr'>=</span> ecvt<span class='opr'>(</span>value, number.precision, number.scale, number.sign<span class='opr'>)</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>*</span>chars <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>while</span> <span class='opr'>(</span><span class='opr'>*</span>chars <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span>
          <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>=</span> <span class='opr'>*</span>chars<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>
    <span class='opr'>*</span>p <span class='opr'>=</span> <span class='str'>'\0'</span>;

    <span class='kw1'>return</span> number;
  <span class='opr'>}</span>

  <span class='kw4'>version</span> <span class='opr'>(</span>mlfp<span class='opr'>)</span>
  <span class='kw4'>private</span> <span class='kw4'>bool</span> toDouble<span class='opr'>(</span><span class='kw2'>out</span> <span class='kw4'>double</span> value<span class='opr'>)</span> <span class='opr'>{</span>

    <span class='kw4'>const</span> <span class='kw4'>ulong</span><span class='opr'>[</span><span class='opr'>]</span> pow10 <span class='opr'>=</span> <span class='opr'>[</span>
      <span class='nbr'>0</span>xa000000000000000UL,
      <span class='nbr'>0</span>xc800000000000000UL,
      <span class='nbr'>0</span>xfa00000000000000UL,
      <span class='nbr'>0</span>x9c40000000000000UL,
      <span class='nbr'>0</span>xc350000000000000UL,
      <span class='nbr'>0</span>xf424000000000000UL,
      <span class='nbr'>0</span>x9896800000000000UL,
      <span class='nbr'>0</span>xbebc200000000000UL,
      <span class='nbr'>0</span>xee6b280000000000UL,
      <span class='nbr'>0</span>x9502f90000000000UL,
      <span class='nbr'>0</span>xba43b74000000000UL,
      <span class='nbr'>0</span>xe8d4a51000000000UL,
      <span class='nbr'>0</span>x9184e72a00000000UL,
      <span class='nbr'>0</span>xb5e620f480000000UL,
      <span class='nbr'>0</span>xe35fa931a0000000UL,
      <span class='nbr'>0</span>xcccccccccccccccdUL,
      <span class='nbr'>0</span>xa3d70a3d70a3d70bUL,
      <span class='nbr'>0</span>x83126e978d4fdf3cUL,
      <span class='nbr'>0</span>xd1b71758e219652eUL,
      <span class='nbr'>0</span>xa7c5ac471b478425UL,
      <span class='nbr'>0</span>x8637bd05af6c69b7UL,
      <span class='nbr'>0</span>xd6bf94d5e57a42beUL,
      <span class='nbr'>0</span>xabcc77118461ceffUL,
      <span class='nbr'>0</span>x89705f4136b4a599UL,
      <span class='nbr'>0</span>xdbe6fecebdedd5c2UL,
      <span class='nbr'>0</span>xafebff0bcb24ab02UL,
      <span class='nbr'>0</span>x8cbccc096f5088cfUL,
      <span class='nbr'>0</span>xe12e13424bb40e18UL,
      <span class='nbr'>0</span>xb424dc35095cd813UL,
      <span class='nbr'>0</span>x901d7cf73ab0acdcUL,
      <span class='nbr'>0</span>x8e1bc9bf04000000UL,
      <span class='nbr'>0</span>x9dc5ada82b70b59eUL,
      <span class='nbr'>0</span>xaf298d050e4395d6UL,
      <span class='nbr'>0</span>xc2781f49ffcfa6d4UL,
      <span class='nbr'>0</span>xd7e77a8f87daf7faUL,
      <span class='nbr'>0</span>xefb3ab16c59b14a0UL,
      <span class='nbr'>0</span>x850fadc09923329cUL,
      <span class='nbr'>0</span>x93ba47c980e98cdeUL,
      <span class='nbr'>0</span>xa402b9c5a8d3a6e6UL,
      <span class='nbr'>0</span>xb616a12b7fe617a8UL,
      <span class='nbr'>0</span>xca28a291859bbf90UL,
      <span class='nbr'>0</span>xe070f78d39275566UL,
      <span class='nbr'>0</span>xf92e0c3537826140UL,
      <span class='nbr'>0</span>x8a5296ffe33cc92cUL,
      <span class='nbr'>0</span>x9991a6f3d6bf1762UL,
      <span class='nbr'>0</span>xaa7eebfb9df9de8aUL,
      <span class='nbr'>0</span>xbd49d14aa79dbc7eUL,
      <span class='nbr'>0</span>xd226fc195c6a2f88UL,
      <span class='nbr'>0</span>xe950df20247c83f8UL,
      <span class='nbr'>0</span>x81842f29f2cce373UL,
      <span class='nbr'>0</span>x8fcac257558ee4e2UL,
    <span class='opr'>]</span>;

    <span class='kw4'>const</span> <span class='kw4'>uint</span><span class='opr'>[</span><span class='opr'>]</span> pow10Exp <span class='opr'>=</span> <span class='opr'>[</span> 
      <span class='nbr'>4</span>, <span class='nbr'>7</span>, <span class='nbr'>10</span>, <span class='nbr'>14</span>, <span class='nbr'>17</span>, <span class='nbr'>20</span>, <span class='nbr'>24</span>, <span class='nbr'>27</span>, <span class='nbr'>30</span>, <span class='nbr'>34</span>, 
      <span class='nbr'>37</span>, <span class='nbr'>40</span>, <span class='nbr'>44</span>, <span class='nbr'>47</span>, <span class='nbr'>50</span>, <span class='nbr'>54</span>, <span class='nbr'>107</span>, <span class='nbr'>160</span>, <span class='nbr'>213</span>, <span class='nbr'>266</span>, 
      <span class='nbr'>319</span>, <span class='nbr'>373</span>, <span class='nbr'>426</span>, <span class='nbr'>479</span>, <span class='nbr'>532</span>, <span class='nbr'>585</span>, <span class='nbr'>638</span>, <span class='nbr'>691</span>, <span class='nbr'>745</span>, <span class='nbr'>798</span>, 
      <span class='nbr'>851</span>, <span class='nbr'>904</span>, <span class='nbr'>957</span>, <span class='nbr'>1010</span>, <span class='nbr'>1064</span>, <span class='nbr'>1117</span> <span class='opr'>]</span>;

    <span class='kw4'>uint</span> getDigits<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>*</span> p, <span class='kw4'>int</span> len<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>char</span><span class='opr'>*</span> end <span class='opr'>=</span> p <span class='opr'>+</span> len;
      <span class='kw4'>uint</span> r <span class='opr'>=</span> <span class='opr'>*</span>p <span class='opr'>-</span> <span class='str'>'0'</span>;
      p<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='kw1'>while</span> <span class='opr'>(</span>p <span class='opr'>&lt;</span> end<span class='opr'>)</span> <span class='opr'>{</span>
        r <span class='opr'>=</span> <span class='nbr'>10</span> <span class='opr'>*</span> r <span class='opr'>+</span> <span class='opr'>*</span>p <span class='opr'>-</span> <span class='str'>'0'</span>;
        p<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='opr'>}</span>
      <span class='kw1'>return</span> r;
    <span class='opr'>}</span>

    <span class='kw4'>ulong</span> mult64<span class='opr'>(</span><span class='kw4'>uint</span> val1, <span class='kw4'>uint</span> val2<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>return</span> <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ulong</span><span class='opr'>)</span>val1 <span class='opr'>*</span> <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ulong</span><span class='opr'>)</span>val2;
    <span class='opr'>}</span>

    <span class='kw4'>ulong</span> mult64L<span class='opr'>(</span><span class='kw4'>ulong</span> val1, <span class='kw4'>ulong</span> val2<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>ulong</span> v <span class='opr'>=</span> mult64<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span><span class='opr'>(</span>val1 <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span><span class='opr'>)</span>, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span><span class='opr'>(</span>val2 <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span><span class='opr'>)</span><span class='opr'>)</span>;
      v <span class='opr'>+=</span> mult64<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span><span class='opr'>(</span>val1 <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span><span class='opr'>)</span>, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span>val2<span class='opr'>)</span> <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span>;
      v <span class='opr'>+=</span> mult64<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span>val1, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span><span class='opr'>(</span>val2 <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span>;
      <span class='kw1'>return</span> v;
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>*</span> p <span class='opr'>=</span> digits;
    <span class='kw4'>int</span> count <span class='opr'>=</span> charTerm<span class='opr'>(</span>p<span class='opr'>)</span>;
    <span class='kw4'>int</span> left <span class='opr'>=</span> count;

    <span class='kw1'>while</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'0'</span><span class='opr'>)</span> <span class='opr'>{</span>
      left<span class='opr'>-</span><span class='opr'>-</span>;
      p<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='opr'>}</span>
    <span class='com'>// If the digits consist of nothing but zeros...</span>
    <span class='kw1'>if</span> <span class='opr'>(</span>left <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      value <span class='opr'>=</span> <span class='nbr'>0.0</span>;
      <span class='kw1'>return</span> <span class='kw2'>true</span>;
    <span class='opr'>}</span>

    <span class='com'>// Get digits, 9 at a time.</span>
    <span class='kw4'>int</span> n <span class='opr'>=</span> <span class='opr'>(</span>left <span class='opr'>&gt;</span> <span class='nbr'>9</span><span class='opr'>)</span> ? <span class='nbr'>9</span> : left;
    left <span class='opr'>-=</span> n;
    <span class='kw4'>ulong</span> bits <span class='opr'>=</span> getDigits<span class='opr'>(</span>p, n<span class='opr'>)</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span>left <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      n <span class='opr'>=</span> <span class='opr'>(</span>left <span class='opr'>&gt;</span> <span class='nbr'>9</span><span class='opr'>)</span> ? <span class='nbr'>9</span> : left;
      left <span class='opr'>-=</span> n;
      bits <span class='opr'>=</span> mult64<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span>bits, <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span><span class='opr'>(</span>pow10<span class='opr'>[</span>n <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span> <span class='opr'>&gt;</span><span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='opr'>(</span><span class='nbr'>64</span> <span class='opr'>-</span> pow10Exp<span class='opr'>[</span>n <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span><span class='opr'>)</span><span class='opr'>)</span><span class='opr'>)</span>;
      bits <span class='opr'>+=</span> getDigits<span class='opr'>(</span>p <span class='opr'>+</span> <span class='nbr'>9</span>, n<span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='kw4'>int</span> scale <span class='opr'>=</span> <span class='kw2'>this</span>.scale <span class='opr'>-</span> <span class='opr'>(</span>count <span class='opr'>-</span> left<span class='opr'>)</span>;
    <span class='kw4'>int</span> s <span class='opr'>=</span> <span class='opr'>(</span>scale <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='opr'>-</span>scale : scale;
    <span class='kw1'>if</span> <span class='opr'>(</span>s <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>352</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>long</span><span class='opr'>*</span><span class='opr'>)</span><span class='opr'>&amp;</span>value <span class='opr'>=</span> <span class='opr'>(</span>scale <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='nbr'>0</span>x7FF0000000000000 : <span class='nbr'>0</span>;
      <span class='kw1'>return</span> <span class='kw2'>false</span>;
    <span class='opr'>}</span>

    <span class='com'>// Normalise mantissa and bits.</span>
    <span class='kw4'>int</span> bexp <span class='opr'>=</span> <span class='nbr'>64</span>;
    <span class='kw4'>int</span> nzero;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>32</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero <span class='opr'>=</span> <span class='nbr'>32</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='opr'>(</span><span class='nbr'>16</span> <span class='opr'>+</span> nzero<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero <span class='opr'>+=</span> <span class='nbr'>16</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='opr'>(</span><span class='nbr'>8</span> <span class='opr'>+</span> nzero<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero <span class='opr'>+=</span> <span class='nbr'>8</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='opr'>(</span><span class='nbr'>4</span> <span class='opr'>+</span> nzero<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero <span class='opr'>+=</span> <span class='nbr'>4</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='opr'>(</span><span class='nbr'>2</span> <span class='opr'>+</span> nzero<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero <span class='opr'>+=</span> <span class='nbr'>2</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='opr'>(</span><span class='nbr'>1</span> <span class='opr'>+</span> nzero<span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span> nzero<span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
      nzero<span class='opr'>+</span><span class='opr'>+</span>;
    bits <span class='opr'>&lt;</span><span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>64</span> <span class='opr'>-</span> nzero;
    bexp <span class='opr'>-=</span> <span class='nbr'>64</span> <span class='opr'>-</span> nzero;

    <span class='com'>// Get decimal exponent.</span>
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>s <span class='opr'>&amp;</span> <span class='nbr'>15</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>int</span> expMult <span class='opr'>=</span> pow10Exp<span class='opr'>[</span><span class='opr'>(</span>s <span class='opr'>&amp;</span> <span class='nbr'>15</span><span class='opr'>)</span> <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span>;
      bexp <span class='opr'>+=</span> <span class='opr'>(</span>scale <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='opr'>(</span><span class='opr'>-</span>expMult <span class='opr'>+</span> <span class='nbr'>1</span><span class='opr'>)</span> : expMult;
      bits <span class='opr'>=</span> mult64L<span class='opr'>(</span>bits, pow10<span class='opr'>[</span><span class='opr'>(</span>s <span class='opr'>&amp;</span> <span class='nbr'>15</span><span class='opr'>)</span> <span class='opr'>+</span> <span class='opr'>(</span><span class='opr'>(</span>scale <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='nbr'>15</span> : <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span><span class='opr'>)</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&amp;</span> <span class='nbr'>0</span>x8000000000000000L<span class='opr'>)</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
        bits <span class='opr'>&lt;</span><span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>1</span>;
        bexp<span class='opr'>-</span><span class='opr'>-</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>s <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>4</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>int</span> expMult <span class='opr'>=</span> pow10Exp<span class='opr'>[</span><span class='nbr'>15</span> <span class='opr'>+</span> <span class='opr'>(</span><span class='opr'>(</span>s <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>4</span><span class='opr'>)</span> <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span><span class='opr'>]</span>;
      bexp <span class='opr'>+=</span> <span class='opr'>(</span>scale <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='opr'>(</span><span class='opr'>-</span>expMult <span class='opr'>+</span> <span class='nbr'>1</span><span class='opr'>)</span> : expMult;
      bits <span class='opr'>=</span> mult64L<span class='opr'>(</span>bits, pow10<span class='opr'>[</span><span class='nbr'>30</span> <span class='opr'>+</span> <span class='opr'>(</span><span class='opr'>(</span>s <span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>4</span><span class='opr'>)</span> <span class='opr'>+</span> <span class='opr'>(</span><span class='opr'>(</span>scale <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='nbr'>21</span> : <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span><span class='opr'>]</span><span class='opr'>)</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>(</span>bits <span class='opr'>&amp;</span> <span class='nbr'>0</span>x8000000000000000L<span class='opr'>)</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
        bits <span class='opr'>&lt;</span><span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>1</span>;
        bexp<span class='opr'>-</span><span class='opr'>-</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>
    
    <span class='com'>// Round and scale.</span>
    <span class='kw1'>if</span> <span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>uint</span><span class='opr'>)</span>bits <span class='opr'>&amp;</span> <span class='opr'>(</span><span class='nbr'>1</span> <span class='opr'>&lt;</span><span class='opr'>&lt;</span> <span class='nbr'>10</span><span class='opr'>)</span> <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      bits <span class='opr'>+=</span> <span class='opr'>(</span><span class='nbr'>1</span> <span class='opr'>&lt;</span><span class='opr'>&lt;</span> <span class='nbr'>10</span><span class='opr'>)</span> <span class='opr'>-</span> <span class='nbr'>1</span> <span class='opr'>+</span> <span class='opr'>(</span>bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span><span class='opr'>&gt;</span> <span class='nbr'>11</span><span class='opr'>)</span> <span class='opr'>&amp;</span> <span class='nbr'>1</span>;
      bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>11</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span>bits <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
        bexp<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='opr'>}</span>
    <span class='kw1'>else</span>
      bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>11</span>;
    bexp <span class='opr'>+=</span> <span class='nbr'>1022</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span>bexp <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>bexp <span class='opr'>&lt;</span> <span class='opr'>-</span><span class='nbr'>53</span><span class='opr'>)</span>
        bits <span class='opr'>=</span> <span class='nbr'>0</span>;
      <span class='kw1'>else</span>
        bits <span class='opr'>&gt;</span><span class='opr'>&gt;</span><span class='opr'>=</span> <span class='opr'>(</span><span class='opr'>-</span>bexp <span class='opr'>+</span> <span class='nbr'>1</span><span class='opr'>)</span>;
    <span class='opr'>}</span>
    bits <span class='opr'>=</span> <span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ulong</span><span class='opr'>)</span>bexp <span class='opr'>&lt;</span><span class='opr'>&lt;</span> <span class='nbr'>52</span><span class='opr'>)</span> <span class='opr'>+</span> <span class='opr'>(</span>bits <span class='opr'>&amp;</span> <span class='nbr'>0</span>x000FFFFFFFFFFFFFL<span class='opr'>)</span>;

    <span class='kw1'>if</span> <span class='opr'>(</span>sign<span class='opr'>)</span>
      bits <span class='opr'>|=</span> <span class='nbr'>0</span>x8000000000000000L;

    value <span class='opr'>=</span> <span class='opr'>*</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>double</span><span class='opr'>*</span><span class='opr'>)</span><span class='opr'>&amp;</span>bits;
    <span class='kw1'>return</span> <span class='kw2'>true</span>;
  <span class='opr'>}</span>

  <span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> toString<span class='opr'>(</span><span class='kw4'>char</span> format, <span class='kw4'>int</span> length, NumberFormat nf<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> result;

    <span class='kw1'>switch</span> <span class='opr'>(</span>format<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>case</span> <span class='str'>'c'</span>:
      <span class='kw1'>case</span> <span class='str'>'C'</span>:
        <span class='com'>// Currency</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
          length <span class='opr'>=</span> nf.currencyDecimalDigits;
        round<span class='opr'>(</span>scale <span class='opr'>+</span> length<span class='opr'>)</span>;
        formatCurrency<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>this</span>, result, length, nf<span class='opr'>)</span>;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'f'</span>:
      <span class='kw1'>case</span> <span class='str'>'F'</span>:
        <span class='com'>// Fixed</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
          length <span class='opr'>=</span> nf.numberDecimalDigits;
        round<span class='opr'>(</span>scale <span class='opr'>+</span> length<span class='opr'>)</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>sign<span class='opr'>)</span>
          result <span class='opr'>~=</span> nf.negativeSign;
        formatFixed<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>this</span>, result, length, <span class='kw2'>null</span>, nf.numberDecimalSeparator, <span class='kw2'>null</span><span class='opr'>)</span>;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'n'</span>:
      <span class='kw1'>case</span> <span class='str'>'N'</span>:
        <span class='com'>// Number</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
          length <span class='opr'>=</span> nf.numberDecimalDigits;
        round<span class='opr'>(</span>scale <span class='opr'>+</span> length<span class='opr'>)</span>;
        formatNumber<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>this</span>, result, length, nf<span class='opr'>)</span>;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'g'</span>:
      <span class='kw1'>case</span> <span class='str'>'G'</span>:
        <span class='com'>// General</span>
        <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&lt;</span> <span class='nbr'>1</span><span class='opr'>)</span>
          length <span class='opr'>=</span> precision;
        round<span class='opr'>(</span>length<span class='opr'>)</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>sign<span class='opr'>)</span>
          result <span class='opr'>~=</span> nf.negativeSign;
        formatGeneral<span class='opr'>(</span><span class='opr'>*</span><span class='kw2'>this</span>, result, length, <span class='opr'>(</span>format <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'g'</span><span class='opr'>)</span> ? <span class='str'>'e'</span> : <span class='str'>'E'</span>, nf<span class='opr'>)</span>;
        <span class='kw1'>break</span>;
      <span class='kw2'>default</span>:
        <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception<span class='opr'>(</span><span class='str'>&quot;Invalid format specifier.&quot;</span><span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='kw1'>return</span> result;
  <span class='opr'>}</span>
  
  <span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> toStringFormat<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, NumberFormat nf<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>bool</span> hasGroups;
    <span class='kw4'>int</span> groupCount;
    <span class='kw4'>int</span> groupPos <span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span>, pointPos <span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span>;
    <span class='kw4'>int</span> first <span class='opr'>=</span> <span class='kw4'>int</span>.max, last, count;
    <span class='kw4'>bool</span> scientific;

    <span class='kw4'>int</span> n;
    <span class='kw4'>char</span> c;
    <span class='kw1'>while</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
      c <span class='opr'>=</span> format<span class='opr'>[</span>n<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
      <span class='kw1'>switch</span> <span class='opr'>(</span>c<span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>case</span> <span class='str'>'#'</span>:
          count<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'0'</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>first <span class='opr'>=</span><span class='opr'>=</span> <span class='kw4'>int</span>.max<span class='opr'>)</span>
            first <span class='opr'>=</span> count;
          count<span class='opr'>+</span><span class='opr'>+</span>;
          last <span class='opr'>=</span> count;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'.'</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>pointPos <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
            pointPos <span class='opr'>=</span> count;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>','</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>count <span class='opr'>&gt;</span> <span class='nbr'>0</span> &amp;&amp; pointPos <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>groupPos <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
              <span class='kw1'>if</span> <span class='opr'>(</span>groupPos <span class='opr'>=</span><span class='opr'>=</span> count<span class='opr'>)</span> <span class='opr'>{</span>
                groupCount<span class='opr'>+</span><span class='opr'>+</span>;
                <span class='kw1'>break</span>;
              <span class='opr'>}</span>
              hasGroups <span class='opr'>=</span> <span class='kw2'>true</span>;
            <span class='opr'>}</span>
            groupPos <span class='opr'>=</span> count;
            groupCount <span class='opr'>=</span> <span class='nbr'>1</span>;
          <span class='opr'>}</span>
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'&#039;'</span>:
        <span class='kw1'>case</span> <span class='str'>'\&quot;'</span>:
          <span class='kw1'>while</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length &amp;&amp; format<span class='opr'>[</span>n<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span> <span class='opr'>!=</span> c<span class='opr'>)</span> <span class='opr'>{</span>
          <span class='opr'>}</span>
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'\&#039;</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length<span class='opr'>)</span>
            n<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>break</span>;
        <span class='kw2'>default</span>:
          <span class='kw1'>break</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>

    <span class='kw1'>if</span> <span class='opr'>(</span>pointPos <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
      pointPos <span class='opr'>=</span> count;

    <span class='kw4'>int</span> adjust;
    <span class='kw1'>if</span> <span class='opr'>(</span>groupPos <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>groupPos <span class='opr'>=</span><span class='opr'>=</span> pointPos<span class='opr'>)</span>
        adjust <span class='opr'>-=</span> groupCount <span class='opr'>*</span> <span class='nbr'>3</span>;
      <span class='kw1'>else</span>
        hasGroups <span class='opr'>=</span> <span class='kw2'>true</span>;
    <span class='opr'>}</span>

    <span class='kw1'>if</span> <span class='opr'>(</span>digits<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span> <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> <span class='opr'>{</span>
      scale <span class='opr'>+=</span> adjust;
      round<span class='opr'>(</span>scientific ? count : scale <span class='opr'>+</span> count <span class='opr'>-</span> pointPos<span class='opr'>)</span>;
    <span class='opr'>}</span>

    first <span class='opr'>=</span> <span class='opr'>(</span>first <span class='opr'>&lt;</span> pointPos<span class='opr'>)</span> ? pointPos <span class='opr'>-</span> first : <span class='nbr'>0</span>;
    last <span class='opr'>=</span> <span class='opr'>(</span>last <span class='opr'>&gt;</span> pointPos<span class='opr'>)</span> ? pointPos <span class='opr'>-</span> last : <span class='nbr'>0</span>;

    <span class='kw4'>int</span> pos <span class='opr'>=</span> pointPos;
    <span class='kw4'>int</span> extra;
    <span class='kw1'>if</span> <span class='opr'>(</span>!scientific<span class='opr'>)</span> <span class='opr'>{</span>
      pos <span class='opr'>=</span> <span class='opr'>(</span>scale <span class='opr'>&gt;</span> pointPos<span class='opr'>)</span> ? scale : pointPos;
      extra <span class='opr'>=</span> scale <span class='opr'>-</span> pointPos;
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> groupSeparator <span class='opr'>=</span> nf.numberGroupSeparator;
    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> decimalSeparator <span class='opr'>=</span> nf.numberDecimalSeparator;

    <span class='com'>// Work out the positions of the group separator.</span>
    <span class='kw4'>int</span><span class='opr'>[</span><span class='opr'>]</span> groupPositions;
    <span class='kw4'>int</span> groupIndex <span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span>hasGroups<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>nf.numberGroupSizes.length <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
        hasGroups <span class='opr'>=</span> <span class='kw2'>false</span>;
      <span class='kw1'>else</span> <span class='opr'>{</span>
        <span class='kw4'>int</span> groupSizesTotal <span class='opr'>=</span> nf.numberGroupSizes<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;
        <span class='kw4'>int</span> groupSize <span class='opr'>=</span> groupSizesTotal;
        <span class='kw4'>int</span> digitsTotal <span class='opr'>=</span> pos <span class='opr'>+</span> <span class='opr'>(</span><span class='opr'>(</span>extra <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> ? extra : <span class='nbr'>0</span><span class='opr'>)</span>;
        <span class='kw4'>int</span> digitCount <span class='opr'>=</span> <span class='opr'>(</span>first <span class='opr'>&gt;</span> digitsTotal<span class='opr'>)</span> ? first : digitsTotal;

        <span class='kw4'>int</span> sizeIndex;
        <span class='kw1'>while</span> <span class='opr'>(</span>digitCount <span class='opr'>&gt;</span> groupSizesTotal<span class='opr'>)</span> <span class='opr'>{</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>groupSize <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
            <span class='kw1'>break</span>;
          groupPositions <span class='opr'>~=</span> groupSizesTotal;
          groupIndex<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>sizeIndex <span class='opr'>&lt;</span> nf.numberGroupSizes.length <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span>
            groupSize <span class='opr'>=</span> nf.numberGroupSizes<span class='opr'>[</span><span class='opr'>+</span><span class='opr'>+</span>sizeIndex<span class='opr'>]</span>;
          groupSizesTotal <span class='opr'>+=</span> groupSize;
        <span class='opr'>}</span>
      <span class='opr'>}</span>
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> result;
    <span class='kw1'>if</span> <span class='opr'>(</span>sign<span class='opr'>)</span>
      result <span class='opr'>~=</span> nf.negativeSign;

    <span class='kw4'>char</span><span class='opr'>*</span> p <span class='opr'>=</span> digits;
    n <span class='opr'>=</span> <span class='nbr'>0</span>;
    <span class='kw4'>bool</span> pointWritten;
    <span class='kw1'>while</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
      c <span class='opr'>=</span> format<span class='opr'>[</span>n<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span>extra <span class='opr'>&gt;</span> <span class='nbr'>0</span> &amp;&amp; <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'#'</span> || c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'0'</span> || c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'.'</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>while</span> <span class='opr'>(</span>extra <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
          result <span class='opr'>~=</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> ? <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> : <span class='str'>'0'</span>;

          <span class='kw1'>if</span> <span class='opr'>(</span>hasGroups &amp;&amp; pos <span class='opr'>&gt;</span> <span class='nbr'>1</span> &amp;&amp; groupIndex <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>=</span><span class='opr'>=</span> groupPositions<span class='opr'>[</span>groupIndex<span class='opr'>]</span> <span class='opr'>+</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='opr'>{</span>
              result <span class='opr'>~=</span> groupSeparator;
              groupIndex<span class='opr'>-</span><span class='opr'>-</span>;
            <span class='opr'>}</span>
          <span class='opr'>}</span>
          pos<span class='opr'>-</span><span class='opr'>-</span>;
          extra<span class='opr'>-</span><span class='opr'>-</span>;
        <span class='opr'>}</span>
      <span class='opr'>}</span>
      <span class='kw1'>switch</span> <span class='opr'>(</span>c<span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>case</span> <span class='str'>'#'</span>:
        <span class='kw1'>case</span> <span class='str'>'0'</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>extra <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
            extra<span class='opr'>+</span><span class='opr'>+</span>;
            c <span class='opr'>=</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span><span class='opr'>=</span> first<span class='opr'>)</span> ? <span class='str'>'0'</span> : <span class='kw4'>char</span>.init;
          <span class='opr'>}</span>
          <span class='kw1'>else</span>
            c <span class='opr'>=</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> ? <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> : pos <span class='opr'>&gt;</span> last ? <span class='str'>'0'</span> : <span class='kw4'>char</span>.init;

          <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>!=</span> <span class='kw4'>char</span>.init<span class='opr'>)</span> <span class='opr'>{</span>
            result <span class='opr'>~=</span> c;

            <span class='kw1'>if</span> <span class='opr'>(</span>hasGroups &amp;&amp; pos <span class='opr'>&gt;</span> <span class='nbr'>1</span> &amp;&amp; groupIndex <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
              <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>=</span><span class='opr'>=</span> groupPositions<span class='opr'>[</span>groupIndex<span class='opr'>]</span> <span class='opr'>+</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='opr'>{</span>
                result <span class='opr'>~=</span> groupSeparator;
                groupIndex<span class='opr'>-</span><span class='opr'>-</span>;
              <span class='opr'>}</span>
            <span class='opr'>}</span>
          <span class='opr'>}</span>
          pos<span class='opr'>-</span><span class='opr'>-</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'.'</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>!=</span> <span class='nbr'>0</span> || pointWritten<span class='opr'>)</span>
            <span class='kw1'>break</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>last <span class='opr'>&lt;</span> <span class='nbr'>0</span> || <span class='opr'>(</span>pointPos <span class='opr'>&lt;</span> count &amp;&amp; <span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span><span class='opr'>)</span> <span class='opr'>{</span>
            result <span class='opr'>~=</span> decimalSeparator;
            pointWritten <span class='opr'>=</span> <span class='kw2'>true</span>;
          <span class='opr'>}</span>
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>','</span>:
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'&#039;'</span>:
        <span class='kw1'>case</span> <span class='str'>'\&quot;'</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length<span class='opr'>)</span>
            n<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'\&#039;</span>:
          <span class='kw1'>if</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length<span class='opr'>)</span>
            result <span class='opr'>~=</span> format<span class='opr'>[</span>n<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
          <span class='kw1'>break</span>;
        <span class='kw2'>default</span>:
          result <span class='opr'>~=</span> c;
          <span class='kw1'>break</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>
    <span class='kw1'>return</span> result;
  <span class='opr'>}</span>

  <span class='kw4'>private</span> <span class='kw4'>void</span> round<span class='opr'>(</span><span class='kw4'>int</span> pos<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>int</span> index;
    <span class='kw1'>while</span> <span class='opr'>(</span>index <span class='opr'>&lt;</span> pos &amp;&amp; digits<span class='opr'>[</span>index<span class='opr'>]</span> <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span>
      index<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='kw1'>if</span> <span class='opr'>(</span>index <span class='opr'>=</span><span class='opr'>=</span> pos &amp;&amp; digits<span class='opr'>[</span>index<span class='opr'>]</span> <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'5'</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>while</span> <span class='opr'>(</span>index <span class='opr'>&gt;</span> <span class='nbr'>0</span> &amp;&amp; digits<span class='opr'>[</span>index <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'9'</span><span class='opr'>)</span>
        index<span class='opr'>-</span><span class='opr'>-</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span>index <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span>
        digits<span class='opr'>[</span>index <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span><span class='opr'>+</span><span class='opr'>+</span>;
      <span class='kw1'>else</span> <span class='opr'>{</span>
        scale<span class='opr'>+</span><span class='opr'>+</span>;
        digits<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span> <span class='opr'>=</span> <span class='str'>'1'</span>;
        index <span class='opr'>=</span> <span class='nbr'>1</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>
    <span class='kw1'>else</span> <span class='kw1'>while</span> <span class='opr'>(</span>index <span class='opr'>&gt;</span> <span class='nbr'>0</span> &amp;&amp; digits<span class='opr'>[</span>index <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'0'</span><span class='opr'>)</span>
      index<span class='opr'>-</span><span class='opr'>-</span>;

    <span class='kw1'>if</span> <span class='opr'>(</span>index <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      scale <span class='opr'>=</span> <span class='nbr'>0</span>;
      sign <span class='opr'>=</span> <span class='kw2'>false</span>;
    <span class='opr'>}</span>

    digits<span class='opr'>[</span>index<span class='opr'>]</span> <span class='opr'>=</span> <span class='str'>'\0'</span>;
  <span class='opr'>}</span>

<span class='opr'>}</span>

<span class='com'>// Must match NumberFormat.decimalPositivePattern</span>
<span class='kw4'>private</span> <span class='kw4'>const</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> positiveNumberFormat <span class='opr'>=</span> <span class='str'>&quot;#&quot;</span>;
<span class='com'>// Must match NumberFormat.decimalNegativePattern</span>
<span class='kw4'>private</span> <span class='kw4'>const</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> negativeNumberFormats <span class='opr'>=</span> <span class='opr'>[</span> <span class='str'>&quot;(#)&quot;</span>, <span class='str'>&quot;-#&quot;</span>, <span class='str'>&quot;- #&quot;</span>, <span class='str'>&quot;#-&quot;</span>, <span class='str'>&quot;# -&quot;</span> <span class='opr'>]</span>;
<span class='com'>// Must match NumberFormat.currencyPositivePattern</span>
<span class='kw4'>private</span> <span class='kw4'>const</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> positiveCurrencyFormats <span class='opr'>=</span> <span class='opr'>[</span> <span class='str'>&quot;$#&quot;</span>, <span class='str'>&quot;#$&quot;</span>, <span class='str'>&quot;$ #&quot;</span>, <span class='str'>&quot;# $&quot;</span> <span class='opr'>]</span>;
<span class='com'>// Must match NumberFormat.currencyNegativePattern</span>
<span class='kw4'>private</span> <span class='kw4'>const</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span><span class='opr'>[</span><span class='opr'>]</span> negativeCurrencyFormats <span class='opr'>=</span> <span class='opr'>[</span> <span class='str'>&quot;($#)&quot;</span>, <span class='str'>&quot;-$#&quot;</span>, <span class='str'>&quot;$-#&quot;</span>, <span class='str'>&quot;$#-&quot;</span>, <span class='str'>&quot;(#$)&quot;</span>, <span class='str'>&quot;-#$&quot;</span>, <span class='str'>&quot;#-$&quot;</span>, <span class='str'>&quot;#$-&quot;</span>, <span class='str'>&quot;-# $&quot;</span>, <span class='str'>&quot;-$ #&quot;</span>, <span class='str'>&quot;# $-&quot;</span>, <span class='str'>&quot;$ #-&quot;</span>, <span class='str'>&quot;$ -#&quot;</span>, <span class='str'>&quot;#- $&quot;</span>, <span class='str'>&quot;($ #)&quot;</span>, <span class='str'>&quot;(# $)&quot;</span> <span class='opr'>]</span>;

<span class='kw4'>template</span> charTerm<span class='opr'>(</span>T<span class='opr'>)</span> <span class='opr'>{</span>

  <span class='kw4'>private</span> <span class='kw4'>int</span> charTerm<span class='opr'>(</span>T<span class='opr'>*</span> s<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>int</span> i;
    <span class='kw1'>while</span> <span class='opr'>(</span><span class='opr'>*</span>s<span class='opr'>+</span><span class='opr'>+</span> <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span>
      i<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='kw1'>return</span> i;
  <span class='opr'>}</span>

<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> longToString<span class='opr'>(</span><span class='kw4'>long</span> value, <span class='kw4'>int</span> digits, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> negativeSign<span class='opr'>)</span> <span class='opr'>{</span>
  <span class='kw1'>if</span> <span class='opr'>(</span>digits <span class='opr'>&lt;</span> <span class='nbr'>1</span><span class='opr'>)</span>
    digits <span class='opr'>=</span> <span class='nbr'>1</span>;

  <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>100</span><span class='opr'>]</span> buffer;
  <span class='kw4'>ulong</span> uv <span class='opr'>=</span> <span class='opr'>(</span>value <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> ? value : <span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ulong</span><span class='opr'>)</span><span class='opr'>-</span>value;
  <span class='kw4'>int</span> n <span class='opr'>=</span> <span class='nbr'>100</span>;
  <span class='kw1'>while</span> <span class='opr'>(</span><span class='opr'>-</span><span class='opr'>-</span>digits <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span> || uv <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
    buffer<span class='opr'>[</span><span class='opr'>-</span><span class='opr'>-</span>n<span class='opr'>]</span> <span class='opr'>=</span> uv <span class='opr'>%</span> <span class='nbr'>10</span> <span class='opr'>+</span> <span class='str'>'0'</span>;
    uv <span class='opr'>/=</span> <span class='nbr'>10</span>;
  <span class='opr'>}</span>;

  <span class='kw1'>if</span> <span class='opr'>(</span>value <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>for</span> <span class='opr'>(</span><span class='kw4'>int</span> i <span class='opr'>=</span> negativeSign.length <span class='opr'>-</span> <span class='nbr'>1</span>; i <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span>; i<span class='opr'>-</span><span class='opr'>-</span><span class='opr'>)</span>
      buffer<span class='opr'>[</span><span class='opr'>-</span><span class='opr'>-</span>n<span class='opr'>]</span> <span class='opr'>=</span> negativeSign<span class='opr'>[</span>i<span class='opr'>]</span>;
  <span class='opr'>}</span>

  <span class='kw1'>return</span> buffer<span class='opr'>[</span>n <span class='opr'>..</span> $<span class='opr'>]</span>.dup;
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> longToHexString<span class='opr'>(</span><span class='kw4'>ulong</span> value, <span class='kw4'>int</span> digits, <span class='kw4'>char</span> format<span class='opr'>)</span> <span class='opr'>{</span>
  <span class='kw1'>if</span> <span class='opr'>(</span>digits <span class='opr'>&lt;</span> <span class='nbr'>1</span><span class='opr'>)</span>
    digits <span class='opr'>=</span> <span class='nbr'>1</span>;

  <span class='kw4'>char</span><span class='opr'>[</span><span class='nbr'>100</span><span class='opr'>]</span> buffer;
  <span class='kw4'>int</span> n <span class='opr'>=</span> <span class='nbr'>100</span>;
  <span class='kw1'>while</span> <span class='opr'>(</span><span class='opr'>-</span><span class='opr'>-</span>digits <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span> || value <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>ulong</span> v <span class='opr'>=</span> value <span class='opr'>&amp;</span> <span class='nbr'>0</span>xF;
    buffer<span class='opr'>[</span><span class='opr'>-</span><span class='opr'>-</span>n<span class='opr'>]</span> <span class='opr'>=</span> <span class='opr'>(</span>v <span class='opr'>&lt;</span> <span class='nbr'>10</span><span class='opr'>)</span> ? v <span class='opr'>+</span> <span class='str'>'0'</span> : v <span class='opr'>+</span> format <span class='opr'>-</span> <span class='opr'>(</span><span class='str'>'X'</span> <span class='opr'>-</span> <span class='str'>'A'</span> <span class='opr'>+</span> <span class='nbr'>10</span><span class='opr'>)</span>;
    value <span class='opr'>&gt;</span><span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>4</span>;
  <span class='opr'>}</span>

  <span class='kw1'>return</span> buffer<span class='opr'>[</span>n <span class='opr'>..</span> $<span class='opr'>]</span>.dup;
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>char</span> parseFormatSpecifier<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, <span class='kw2'>out</span> <span class='kw4'>int</span> length<span class='opr'>)</span> <span class='opr'>{</span>
  length <span class='opr'>=</span> <span class='opr'>-</span><span class='nbr'>1</span>;
  <span class='kw4'>char</span> specifier <span class='opr'>=</span> <span class='str'>'G'</span>;

  <span class='kw1'>if</span> <span class='opr'>(</span>format <span class='opr'>!=</span> <span class='kw2'>null</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>int</span> pos <span class='opr'>=</span> <span class='nbr'>0</span>;
    <span class='kw4'>char</span> c <span class='opr'>=</span> format<span class='opr'>[</span>pos<span class='opr'>]</span>;

    <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'A'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'Z'</span> || c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'a'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'z'</span><span class='opr'>)</span> <span class='opr'>{</span>
      specifier <span class='opr'>=</span> c;
      pos<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>=</span><span class='opr'>=</span> format.length<span class='opr'>)</span>
        <span class='kw1'>return</span> specifier;
      c <span class='opr'>=</span> format<span class='opr'>[</span>pos<span class='opr'>]</span>;

      <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'0'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'9'</span><span class='opr'>)</span> <span class='opr'>{</span>
        length <span class='opr'>=</span> c <span class='opr'>-</span> <span class='str'>'0'</span>;
        pos<span class='opr'>+</span><span class='opr'>+</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>=</span><span class='opr'>=</span> format.length<span class='opr'>)</span>
          <span class='kw1'>return</span> specifier;
        c <span class='opr'>=</span> format<span class='opr'>[</span>pos<span class='opr'>]</span>;

        <span class='kw1'>while</span> <span class='opr'>(</span>c <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='str'>'0'</span> &amp;&amp; c <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='str'>'9'</span><span class='opr'>)</span> <span class='opr'>{</span>
          length <span class='opr'>=</span> length <span class='opr'>*</span> <span class='nbr'>10</span> <span class='opr'>+</span> c <span class='opr'>-</span> <span class='str'>'0'</span>;
          pos<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>10</span> || pos <span class='opr'>=</span><span class='opr'>=</span> format.length<span class='opr'>)</span>
            <span class='kw1'>return</span> specifier;
          c <span class='opr'>=</span> format<span class='opr'>[</span>pos<span class='opr'>]</span>;
        <span class='opr'>}</span>
      <span class='opr'>}</span>
    <span class='opr'>}</span>
    <span class='kw1'>return</span> <span class='kw4'>char</span>.init;
  <span class='opr'>}</span>
  <span class='kw1'>return</span> specifier;
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatInteger<span class='opr'>(</span><span class='kw4'>long</span> value, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, IFormatService formatService<span class='opr'>)</span> <span class='opr'>{</span>
  NumberFormat nf <span class='opr'>=</span> NumberFormat.getInstance<span class='opr'>(</span>formatService<span class='opr'>)</span>;
  <span class='kw4'>int</span> length;
  <span class='kw4'>char</span> specifier <span class='opr'>=</span> parseFormatSpecifier<span class='opr'>(</span>format, length<span class='opr'>)</span>;

  <span class='kw1'>switch</span> <span class='opr'>(</span>specifier<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>case</span> <span class='str'>'g'</span>:
    <span class='kw1'>case</span> <span class='str'>'G'</span>:
      <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
        Number number <span class='opr'>=</span> Number<span class='opr'>(</span>value<span class='opr'>)</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>specifier <span class='opr'>!=</span> <span class='kw4'>char</span>.init<span class='opr'>)</span>
          <span class='kw1'>return</span> number.toString<span class='opr'>(</span>specifier, length, nf<span class='opr'>)</span>;
        <span class='kw1'>return</span> number.toStringFormat<span class='opr'>(</span>format, nf<span class='opr'>)</span>;
      <span class='opr'>}</span>
      <span class='com'>// Fall through.</span>
    <span class='kw1'>case</span> <span class='str'>'d'</span>:
    <span class='kw1'>case</span> <span class='str'>'D'</span>:
      <span class='kw1'>return</span> longToString<span class='opr'>(</span>value, length, nf.negativeSign<span class='opr'>)</span>;
    <span class='kw1'>case</span> <span class='str'>'x'</span>:
    <span class='kw1'>case</span> <span class='str'>'X'</span>:
      <span class='kw1'>return</span> longToHexString<span class='opr'>(</span><span class='kw2'>cast</span><span class='opr'>(</span><span class='kw4'>ulong</span><span class='opr'>)</span>value, length, specifier<span class='opr'>)</span>;
    <span class='kw2'>default</span>:
      <span class='kw1'>break</span>;
  <span class='opr'>}</span>

  Number number <span class='opr'>=</span> Number<span class='opr'>(</span>value<span class='opr'>)</span>;
  <span class='kw1'>if</span> <span class='opr'>(</span>specifier <span class='opr'>!=</span> <span class='kw4'>char</span>.init<span class='opr'>)</span>
    <span class='kw1'>return</span> number.toString<span class='opr'>(</span>specifier, length, nf<span class='opr'>)</span>;
  <span class='kw1'>return</span> number.toStringFormat<span class='opr'>(</span>format, nf<span class='opr'>)</span>;
<span class='opr'>}</span>

<span class='com'>// Only if floating-point support is enabled.</span>
<span class='kw4'>version</span> <span class='opr'>(</span>mlfp<span class='opr'>)</span> <span class='opr'>{</span>

<span class='kw4'>private</span> <span class='kw4'>enum</span> <span class='opr'>{</span>
  NAN_FLAG <span class='opr'>=</span> <span class='nbr'>0</span>x80000000,
  INFINITY_FLAG <span class='opr'>=</span> <span class='nbr'>0</span>x7fffffff,
  EXP <span class='opr'>=</span> <span class='nbr'>0</span>x7ff
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatDouble<span class='opr'>(</span><span class='kw4'>double</span> value, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, IFormatService formatService<span class='opr'>)</span> <span class='opr'>{</span>
  NumberFormat nf <span class='opr'>=</span> NumberFormat.getInstance<span class='opr'>(</span>formatService<span class='opr'>)</span>;
  <span class='kw4'>int</span> length;
  <span class='kw4'>char</span> specifier <span class='opr'>=</span> parseFormatSpecifier<span class='opr'>(</span>format, length<span class='opr'>)</span>;
  <span class='kw4'>int</span> precision <span class='opr'>=</span> <span class='nbr'>15</span>;

  <span class='kw1'>switch</span> <span class='opr'>(</span>specifier<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>case</span> <span class='str'>'r'</span>:
    <span class='kw1'>case</span> <span class='str'>'R'</span>:
      Number number <span class='opr'>=</span> Number<span class='opr'>(</span>value, <span class='nbr'>15</span><span class='opr'>)</span>;

      <span class='kw1'>if</span> <span class='opr'>(</span>number.scale <span class='opr'>=</span><span class='opr'>=</span> NAN_FLAG<span class='opr'>)</span>
        <span class='kw1'>return</span> nf.nanSymbol;
      <span class='kw1'>if</span> <span class='opr'>(</span>number.scale <span class='opr'>=</span><span class='opr'>=</span> INFINITY_FLAG<span class='opr'>)</span>
        <span class='kw1'>return</span> number.sign ? nf.negativeInfinitySymbol : nf.positiveInfinitySymbol;

      <span class='kw4'>double</span> d;
      number.toDouble<span class='opr'>(</span>d<span class='opr'>)</span>;
      <span class='kw1'>if</span> <span class='opr'>(</span>d <span class='opr'>=</span><span class='opr'>=</span> value<span class='opr'>)</span>
        <span class='kw1'>return</span> number.toString<span class='opr'>(</span><span class='str'>'G'</span>, <span class='nbr'>15</span>, nf<span class='opr'>)</span>;

      number <span class='opr'>=</span> Number<span class='opr'>(</span>value, <span class='nbr'>17</span><span class='opr'>)</span>;
      <span class='kw1'>return</span> number.toString<span class='opr'>(</span><span class='str'>'G'</span>, <span class='nbr'>17</span>, nf<span class='opr'>)</span>;
    <span class='kw1'>case</span> <span class='str'>'g'</span>:
    <span class='kw1'>case</span> <span class='str'>'G'</span>:
      <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&gt;</span> <span class='nbr'>15</span><span class='opr'>)</span>
        precision <span class='opr'>=</span> <span class='nbr'>17</span>;
      <span class='com'>// Fall through.</span>
    <span class='kw2'>default</span>:
      <span class='kw1'>break</span>;
  <span class='opr'>}</span>

  Number number <span class='opr'>=</span> Number<span class='opr'>(</span>value, precision<span class='opr'>)</span>;

  <span class='kw1'>if</span> <span class='opr'>(</span>number.scale <span class='opr'>=</span><span class='opr'>=</span> NAN_FLAG<span class='opr'>)</span>
    <span class='kw1'>return</span> nf.nanSymbol;
  <span class='kw1'>if</span> <span class='opr'>(</span>number.scale <span class='opr'>=</span><span class='opr'>=</span> INFINITY_FLAG<span class='opr'>)</span>
    <span class='kw1'>return</span> number.sign ? nf.negativeInfinitySymbol : nf.positiveInfinitySymbol;

  <span class='kw1'>if</span> <span class='opr'>(</span>specifier <span class='opr'>!=</span> <span class='kw4'>char</span>.init<span class='opr'>)</span>
    <span class='kw1'>return</span> number.toString<span class='opr'>(</span>specifier, length, nf<span class='opr'>)</span>;
  <span class='kw1'>return</span> number.toStringFormat<span class='opr'>(</span>format, nf<span class='opr'>)</span>;
<span class='opr'>}</span>

<span class='opr'>}</span> <span class='com'>// version (mlfp)</span>

<span class='kw4'>private</span> <span class='kw4'>void</span> formatGeneral<span class='opr'>(</span><span class='kw2'>inout</span> Number number, <span class='kw2'>inout</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> target, <span class='kw4'>int</span> length, <span class='kw4'>char</span> format, NumberFormat nf<span class='opr'>)</span> <span class='opr'>{</span>
  <span class='kw4'>int</span> pos <span class='opr'>=</span> number.scale;

  <span class='kw4'>char</span><span class='opr'>*</span> p <span class='opr'>=</span> number.digits;
  <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      target <span class='opr'>~=</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> ? <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> : <span class='str'>'0'</span>;
      pos<span class='opr'>-</span><span class='opr'>-</span>;
    <span class='opr'>}</span>
  <span class='opr'>}</span>
  <span class='kw1'>else</span>
    target <span class='opr'>~=</span> <span class='str'>'0'</span>;

  <span class='kw1'>if</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> <span class='opr'>{</span>
    target <span class='opr'>~=</span> nf.numberDecimalSeparator;
    <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      target <span class='opr'>~=</span> <span class='str'>'0'</span>;
      pos<span class='opr'>+</span><span class='opr'>+</span>;
    <span class='opr'>}</span>
    <span class='kw1'>while</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span>
      target <span class='opr'>~=</span> <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span>;
  <span class='opr'>}</span>
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>void</span> formatNumber<span class='opr'>(</span><span class='kw2'>inout</span> Number number, <span class='kw2'>inout</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> target, <span class='kw4'>int</span> length, NumberFormat nf<span class='opr'>)</span> <span class='opr'>{</span>
  <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format <span class='opr'>=</span> number.sign ? negativeNumberFormats<span class='opr'>[</span>nf.numberNegativePattern<span class='opr'>]</span> : positiveNumberFormat;

  <span class='com'>// Parse the format.</span>
  <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>char</span> c; format<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>switch</span> <span class='opr'>(</span>c<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>case</span> <span class='str'>'#'</span>:
        formatFixed<span class='opr'>(</span>number, target, length, nf.numberGroupSizes, nf.numberDecimalSeparator, nf.numberGroupSeparator<span class='opr'>)</span>;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'-'</span>:
        target <span class='opr'>~=</span> nf.negativeSign;
        <span class='kw1'>break</span>;
      <span class='kw2'>default</span>:
        target <span class='opr'>~=</span> c;
        <span class='kw1'>break</span>;
    <span class='opr'>}</span>
  <span class='opr'>}</span>
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>void</span> formatCurrency<span class='opr'>(</span><span class='kw2'>inout</span> Number number, <span class='kw2'>inout</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> target, <span class='kw4'>int</span> length, NumberFormat nf<span class='opr'>)</span> <span class='opr'>{</span>
  <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format <span class='opr'>=</span> number.sign ? negativeCurrencyFormats<span class='opr'>[</span>nf.currencyNegativePattern<span class='opr'>]</span> : positiveCurrencyFormats<span class='opr'>[</span>nf.currencyPositivePattern<span class='opr'>]</span>;

  <span class='com'>// Parse the format.</span>
  <span class='kw1'>foreach</span> <span class='opr'>(</span><span class='kw4'>char</span> c; format<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>switch</span> <span class='opr'>(</span>c<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>case</span> <span class='str'>'#'</span>:
        formatFixed<span class='opr'>(</span>number, target, length, nf.currencyGroupSizes, nf.currencyDecimalSeparator, nf.currencyGroupSeparator<span class='opr'>)</span>;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'-'</span>:
        target <span class='opr'>~=</span> nf.negativeSign;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'$'</span>:
        target <span class='opr'>~=</span> nf.currencySymbol;
        <span class='kw1'>break</span>;
      <span class='kw2'>default</span>:
        target <span class='opr'>~=</span> c;
        <span class='kw1'>break</span>;
    <span class='opr'>}</span>
  <span class='opr'>}</span>
<span class='opr'>}</span>

<span class='kw4'>private</span> <span class='kw4'>void</span> formatFixed<span class='opr'>(</span><span class='kw2'>inout</span> Number number, <span class='kw2'>inout</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> target, <span class='kw4'>int</span> length, <span class='kw4'>int</span><span class='opr'>[</span><span class='opr'>]</span> groupSizes, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> decimalSeparator, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> groupSeparator<span class='opr'>)</span> <span class='opr'>{</span>
  <span class='kw4'>int</span> pos <span class='opr'>=</span> number.scale;
  <span class='kw4'>char</span><span class='opr'>*</span> p <span class='opr'>=</span> number.digits;

  <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw1'>if</span> <span class='opr'>(</span>groupSizes.length <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='com'>// Calculate whether we have enough digits to format.</span>
      <span class='kw4'>int</span> count <span class='opr'>=</span> groupSizes<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;
      <span class='kw4'>int</span> index, size;
      <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&gt;</span> count<span class='opr'>)</span> <span class='opr'>{</span>
        size <span class='opr'>=</span> groupSizes<span class='opr'>[</span>index<span class='opr'>]</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>size <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
          <span class='kw1'>break</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>index <span class='opr'>&lt;</span> groupSizes.length <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span>
          index<span class='opr'>+</span><span class='opr'>+</span>;
        count <span class='opr'>+=</span> groupSizes<span class='opr'>[</span>index<span class='opr'>]</span>;
      <span class='opr'>}</span>
      size <span class='opr'>=</span> <span class='opr'>(</span>count <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='nbr'>0</span> : groupSizes<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;

      <span class='com'>// Insert the separator according to groupSizes.</span>
      <span class='kw4'>int</span> end <span class='opr'>=</span> charTerm<span class='opr'>(</span>p<span class='opr'>)</span>;
      <span class='kw4'>int</span> start <span class='opr'>=</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> end<span class='opr'>)</span> ? pos : end;
      <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> separator <span class='opr'>=</span> groupSeparator.reverse;
      index <span class='opr'>=</span> <span class='nbr'>0</span>;
      <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> temp;
      <span class='kw1'>for</span> <span class='opr'>(</span><span class='kw4'>int</span> c, i <span class='opr'>=</span> pos <span class='opr'>-</span><span class='nbr'>1</span>; i <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span>; i<span class='opr'>-</span><span class='opr'>-</span><span class='opr'>)</span> <span class='opr'>{</span>
        temp <span class='opr'>~=</span> <span class='opr'>(</span>i <span class='opr'>&lt;</span> start<span class='opr'>)</span> ? number.digits<span class='opr'>[</span>i<span class='opr'>]</span> : <span class='str'>'0'</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>size <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
          c<span class='opr'>+</span><span class='opr'>+</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> size &amp;&amp; i <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
            temp <span class='opr'>~=</span> separator;
            <span class='kw1'>if</span> <span class='opr'>(</span>index <span class='opr'>&lt;</span> groupSizes.length <span class='opr'>-</span> <span class='nbr'>1</span><span class='opr'>)</span>
              size <span class='opr'>=</span> groupSizes<span class='opr'>[</span><span class='opr'>+</span><span class='opr'>+</span>index<span class='opr'>]</span>;
            c <span class='opr'>=</span> <span class='nbr'>0</span>;
          <span class='opr'>}</span>
        <span class='opr'>}</span>
      <span class='opr'>}</span>
      <span class='com'>// We built the string backwards, so reverse it.</span>
      target <span class='opr'>~=</span> temp.reverse;
      p <span class='opr'>+=</span> start;
    <span class='opr'>}</span>
    <span class='kw1'>else</span> <span class='opr'>{</span>
      <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
        target <span class='opr'>~=</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> ? <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> : <span class='str'>'0'</span>;
        pos<span class='opr'>-</span><span class='opr'>-</span>;
      <span class='opr'>}</span>
    <span class='opr'>}</span>
  <span class='opr'>}</span>
  <span class='kw1'>else</span>
    <span class='com'>// Negative scale.</span>
    target <span class='opr'>~=</span> <span class='str'>'0'</span>;

  <span class='kw1'>if</span> <span class='opr'>(</span>length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
    target <span class='opr'>~=</span> decimalSeparator;
    <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> <span class='nbr'>0</span> &amp;&amp; length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      target <span class='opr'>~=</span> <span class='str'>'0'</span>;
      pos<span class='opr'>+</span><span class='opr'>+</span>;
      length<span class='opr'>-</span><span class='opr'>-</span>;
    <span class='opr'>}</span>
    <span class='kw1'>while</span> <span class='opr'>(</span>length <span class='opr'>&gt;</span> <span class='nbr'>0</span><span class='opr'>)</span> <span class='opr'>{</span>
      target <span class='opr'>~=</span> <span class='opr'>(</span><span class='opr'>*</span>p <span class='opr'>!=</span> <span class='str'>'\0'</span><span class='opr'>)</span> ? <span class='opr'>*</span>p<span class='opr'>+</span><span class='opr'>+</span> : <span class='str'>'0'</span>;
      length<span class='opr'>-</span><span class='opr'>-</span>;
    <span class='opr'>}</span>
  <span class='opr'>}</span>
<span class='opr'>}</span>

<span class='com'>// DateTime</span>

<span class='kw4'>package</span> <span class='kw4'>const</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> allStandardFormats <span class='opr'>=</span> <span class='opr'>[</span> <span class='str'>'d'</span>, <span class='str'>'D'</span>, <span class='str'>'f'</span>, <span class='str'>'F'</span>, <span class='str'>'g'</span>, <span class='str'>'G'</span>, <span class='str'>'m'</span>, <span class='str'>'M'</span>, <span class='str'>'r'</span>, <span class='str'>'R'</span>, <span class='str'>'s'</span>, <span class='str'>'t'</span>, <span class='str'>'T'</span>, <span class='str'>'u'</span>, <span class='str'>'U'</span>, <span class='str'>'y'</span>, <span class='str'>'Y'</span> <span class='opr'>]</span>;

<span class='kw4'>package</span> <span class='kw4'>static</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatDateTime<span class='opr'>(</span>DateTime dateTime, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, DateTimeFormat dtf<span class='opr'>)</span> <span class='opr'>{</span>

  <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> expandKnownFormat<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, <span class='kw2'>inout</span> DateTime dateTime<span class='opr'>)</span> <span class='opr'>{</span>
    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> f;
    <span class='kw1'>switch</span> <span class='opr'>(</span>format<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span><span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>case</span> <span class='str'>'d'</span>:
        f <span class='opr'>=</span> dtf.shortDatePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'D'</span>:
        f <span class='opr'>=</span> dtf.longDatePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'f'</span>:
        f <span class='opr'>=</span> dtf.longDatePattern <span class='opr'>~</span> <span class='str'>&quot; &quot;</span> <span class='opr'>~</span> dtf.shortTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'F'</span>:
        f <span class='opr'>=</span> dtf.fullDateTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'g'</span>:
        f <span class='opr'>=</span> dtf.generalShortTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'G'</span>:
        f <span class='opr'>=</span> dtf.generalLongTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'m'</span>:
      <span class='kw1'>case</span> <span class='str'>'M'</span>:
        f <span class='opr'>=</span> dtf.monthDayPattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'r'</span>:
      <span class='kw1'>case</span> <span class='str'>'R'</span>:
        f <span class='opr'>=</span> dtf.rfc1123Pattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'s'</span>:
        f <span class='opr'>=</span> dtf.sortableDateTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'t'</span>:
        f <span class='opr'>=</span> dtf.shortTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'T'</span>:
        f <span class='opr'>=</span> dtf.longTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'u'</span>:
        dateTime <span class='opr'>=</span> dateTime.toUniversalTime<span class='opr'>(</span><span class='opr'>)</span>;
        dtf <span class='opr'>=</span> DateTimeFormat.invariantFormat;
        f <span class='opr'>=</span> dtf.universalSortableDateTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'U'</span>:
        dtf <span class='opr'>=</span> <span class='kw2'>cast</span><span class='opr'>(</span>DateTimeFormat<span class='opr'>)</span>dtf.clone<span class='opr'>(</span><span class='opr'>)</span>;
        dateTime <span class='opr'>=</span> dateTime.toUniversalTime<span class='opr'>(</span><span class='opr'>)</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span><span class='kw2'>typeid</span><span class='opr'>(</span><span class='kw2'>typeof</span><span class='opr'>(</span>dtf.calendar<span class='opr'>)</span><span class='opr'>)</span> !<span class='kw2'>is</span> <span class='kw2'>typeid</span><span class='opr'>(</span>GregorianCalendar<span class='opr'>)</span><span class='opr'>)</span>
          dtf.calendar <span class='opr'>=</span> GregorianCalendar.getDefaultInstance<span class='opr'>(</span><span class='opr'>)</span>;
        f <span class='opr'>=</span> dtf.fullDateTimePattern;
        <span class='kw1'>break</span>;
      <span class='kw1'>case</span> <span class='str'>'y'</span>:
      <span class='kw1'>case</span> <span class='str'>'Y'</span>:
        f <span class='opr'>=</span> dtf.yearMonthPattern;
        <span class='kw1'>break</span>;
      <span class='kw2'>default</span>:
        <span class='kw2'>throw</span> <span class='kw2'>new</span> Exception<span class='opr'>(</span><span class='str'>&quot;Invalid date format.&quot;</span><span class='opr'>)</span>;
    <span class='opr'>}</span>
    <span class='kw1'>return</span> f;
  <span class='opr'>}</span>

  <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatCustom<span class='opr'>(</span>DateTime dateTime, <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format<span class='opr'>)</span> <span class='opr'>{</span>

    <span class='kw4'>int</span> parseRepeat<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, <span class='kw4'>int</span> pos, <span class='kw4'>char</span> c<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>int</span> n <span class='opr'>=</span> pos <span class='opr'>+</span> <span class='nbr'>1</span>;
      <span class='kw1'>while</span> <span class='opr'>(</span>n <span class='opr'>&lt;</span> format.length &amp;&amp; format<span class='opr'>[</span>n<span class='opr'>]</span> <span class='opr'>=</span><span class='opr'>=</span> c<span class='opr'>)</span>
        n<span class='opr'>+</span><span class='opr'>+</span>;
      <span class='kw1'>return</span> n <span class='opr'>-</span> pos;
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatDayOfWeek<span class='opr'>(</span>DayOfWeek dayOfWeek, <span class='kw4'>int</span> rpt<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>rpt <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>3</span><span class='opr'>)</span>
        <span class='kw1'>return</span> dtf.getAbbreviatedDayName<span class='opr'>(</span>dayOfWeek<span class='opr'>)</span>;
      <span class='kw1'>return</span> dtf.getDayName<span class='opr'>(</span>dayOfWeek<span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> formatMonth<span class='opr'>(</span><span class='kw4'>int</span> month, <span class='kw4'>int</span> rpt<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw1'>if</span> <span class='opr'>(</span>rpt <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>3</span><span class='opr'>)</span>
        <span class='kw1'>return</span> dtf.getAbbreviatedMonthName<span class='opr'>(</span>month<span class='opr'>)</span>;
      <span class='kw1'>return</span> dtf.getMonthName<span class='opr'>(</span>month<span class='opr'>)</span>;
    <span class='opr'>}</span>

    <span class='kw4'>int</span> parseQuote<span class='opr'>(</span><span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> format, <span class='kw4'>int</span> pos, <span class='kw2'>out</span> <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> result<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>int</span> start <span class='opr'>=</span> pos;
      <span class='kw4'>char</span> chQuote <span class='opr'>=</span> format<span class='opr'>[</span>pos<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
      <span class='kw4'>bool</span> found;
      <span class='kw1'>while</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw4'>char</span> c <span class='opr'>=</span> format<span class='opr'>[</span>pos<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
        <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> chQuote<span class='opr'>)</span> <span class='opr'>{</span>
          found <span class='opr'>=</span> <span class='kw2'>true</span>;
          <span class='kw1'>break</span>;
        <span class='opr'>}</span>
        <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>c <span class='opr'>=</span><span class='opr'>=</span> <span class='str'>'\&#039;</span><span class='opr'>)</span> <span class='opr'>{</span> <span class='com'>// escaped</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>pos <span class='opr'>&lt;</span> format.length<span class='opr'>)</span>
            result <span class='opr'>~=</span> format<span class='opr'>[</span>pos<span class='opr'>+</span><span class='opr'>+</span><span class='opr'>]</span>;
        <span class='opr'>}</span>
        <span class='kw1'>else</span>
          result <span class='opr'>~=</span> c;
      <span class='opr'>}</span>
      <span class='kw1'>return</span> pos <span class='opr'>-</span> start;
    <span class='opr'>}</span>

    Calendar calendar <span class='opr'>=</span> dtf.calendar;
    <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> result;
    <span class='kw4'>bool</span> justTime <span class='opr'>=</span> <span class='kw2'>true</span>;
    <span class='kw4'>int</span> index, len;

    <span class='kw1'>while</span> <span class='opr'>(</span>index <span class='opr'>&lt;</span> format.length<span class='opr'>)</span> <span class='opr'>{</span>
      <span class='kw4'>char</span> c <span class='opr'>=</span> format<span class='opr'>[</span>index<span class='opr'>]</span>;

      <span class='kw1'>switch</span> <span class='opr'>(</span>c<span class='opr'>)</span> <span class='opr'>{</span>
        <span class='kw1'>case</span> <span class='str'>'d'</span>: <span class='com'>// day</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>len <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>2</span><span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw4'>int</span> day <span class='opr'>=</span> calendar.getDayOfMonth<span class='opr'>(</span>dateTime<span class='opr'>)</span>;
            result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, day<span class='opr'>)</span>;<span class='com'>//Integer.format(day, Formatter.format(&quot;D{0}&quot;, len));</span>
          <span class='opr'>}</span>
          <span class='kw1'>else</span>
            result <span class='opr'>~=</span> formatDayOfWeek<span class='opr'>(</span>calendar.getDayOfWeek<span class='opr'>(</span>dateTime<span class='opr'>)</span>, len<span class='opr'>)</span>;
          justTime <span class='opr'>=</span> <span class='kw2'>false</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'M'</span>: <span class='com'>// month</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='kw4'>int</span> month <span class='opr'>=</span> calendar.getMonth<span class='opr'>(</span>dateTime<span class='opr'>)</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>len <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>2</span><span class='opr'>)</span>
            result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, month<span class='opr'>)</span>;<span class='com'>//Integer.format(month, Formatter.format(&quot;D{0}&quot;, len));</span>
          <span class='kw1'>else</span>
            result <span class='opr'>~=</span> formatMonth<span class='opr'>(</span>month, len<span class='opr'>)</span>;
          justTime <span class='opr'>=</span> <span class='kw2'>false</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'y'</span>: <span class='com'>// year</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='kw4'>int</span> year <span class='opr'>=</span> calendar.getYear<span class='opr'>(</span>dateTime<span class='opr'>)</span>;
          <span class='com'>// Two-digit years for JapaneseCalendar</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>calendar.id <span class='opr'>=</span><span class='opr'>=</span> Calendar.JAPAN<span class='opr'>)</span>
            result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:D2}&quot;</span>, year<span class='opr'>)</span>;<span class='com'>//Integer.format(year, Formatter.format(&quot;D2&quot;));</span>
          <span class='kw1'>else</span> <span class='opr'>{</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>len <span class='opr'>&lt;</span><span class='opr'>=</span> <span class='nbr'>2</span><span class='opr'>)</span>
              result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, year <span class='opr'>%</span> <span class='nbr'>100</span><span class='opr'>)</span>;<span class='com'>//Integer.format(year % 100, Formatter.format(&quot;D{0}&quot;, len));</span>
            <span class='kw1'>else</span>
              result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, year<span class='opr'>)</span>;<span class='com'>//Integer.format(year, Formatter.format(&quot;D{0}&quot;, len));</span>
          <span class='opr'>}</span>
          justTime <span class='opr'>=</span> <span class='kw2'>false</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'h'</span>: <span class='com'>// hour (12-hour clock)</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='kw4'>int</span> hour <span class='opr'>=</span> dateTime.hour <span class='opr'>%</span> <span class='nbr'>12</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>hour <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span>
            hour <span class='opr'>=</span> <span class='nbr'>12</span>;
          <span class='com'>//result ~= Integer.format(hour, Formatter.format(&quot;D{0}&quot;, len));</span>
          result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, hour<span class='opr'>)</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'H'</span>: <span class='com'>// hour (24-hour clock)</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='com'>//result ~= Integer.format(dateTime.hour, Formatter.format(&quot;D{0}&quot;, len));</span>
          result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, dateTime.hour<span class='opr'>)</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'m'</span>: <span class='com'>// minute</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='com'>//result ~= Integer.format(dateTime.minute, Formatter.format(&quot;D{0}&quot;, len));</span>
          result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, dateTime.minute<span class='opr'>)</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'s'</span>: <span class='com'>// second</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='com'>//result ~= Integer.format(dateTime.second, Formatter.format(&quot;D{0}&quot;, len));</span>
          result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;{0:&quot;</span> <span class='opr'>~</span> Formatter.format<span class='opr'>(</span><span class='str'>&quot;D{0}&quot;</span>, len<span class='opr'>)</span> <span class='opr'>~</span> <span class='str'>&quot;}&quot;</span>, dateTime.second<span class='opr'>)</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'t'</span>: <span class='com'>// AM/PM</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          <span class='kw1'>if</span> <span class='opr'>(</span>len <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='opr'>{</span>
            <span class='kw1'>if</span> <span class='opr'>(</span>dateTime.hour <span class='opr'>&lt;</span> <span class='nbr'>12</span><span class='opr'>)</span> <span class='opr'>{</span>
              <span class='kw1'>if</span> <span class='opr'>(</span>dtf.amDesignator.length <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                result <span class='opr'>~=</span> dtf.amDesignator<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;
            <span class='opr'>}</span>
            <span class='kw1'>else</span> <span class='opr'>{</span>
              <span class='kw1'>if</span> <span class='opr'>(</span>dtf.pmDesignator.length <span class='opr'>!=</span> <span class='nbr'>0</span><span class='opr'>)</span>
                result <span class='opr'>~=</span> dtf.pmDesignator<span class='opr'>[</span><span class='nbr'>0</span><span class='opr'>]</span>;
            <span class='opr'>}</span>
          <span class='opr'>}</span>
          <span class='kw1'>else</span>
            result <span class='opr'>~=</span> <span class='opr'>(</span>dateTime.hour <span class='opr'>&lt;</span> <span class='nbr'>12</span><span class='opr'>)</span> ? dtf.amDesignator : dtf.pmDesignator;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'z'</span>: <span class='com'>// timezone offset</span>
          len <span class='opr'>=</span> parseRepeat<span class='opr'>(</span>format, index, c<span class='opr'>)</span>;
          TimeSpan offset <span class='opr'>=</span> <span class='opr'>(</span>justTime &amp;&amp; dateTime.ticks <span class='opr'>&lt;</span> TICKS_PER_DAY<span class='opr'>)</span> ? TimeZone.current.getUtcOffset<span class='opr'>(</span>DateTime.now<span class='opr'>)</span> : TimeZone.current.getUtcOffset<span class='opr'>(</span>dateTime<span class='opr'>)</span>;
          <span class='kw4'>int</span> hours <span class='opr'>=</span> offset.hours;
          <span class='kw4'>int</span> minutes <span class='opr'>=</span> offset.minutes;
          <span class='com'>/*if (len == 1)
            result ~= Integer.format(hours, (hours &gt;= 0) ? &quot;+0&quot; : &quot;-0&quot;, Culture.invariantCulture);
          else if (len == 2)
            result ~= Integer.format(hours, (hours &gt;= 0) ? &quot;+00&quot; : &quot;-00&quot;, Culture.invariantCulture);
          else*/</span>
          <span class='kw1'>if</span> <span class='opr'>(</span>len <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>1</span><span class='opr'>)</span>
            result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span>Culture.invariantCulture, <span class='opr'>(</span>hours <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='str'>&quot;+{0:0}&quot;</span> : <span class='str'>&quot;-{0:0}&quot;</span>, hours<span class='opr'>)</span>;
          <span class='kw1'>else</span> <span class='kw1'>if</span> <span class='opr'>(</span>len <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>2</span><span class='opr'>)</span>
            result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span>Culture.invariantCulture, <span class='opr'>(</span>hours <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='str'>&quot;+{0:00}&quot;</span> : <span class='str'>&quot;-{0:00}&quot;</span>, hours<span class='opr'>)</span>;
          <span class='kw1'>else</span>
            result <span class='opr'>~=</span> Formatter.format<span class='opr'>(</span>Culture.invariantCulture, <span class='opr'>(</span>hours <span class='opr'>&gt;</span><span class='opr'>=</span> <span class='nbr'>0</span><span class='opr'>)</span> ? <span class='str'>&quot;+{0:00}:{1:00}&quot;</span> : <span class='str'>&quot;-{0:00}:{1:00}&quot;</span>, hours, minutes<span class='opr'>)</span>;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>':'</span>: <span class='com'>// time separator</span>
          len <span class='opr'>=</span> <span class='nbr'>1</span>;
          result <span class='opr'>~=</span> dtf.timeSeparator;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'/'</span>: <span class='com'>// date separator</span>
          len <span class='opr'>=</span> <span class='nbr'>1</span>;
          result <span class='opr'>~=</span> dtf.dateSeparator;
          <span class='kw1'>break</span>;
        <span class='kw1'>case</span> <span class='str'>'\&quot;'</span>: <span class='com'>// string literal</span>
        <span class='kw1'>case</span> <span class='str'>'&#039;'</span>: <span class='com'>// char literal</span>
          <span class='kw4'>char</span><span class='opr'>[</span><span class='opr'>]</span> quote;
          len <span class='opr'>=</span> parseQuote<span class='opr'>(</span>format, index, quote<span class='opr'>)</span>;
          result <span class='opr'>~=</span> quote;
          <span class='kw1'>break</span>;
        <span class='kw2'>default</span>:
          len <span class='opr'>=</span> <span class='nbr'>1</span>;
          result <span class='opr'>~=</span> c;
          <span class='kw1'>break</span>;
      <span class='opr'>}</span>
      index <span class='opr'>+=</span> len;
    <span class='opr'>}</span>
    <span class='kw1'>return</span> result;
  <span class='opr'>}</span>

  <span class='kw1'>if</span> <span class='opr'>(</span>format <span class='opr'>=</span><span class='opr'>=</span> <span class='kw2'>null</span><span class='opr'>)</span>
    format <span class='opr'>=</span> <span class='str'>&quot;G&quot;</span>; <span class='com'>// Default to general format.</span>

  <span class='kw1'>if</span> <span class='opr'>(</span>format.length <span class='opr'>=</span><span class='opr'>=</span> <span class='nbr'>1</span><span class='opr'>)</span> <span class='com'>// It might be one of our shortcuts.</span>
    format <span class='opr'>=</span> expandKnownFormat<span class='opr'>(</span>format, dateTime<span class='opr'>)</span>;

  <span class='kw1'>return</span> formatCustom<span class='opr'>(</span>dateTime, format<span class='opr'>)</span>;
<span class='opr'>}</span>
</pre></td></tr></table>	</body>
</html>
